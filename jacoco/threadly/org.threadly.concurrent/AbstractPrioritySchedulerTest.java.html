<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractPrioritySchedulerTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">threadly$All_in_threadly_test.exec</a> &gt; <a href="index.source.html" class="el_package">org.threadly.concurrent</a> &gt; <span class="el_source">AbstractPrioritySchedulerTest.java</span></div><h1>AbstractPrioritySchedulerTest.java</h1><pre class="source lang-java linenums">package org.threadly.concurrent;

import static org.junit.Assert.*;

import java.util.concurrent.ExecutionException;
import java.util.concurrent.atomic.AtomicBoolean;

import org.junit.Test;
import org.threadly.concurrent.AbstractPriorityScheduler.OneTimeTaskWrapper;
import org.threadly.test.concurrent.TestRunnable;
import org.threadly.test.concurrent.TestUtils;
import org.threadly.util.Clock;

@SuppressWarnings(&quot;javadoc&quot;)
<span class="fc" id="L15">public abstract class AbstractPrioritySchedulerTest extends SchedulerServiceInterfaceTest {</span>
  @Override
  protected SchedulerServiceFactory getSchedulerServiceFactory() {
<span class="fc" id="L18">    return getAbstractPrioritySchedulerFactory();</span>
  }
  
  protected abstract AbstractPrioritySchedulerFactory getAbstractPrioritySchedulerFactory();
  
  @Test
  public void getDefaultPriorityTest() {
<span class="fc" id="L25">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
<span class="fc" id="L26">    TaskPriority priority = TaskPriority.High;</span>
    try {
<span class="fc" id="L28">      AbstractPriorityScheduler scheduler = factory.makeAbstractPriorityScheduler(1, priority, 1000);</span>
      
<span class="fc" id="L30">      assertEquals(priority, scheduler.getDefaultPriority());</span>
      
<span class="fc" id="L32">      priority = TaskPriority.Low;</span>
<span class="fc" id="L33">      scheduler = factory.makeAbstractPriorityScheduler(1, priority, 1000);</span>
<span class="fc" id="L34">      assertEquals(priority, scheduler.getDefaultPriority());</span>
      
<span class="fc" id="L36">      priority = TaskPriority.Starvable;</span>
<span class="fc" id="L37">      scheduler = factory.makeAbstractPriorityScheduler(1, priority, 1000);</span>
<span class="fc" id="L38">      assertEquals(priority, scheduler.getDefaultPriority());</span>
    } finally {
<span class="fc" id="L40">      factory.shutdown();</span>
    }
<span class="fc" id="L42">  }</span>
  
  @Test
  public void constructorNullPriorityTest() {
<span class="fc" id="L46">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L48">      AbstractPriorityScheduler executor = factory.makeAbstractPriorityScheduler(1, null, 1);</span>
      
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">      assertTrue(executor.getDefaultPriority() == AbstractPriorityScheduler.DEFAULT_PRIORITY);</span>
    } finally {
<span class="fc" id="L52">      factory.shutdown();</span>
    }
<span class="fc" id="L54">  }</span>
  
  @Test
  public void getAndSetLowPriorityWaitTest() {
<span class="fc" id="L58">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
<span class="fc" id="L59">    long lowPriorityWait = 1000;</span>
<span class="fc" id="L60">    AbstractPriorityScheduler scheduler = factory.makeAbstractPriorityScheduler(1, TaskPriority.High, lowPriorityWait);</span>
    try {
<span class="fc" id="L62">      assertEquals(lowPriorityWait, scheduler.getMaxWaitForLowPriority());</span>
      
<span class="fc" id="L64">      lowPriorityWait = Long.MAX_VALUE;</span>
<span class="fc" id="L65">      scheduler.setMaxWaitForLowPriority(lowPriorityWait);</span>
      
<span class="fc" id="L67">      assertEquals(lowPriorityWait, scheduler.getMaxWaitForLowPriority());</span>
    } finally {
<span class="fc" id="L69">      factory.shutdown();</span>
    }
<span class="fc" id="L71">  }</span>
  
  @Test
  public void setLowPriorityWaitFail() {
<span class="fc" id="L75">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
<span class="fc" id="L76">    long lowPriorityWait = 1000;</span>
<span class="fc" id="L77">    AbstractPriorityScheduler scheduler = factory.makeAbstractPriorityScheduler(1, TaskPriority.High, lowPriorityWait);</span>
    try {
      try {
<span class="nc" id="L80">        scheduler.setMaxWaitForLowPriority(-1);</span>
<span class="nc" id="L81">        fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L82">      } catch (IllegalArgumentException e) {</span>
        // expected
<span class="nc" id="L84">      }</span>
      
<span class="fc" id="L86">      assertEquals(lowPriorityWait, scheduler.getMaxWaitForLowPriority());</span>
    } finally {
<span class="fc" id="L88">      factory.shutdown();</span>
    }
<span class="fc" id="L90">  }</span>

  @Test
  public void getPriorityQueuedTaskCountTest() {
<span class="fc" id="L94">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L96">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L98">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L99">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L100">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L101">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L102">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L103">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L104">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L105">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L106">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L107">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L108">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L109">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L111">      assertEquals(4, result.getQueuedTaskCount());</span>

<span class="fc" id="L113">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L114">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L115">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L116">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L117">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L118">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L119">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L120">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L121">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L122">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L123">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L124">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L126">      assertEquals(8, result.getQueuedTaskCount());</span>
<span class="fc" id="L127">      assertEquals(8, result.getQueuedTaskCount(null));</span>
<span class="fc" id="L128">      assertEquals(4, result.getQueuedTaskCount(TaskPriority.High));</span>
<span class="fc" id="L129">      assertEquals(4, result.getQueuedTaskCount(TaskPriority.Low));</span>
    } finally {
<span class="fc" id="L131">      factory.shutdown();</span>
    }
<span class="fc" id="L133">  }</span>
  
  @Test
  public void getQueuedTaskCountStarvablePriorityTest() {
<span class="fc" id="L137">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L139">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L141">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L142">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L143">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L144">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L145">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L146">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L147">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L148">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L149">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L150">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L151">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L152">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L154">      assertEquals(0, result.getQueuedTaskCount(TaskPriority.Starvable));</span>

<span class="fc" id="L156">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L157">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L158">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L159">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L160">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L161">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L162">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L163">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L164">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L165">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L166">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L167">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L169">      assertEquals(4, result.getQueuedTaskCount(TaskPriority.Starvable));</span>
    } finally {
<span class="fc" id="L171">      factory.shutdown();</span>
    }
<span class="fc" id="L173">  }</span>
  
  @Test
  public void getQueuedTaskCountLowPriorityTest() {
<span class="fc" id="L177">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L179">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L181">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L182">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L183">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L184">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L185">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L186">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L187">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L188">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L189">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L190">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L191">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L192">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L194">      assertEquals(0, result.getQueuedTaskCount(TaskPriority.Low));</span>

<span class="fc" id="L196">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L197">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L198">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L199">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L200">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L201">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L202">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L203">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L204">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L205">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L206">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L207">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L209">      assertEquals(4, result.getQueuedTaskCount(TaskPriority.Low));</span>
    } finally {
<span class="fc" id="L211">      factory.shutdown();</span>
    }
<span class="fc" id="L213">  }</span>
  
  @Test
  public void getQueuedTaskCountHighPriorityTest() {
<span class="fc" id="L217">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L219">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L221">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L222">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L223">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L224">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L225">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L226">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L227">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L228">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L229">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L230">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L231">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L232">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L234">      assertEquals(4, result.getQueuedTaskCount(TaskPriority.High));</span>

<span class="fc" id="L236">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L237">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L238">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L239">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L240">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L241">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L242">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L243">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L244">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L245">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L246">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L247">                                                         Clock.lastKnownForwardProgressingMillis() + 1000));</span>
      
<span class="fc" id="L249">      assertEquals(4, result.getQueuedTaskCount(TaskPriority.High));</span>
    } finally {
<span class="fc" id="L251">      factory.shutdown();</span>
    }
<span class="fc" id="L253">  }</span>

  @Test
  public void getPriorityWaitingForExecutionTaskCountTest() {
<span class="fc" id="L257">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L259">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L261">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L262">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L263">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L264">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L265">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L266">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L267">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L268">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L269">                                                         Clock.lastKnownForwardProgressingMillis() + 60_000));</span>
      
<span class="fc" id="L271">      assertEquals(2, result.getWaitingForExecutionTaskCount());</span>

<span class="fc" id="L273">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L274">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L275">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L276">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L277">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L278">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L279">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L280">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L281">                                                         Clock.lastKnownForwardProgressingMillis() + 60_000));</span>
      
<span class="fc" id="L283">      assertEquals(4, result.getWaitingForExecutionTaskCount());</span>
<span class="fc" id="L284">      assertEquals(4, result.getWaitingForExecutionTaskCount(null));</span>
<span class="fc" id="L285">      assertEquals(2, result.getWaitingForExecutionTaskCount(TaskPriority.High));</span>
<span class="fc" id="L286">      assertEquals(2, result.getWaitingForExecutionTaskCount(TaskPriority.Low));</span>
    } finally {
<span class="fc" id="L288">      factory.shutdown();</span>
    }
<span class="fc" id="L290">  }</span>
  
  @Test
  public void getWaitingForExecutionTaskCountLowPriorityTest() {
<span class="fc" id="L294">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L296">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L298">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L299">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L300">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L301">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L302">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L303">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L304">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L305">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L306">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L307">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L308">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L309">                                                         Clock.lastKnownForwardProgressingMillis() + 10_000));</span>
      
<span class="fc" id="L311">      assertEquals(0, result.getWaitingForExecutionTaskCount(TaskPriority.Low));</span>

<span class="fc" id="L313">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L314">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L315">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L316">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L317">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L318">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L319">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L320">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L321">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L322">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L323">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L324">                                                         Clock.lastKnownForwardProgressingMillis() + 10_000));</span>
      
<span class="fc" id="L326">      assertEquals(3, result.getWaitingForExecutionTaskCount(TaskPriority.Low));</span>
    } finally {
<span class="fc" id="L328">      factory.shutdown();</span>
    }
<span class="fc" id="L330">  }</span>
  
  @Test
  public void getWaitingForExecutionTaskCountHighPriorityTest() {
<span class="fc" id="L334">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L336">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L338">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L339">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L340">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L341">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L342">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L343">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L344">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L345">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L346">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L347">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L348">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L349">                                                         Clock.lastKnownForwardProgressingMillis() + 10_000));</span>
      
<span class="fc" id="L351">      assertEquals(3, result.getWaitingForExecutionTaskCount(TaskPriority.High));</span>

<span class="fc" id="L353">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L354">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L355">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L356">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L357">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L358">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L359">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L360">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L361">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L362">      result.getQueueManager().getQueueSet(TaskPriority.Low)</span>
<span class="fc" id="L363">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L364">                                                         Clock.lastKnownForwardProgressingMillis() + 10_000));</span>
      
<span class="fc" id="L366">      assertEquals(3, result.getWaitingForExecutionTaskCount(TaskPriority.High));</span>
    } finally {
<span class="fc" id="L368">      factory.shutdown();</span>
    }
<span class="fc" id="L370">  }</span>
  
  @Test
  public void getWaitingForExecutionTaskCountStarvablePriorityTest() {
<span class="fc" id="L374">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L376">      AbstractPriorityScheduler result = factory.makeAbstractPriorityScheduler(1);</span>
      // add directly to avoid starting the consumer
<span class="fc" id="L378">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L379">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L380">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L381">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L382">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L383">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L384">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L385">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L386">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L387">      result.getQueueManager().getQueueSet(TaskPriority.High)</span>
<span class="fc" id="L388">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L389">                                                         Clock.lastKnownForwardProgressingMillis() + 10_000));</span>
      
<span class="fc" id="L391">      assertEquals(0, result.getWaitingForExecutionTaskCount(TaskPriority.Starvable));</span>

<span class="fc" id="L393">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L394">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L395">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L396">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L397">            .executeQueue.add(new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L398">                                                     Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L399">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L400">            .scheduleQueue.add(0, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L401">                                                         Clock.lastKnownForwardProgressingMillis()));</span>
<span class="fc" id="L402">      result.getQueueManager().getQueueSet(TaskPriority.Starvable)</span>
<span class="fc" id="L403">            .scheduleQueue.add(1, new OneTimeTaskWrapper(DoNothingRunnable.instance(), null, </span>
<span class="fc" id="L404">                                                         Clock.lastKnownForwardProgressingMillis() + 10_000));</span>
      
<span class="fc" id="L406">      assertEquals(3, result.getWaitingForExecutionTaskCount(TaskPriority.Starvable));</span>
    } finally {
<span class="fc" id="L408">      factory.shutdown();</span>
    }
<span class="fc" id="L410">  }</span>
  
  @Test
  @Override
  public void executeTest() {
<span class="fc" id="L415">    AbstractPrioritySchedulerFactory priorityFactory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L417">      super.executeTest();</span>

<span class="fc" id="L419">      PrioritySchedulerService scheduler = priorityFactory.makeAbstractPriorityScheduler(2);</span>
      
<span class="fc" id="L421">      TestRunnable tr1 = new TestRunnable();</span>
<span class="fc" id="L422">      TestRunnable tr2 = new TestRunnable();</span>
<span class="fc" id="L423">      TestRunnable tr3 = new TestRunnable();</span>
<span class="fc" id="L424">      scheduler.execute(tr1, TaskPriority.High);</span>
<span class="fc" id="L425">      scheduler.execute(tr2, TaskPriority.Low);</span>
<span class="fc" id="L426">      scheduler.execute(tr3, TaskPriority.Starvable);</span>
<span class="fc" id="L427">      scheduler.execute(tr1, TaskPriority.High);</span>
<span class="fc" id="L428">      scheduler.execute(tr2, TaskPriority.Low);</span>
<span class="fc" id="L429">      scheduler.execute(tr3, TaskPriority.Starvable);</span>
      
<span class="fc" id="L431">      tr1.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
<span class="fc" id="L432">      tr2.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
<span class="fc" id="L433">      tr3.blockTillFinished(1000 * 1, 2); // throws exception if fails</span>
    } finally {
<span class="fc" id="L435">      priorityFactory.shutdown();</span>
    }
<span class="fc" id="L437">  }</span>
  
  @Override
  @Test
  public void submitRunnableTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L442">    AbstractPrioritySchedulerFactory priorityFactory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L444">      super.submitRunnableTest();</span>
      
<span class="fc" id="L446">      PrioritySchedulerService scheduler = priorityFactory.makeAbstractPriorityScheduler(2);</span>

<span class="fc" id="L448">      TestRunnable tr1 = new TestRunnable();</span>
<span class="fc" id="L449">      TestRunnable tr2 = new TestRunnable();</span>
<span class="fc" id="L450">      TestRunnable tr3 = new TestRunnable();</span>
<span class="fc" id="L451">      scheduler.submit(tr1, TaskPriority.High);</span>
<span class="fc" id="L452">      scheduler.submit(tr2, TaskPriority.Low);</span>
<span class="fc" id="L453">      scheduler.submit(tr3, TaskPriority.Starvable);</span>
<span class="fc" id="L454">      scheduler.submit(tr1, TaskPriority.High);</span>
<span class="fc" id="L455">      scheduler.submit(tr2, TaskPriority.Low);</span>
<span class="fc" id="L456">      scheduler.submit(tr3, TaskPriority.Starvable);</span>
      
<span class="fc" id="L458">      tr1.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
<span class="fc" id="L459">      tr2.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
<span class="fc" id="L460">      tr3.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
    } finally {
<span class="fc" id="L462">      priorityFactory.shutdown();</span>
    }
<span class="fc" id="L464">  }</span>
  
  @Test
  @Override
  public void submitRunnableWithResultTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L469">    AbstractPrioritySchedulerFactory priorityFactory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L471">      super.submitRunnableWithResultTest();</span>

<span class="fc" id="L473">      PrioritySchedulerService scheduler = priorityFactory.makeAbstractPriorityScheduler(2);</span>
      
<span class="fc" id="L475">      TestRunnable tr1 = new TestRunnable();</span>
<span class="fc" id="L476">      TestRunnable tr2 = new TestRunnable();</span>
<span class="fc" id="L477">      TestRunnable tr3 = new TestRunnable();</span>
<span class="fc" id="L478">      scheduler.submit(tr1, tr1, TaskPriority.High);</span>
<span class="fc" id="L479">      scheduler.submit(tr2, tr2, TaskPriority.Low);</span>
<span class="fc" id="L480">      scheduler.submit(tr3, tr3, TaskPriority.Starvable);</span>
<span class="fc" id="L481">      scheduler.submit(tr1, tr1, TaskPriority.High);</span>
<span class="fc" id="L482">      scheduler.submit(tr2, tr2, TaskPriority.Low);</span>
<span class="fc" id="L483">      scheduler.submit(tr3, tr3, TaskPriority.Starvable);</span>
      
<span class="fc" id="L485">      tr1.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
<span class="fc" id="L486">      tr2.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
<span class="fc" id="L487">      tr3.blockTillFinished(1000 * 10, 2); // throws exception if fails</span>
    } finally {
<span class="fc" id="L489">      priorityFactory.shutdown();</span>
    }
<span class="fc" id="L491">  }</span>
  
  @Test
  @Override
  public void submitCallableTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L496">    AbstractPrioritySchedulerFactory priorityFactory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L498">      super.submitCallableTest();</span>

<span class="fc" id="L500">      PrioritySchedulerService scheduler = priorityFactory.makeAbstractPriorityScheduler(2);</span>
      
<span class="fc" id="L502">      TestCallable tc1 = new TestCallable(0);</span>
<span class="fc" id="L503">      TestCallable tc2 = new TestCallable(0);</span>
<span class="fc" id="L504">      TestCallable tc3 = new TestCallable(0);</span>
<span class="fc" id="L505">      scheduler.submit(tc1, TaskPriority.High);</span>
<span class="fc" id="L506">      scheduler.submit(tc2, TaskPriority.Low);</span>
<span class="fc" id="L507">      scheduler.submit(tc3, TaskPriority.Starvable);</span>
      
<span class="fc" id="L509">      tc1.blockTillTrue(); // throws exception if fails</span>
<span class="fc" id="L510">      tc2.blockTillTrue(); // throws exception if fails</span>
<span class="fc" id="L511">      tc3.blockTillTrue(); // throws exception if fails</span>
    } finally {
<span class="fc" id="L513">      priorityFactory.shutdown();</span>
    }
<span class="fc" id="L515">  }</span>
  
  @Test
  public void lowPriorityFlowControlTest() {
<span class="fc" id="L519">    AbstractPrioritySchedulerFactory priorityFactory = getAbstractPrioritySchedulerFactory();</span>
<span class="fc" id="L520">    final AtomicBoolean testRunning = new AtomicBoolean(true);</span>
    try {
<span class="fc" id="L522">      final AbstractPriorityScheduler scheduler = priorityFactory.makeAbstractPriorityScheduler(1, TaskPriority.High, DELAY_TIME);</span>
      
<span class="fc" id="L524">      new Runnable() {</span>
        @Override
        public void run() {
<span class="fc bfc" id="L527" title="All 2 branches covered.">          if (testRunning.get()) {</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">            while (scheduler.getQueueManager().getQueueSet(TaskPriority.High).executeQueue.size() &lt; 5) {</span>
<span class="fc" id="L529">              scheduler.execute(this, TaskPriority.High);</span>
            }
          }
<span class="fc" id="L532">        }</span>
<span class="fc" id="L533">      }.run();</span>
      
<span class="fc" id="L535">      TestRunnable lowPriorityRunnable = new TestRunnable();</span>
<span class="fc" id="L536">      scheduler.execute(lowPriorityRunnable, TaskPriority.Low);</span>
      
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">      assertTrue(lowPriorityRunnable.getDelayTillFirstRun() &gt;= DELAY_TIME);</span>
    } finally {
<span class="fc" id="L540">      testRunning.set(false);</span>
<span class="fc" id="L541">      priorityFactory.shutdown();</span>
    }
<span class="fc" id="L543">  }</span>
  
  @Test
  public void removeHighPriorityRecurringRunnableTest() {
<span class="fc" id="L547">    removeRecurringRunnableTest(TaskPriority.High);</span>
<span class="fc" id="L548">  }</span>
  
  @Test
  public void removeLowPriorityRecurringRunnableTest() {
<span class="fc" id="L552">    removeRecurringRunnableTest(TaskPriority.Low);</span>
<span class="fc" id="L553">  }</span>
  
  @Test
  public void removeStarvablePriorityRecurringRunnableTest() {
<span class="fc" id="L557">    removeRecurringRunnableTest(TaskPriority.Starvable);</span>
<span class="fc" id="L558">  }</span>
  
  private void removeRecurringRunnableTest(TaskPriority priority) {
<span class="fc" id="L561">    int runFrequency = 1;</span>
<span class="fc" id="L562">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L564">      AbstractPriorityScheduler scheduler = factory.makeAbstractPriorityScheduler(1);</span>
<span class="fc" id="L565">      TestRunnable removedTask = new TestRunnable();</span>
<span class="fc" id="L566">      TestRunnable keptTask = new TestRunnable();</span>
<span class="fc" id="L567">      scheduler.scheduleWithFixedDelay(removedTask, 0, runFrequency, priority);</span>
<span class="fc" id="L568">      scheduler.scheduleWithFixedDelay(keptTask, 0, runFrequency, priority);</span>
<span class="fc" id="L569">      removedTask.blockTillStarted();</span>
      
<span class="fc" id="L571">      assertFalse(scheduler.remove(new TestRunnable()));</span>
      
<span class="fc" id="L573">      assertTrue(scheduler.remove(removedTask));</span>
      
      // verify removed is no longer running, and the kept task continues to run
<span class="fc" id="L576">      int keptRunCount = keptTask.getRunCount();</span>
<span class="fc" id="L577">      int runCount = removedTask.getRunCount();</span>
<span class="fc" id="L578">      TestUtils.sleep(runFrequency * 10);</span>

      // may be +1 if the task was running while the remove was called
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">      assertTrue(removedTask.getRunCount() == runCount || </span>
<span class="pc bnc" id="L582" title="All 2 branches missed.">                 removedTask.getRunCount() == runCount + 1);</span>
      
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">      assertTrue(keptTask.getRunCount() &gt;= keptRunCount);</span>
    } finally {
<span class="fc" id="L586">      factory.shutdown();</span>
    }
<span class="fc" id="L588">  }</span>
  
  @Test
  public void removeHighPriorityRunnableTest() {
<span class="fc" id="L592">    removeRunnableTest(TaskPriority.High);</span>
<span class="fc" id="L593">  }</span>
  
  @Test
  public void removeLowPriorityRunnableTest() {
<span class="fc" id="L597">    removeRunnableTest(TaskPriority.Low);</span>
<span class="fc" id="L598">  }</span>
  
  @Test
  public void removeStarvablePriorityRunnableTest() {
<span class="fc" id="L602">    removeRunnableTest(TaskPriority.Starvable);</span>
<span class="fc" id="L603">  }</span>
  
  private void removeRunnableTest(TaskPriority priority) {
<span class="fc" id="L606">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L608">      AbstractPriorityScheduler scheduler = factory.makeAbstractPriorityScheduler(1);</span>
<span class="fc" id="L609">      TestRunnable removedTask = new TestRunnable();</span>
<span class="fc" id="L610">      scheduler.submitScheduled(removedTask, 10 * 1000, priority);</span>
      
<span class="fc" id="L612">      assertFalse(scheduler.remove(new TestRunnable()));</span>
      
<span class="fc" id="L614">      assertTrue(scheduler.remove(removedTask));</span>
    } finally {
<span class="fc" id="L616">      factory.shutdown();</span>
    }
<span class="fc" id="L618">  }</span>
  
  @Test
  public void removeHighPriorityCallableTest() {
<span class="fc" id="L622">    removeCallableTest(TaskPriority.High);</span>
<span class="fc" id="L623">  }</span>
  
  @Test
  public void removeLowPriorityCallableTest() {
<span class="fc" id="L627">    removeCallableTest(TaskPriority.Low);</span>
<span class="fc" id="L628">  }</span>
  
  @Test
  public void removeStarvablePriorityCallableTest() {
<span class="fc" id="L632">    removeCallableTest(TaskPriority.Starvable);</span>
<span class="fc" id="L633">  }</span>
  
  private void removeCallableTest(TaskPriority priority) {
<span class="fc" id="L636">    AbstractPrioritySchedulerFactory factory = getAbstractPrioritySchedulerFactory();</span>
    try {
<span class="fc" id="L638">      AbstractPriorityScheduler scheduler = factory.makeAbstractPriorityScheduler(1);</span>
<span class="fc" id="L639">      TestCallable task = new TestCallable();</span>
<span class="fc" id="L640">      scheduler.submitScheduled(task, 1000 * 10, priority);</span>
      
<span class="fc" id="L642">      assertFalse(scheduler.remove(new TestCallable()));</span>
      
<span class="fc" id="L644">      assertTrue(scheduler.remove(task));</span>
    } finally {
<span class="fc" id="L646">      factory.shutdown();</span>
    }
<span class="fc" id="L648">  }</span>
  
  public interface AbstractPrioritySchedulerFactory extends SchedulerServiceFactory {
    public AbstractPriorityScheduler makeAbstractPriorityScheduler(int poolSize, 
                                                                   TaskPriority defaultPriority, 
                                                                   long maxWaitForLowPriority);
    
    public AbstractPriorityScheduler makeAbstractPriorityScheduler(int poolSize);
    
    @Override
    public default SchedulerService makeSchedulerService(int poolSize, boolean prestartIfAvailable) {
<span class="fc" id="L659">      return makeAbstractPriorityScheduler(poolSize);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>