<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FutureUtilsTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">threadly$All_in_threadly_test.exec</a> &gt; <a href="index.source.html" class="el_package">org.threadly.concurrent.future</a> &gt; <span class="el_source">FutureUtilsTest.java</span></div><h1>FutureUtilsTest.java</h1><pre class="source lang-java linenums">package org.threadly.concurrent.future;

import static org.junit.Assert.*;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Future;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import java.util.concurrent.atomic.AtomicInteger;

import org.junit.Test;
import org.threadly.BlockingTestRunnable;
import org.threadly.ThreadlyTester;
import org.threadly.concurrent.DoNothingRunnable;
import org.threadly.concurrent.SingleThreadScheduler;
import org.threadly.test.concurrent.AsyncVerifier;
import org.threadly.test.concurrent.TestRunnable;
import org.threadly.test.concurrent.TestableScheduler;
import org.threadly.util.StringUtils;
import org.threadly.util.SuppressedStackRuntimeException;

@SuppressWarnings(&quot;javadoc&quot;)
<span class="fc" id="L29">public class FutureUtilsTest extends ThreadlyTester {</span>
  private static &lt;T&gt; List&lt;ListenableFuture&lt;? extends T&gt;&gt; makeFutures(int count, int errorIndex) {
<span class="fc" id="L31">    List&lt;ListenableFuture&lt;? extends T&gt;&gt; result = new ArrayList&lt;&gt;(count + 1);</span>
    
<span class="fc bfc" id="L33" title="All 2 branches covered.">    for (int i = 0; i &lt; count; i++) {</span>
<span class="fc bfc" id="L34" title="All 2 branches covered.">      if (i == errorIndex) {</span>
<span class="fc" id="L35">        result.add(FutureUtils.&lt;T&gt;immediateFailureFuture(null));</span>
      } else {
<span class="fc" id="L37">        result.add(FutureUtils.&lt;T&gt;immediateResultFuture(null));</span>
      }
    }
    
<span class="fc" id="L41">    return result;</span>
  }
  
  @Test
  public void blockTillAllCompleteNullTest() throws InterruptedException {
<span class="fc" id="L46">    FutureUtils.blockTillAllComplete(null); // should return immediately</span>
<span class="fc" id="L47">  }</span>
  
  @Test
  public void blockTillAllCompleteTest() throws InterruptedException {
<span class="fc" id="L51">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L53">    FutureUtils.blockTillAllComplete(futures);</span>
    
<span class="fc" id="L55">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L57">      assertTrue(it.next().isDone());</span>
    }
<span class="fc" id="L59">  }</span>
  
  @Test
  public void blockTillAllCompleteErrorTest() throws InterruptedException {
<span class="fc" id="L63">    int errorIndex = TEST_QTY / 2;</span>
    
<span class="fc" id="L65">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, errorIndex);</span>
    
<span class="fc" id="L67">    FutureUtils.blockTillAllComplete(futures);</span>
    
<span class="fc" id="L69">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L71">      assertTrue(it.next().isDone());</span>
    }
<span class="fc" id="L73">  }</span>
  
  @Test
  public void blockTillAllCompleteWithTimeoutNullTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L77">    FutureUtils.blockTillAllComplete(null, 1); // should return immediately</span>
<span class="fc" id="L78">  }</span>
  
  @Test
  public void blockTillAllCompleteWithTimeoutTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L82">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L84">    FutureUtils.blockTillAllComplete(futures, 1000 * 10);</span>
    
<span class="fc" id="L86">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L88">      assertTrue(it.next().isDone());</span>
    }
<span class="fc" id="L90">  }</span>
  
  @Test
  public void blockTillAllCompleteWithTimeoutErrorTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L94">    int errorIndex = TEST_QTY / 2;</span>
    
<span class="fc" id="L96">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, errorIndex);</span>
    
<span class="fc" id="L98">    FutureUtils.blockTillAllComplete(futures, 1000 * 10);</span>
    
<span class="fc" id="L100">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L102">      assertTrue(it.next().isDone());</span>
    }
<span class="fc" id="L104">  }</span>
  
  @Test (expected = TimeoutException.class)
  public void blockTillAllCompleteWithTimeoutTimeoutTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L108">    List&lt;? extends ListenableFuture&lt;?&gt;&gt; futures = Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
    
<span class="nc" id="L110">    FutureUtils.blockTillAllComplete(futures, 100);</span>
<span class="nc" id="L111">    fail(&quot;Exception should have thrown&quot;);</span>
<span class="nc" id="L112">  }</span>
  
  @Test (expected = TimeoutException.class)
  public void blockTillAllCompleteWithTimeoutZeroTimeoutTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L116">    List&lt;? extends ListenableFuture&lt;?&gt;&gt; futures = Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
    
<span class="nc" id="L118">    FutureUtils.blockTillAllComplete(futures, 0);</span>
<span class="nc" id="L119">    fail(&quot;Exception should have thrown&quot;);</span>
<span class="nc" id="L120">  }</span>
  
  @Test
  public void blockTillAllCompleteOrFirstErrorNullTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L124">    FutureUtils.blockTillAllCompleteOrFirstError(null); // should return immediately</span>
<span class="fc" id="L125">  }</span>
  
  @Test
  public void blockTillAllCompleteOrFirstErrorTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L129">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L131">    FutureUtils.blockTillAllCompleteOrFirstError(futures);</span>
    
<span class="fc" id="L133">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L135">      assertTrue(it.next().isDone());</span>
    }
<span class="fc" id="L137">  }</span>
  
  @Test
  public void blockTillAllCompleteOrFirstErrorErrorTest() throws InterruptedException {
<span class="fc" id="L141">    int errorIndex = TEST_QTY / 2;</span>
    
<span class="fc" id="L143">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, errorIndex);</span>
    
<span class="fc" id="L145">    FutureUtils.blockTillAllComplete(futures);</span>

<span class="fc" id="L147">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">    for (int i = 0; i &lt;= errorIndex; i++) {</span>
<span class="fc" id="L149">      Future&lt;?&gt; f = it.next();</span>
      
<span class="fc bfc" id="L151" title="All 2 branches covered.">      if (i &lt; errorIndex) {</span>
<span class="fc" id="L152">        assertTrue(f.isDone());</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">      } else if (i == errorIndex) {</span>
        try {
<span class="nc" id="L155">          f.get();</span>
<span class="nc" id="L156">          fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L157">        } catch (ExecutionException e) {</span>
          // expected
<span class="nc" id="L159">        }</span>
      }
    }
<span class="fc" id="L162">  }</span>
  
  @Test
  public void blockTillAllCompleteOrFirstErrorWithTimeoutNullTest() throws InterruptedException, ExecutionException, TimeoutException {
<span class="fc" id="L166">    FutureUtils.blockTillAllCompleteOrFirstError(null, 10); // should return immediately</span>
<span class="fc" id="L167">  }</span>
  
  @Test
  public void blockTillAllCompleteOrFirstErrorWithTimeoutTest() throws InterruptedException, ExecutionException, TimeoutException {
<span class="fc" id="L171">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L173">    FutureUtils.blockTillAllCompleteOrFirstError(futures, 1000 * 10);</span>
    
<span class="fc" id="L175">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L177">      assertTrue(it.next().isDone());</span>
    }
<span class="fc" id="L179">  }</span>
  
  @Test
  public void blockTillAllCompleteOrFirstErrorWithTimeoutErrorTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L183">    int errorIndex = TEST_QTY / 2;</span>
    
<span class="fc" id="L185">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, errorIndex);</span>
    
<span class="fc" id="L187">    FutureUtils.blockTillAllComplete(futures, 1000 * 10);</span>

<span class="fc" id="L189">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">    for (int i = 0; i &lt;= errorIndex; i++) {</span>
<span class="fc" id="L191">      Future&lt;?&gt; f = it.next();</span>
      
<span class="fc bfc" id="L193" title="All 2 branches covered.">      if (i &lt; errorIndex) {</span>
<span class="fc" id="L194">        assertTrue(f.isDone());</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">      } else if (i == errorIndex) {</span>
        try {
<span class="nc" id="L197">          f.get();</span>
<span class="nc" id="L198">          fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L199">        } catch (ExecutionException e) {</span>
          // expected
<span class="nc" id="L201">        }</span>
      }
    }
<span class="fc" id="L204">  }</span>
  
  @Test (expected = TimeoutException.class)
  public void blockTillAllCompleteOrFirstErrorWithTimeoutTimeoutTest() throws InterruptedException, 
                                                                              TimeoutException, ExecutionException {
<span class="fc" id="L209">    List&lt;? extends ListenableFuture&lt;?&gt;&gt; futures = Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
    
<span class="nc" id="L211">    FutureUtils.blockTillAllCompleteOrFirstError(futures, 100);</span>
<span class="nc" id="L212">    fail(&quot;Exception should have thrown&quot;);</span>
<span class="nc" id="L213">  }</span>
  
  @Test (expected = TimeoutException.class)
  public void blockTillAllCompleteOrFirstErrorWithTimeoutZeroTimeoutTest() throws InterruptedException, 
                                                                                  TimeoutException, ExecutionException {
<span class="fc" id="L218">    List&lt;? extends ListenableFuture&lt;?&gt;&gt; futures = Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
    
<span class="nc" id="L220">    FutureUtils.blockTillAllCompleteOrFirstError(futures, 0);</span>
<span class="nc" id="L221">    fail(&quot;Exception should have thrown&quot;);</span>
<span class="nc" id="L222">  }</span>
  
  @Test
  public void countFuturesWithResultTest() throws InterruptedException {
<span class="fc" id="L226">    List&lt;ListenableFuture&lt;Boolean&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY * 2);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY * 2; i++) {</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">      futures.add(FutureUtils.immediateResultFuture(i % 2 == 1));</span>
    }
    
<span class="fc" id="L231">    assertEquals(TEST_QTY, FutureUtils.countFuturesWithResult(futures, false));</span>
<span class="fc" id="L232">  }</span>
  
  @Test
  public void countFuturesWithResultWithTimeoutTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L236">    List&lt;ListenableFuture&lt;Boolean&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY * 2);</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY * 2; i++) {</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">      futures.add(FutureUtils.immediateResultFuture(i % 2 == 1));</span>
    }
    
<span class="fc" id="L241">    assertEquals(TEST_QTY, FutureUtils.countFuturesWithResult(futures, false, 100));</span>
<span class="fc" id="L242">  }</span>
  
  @Test (expected = TimeoutException.class)
  public void countFuturesWithResultWithTimeoutTimeoutTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L246">    List&lt;? extends ListenableFuture&lt;?&gt;&gt; futures = Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
    
<span class="nc" id="L248">    assertEquals(TEST_QTY, FutureUtils.countFuturesWithResult(futures, false, 100));</span>
<span class="nc" id="L249">    fail(&quot;Exception should have thrown&quot;);</span>
<span class="nc" id="L250">  }</span>
  
  @Test (expected = TimeoutException.class)
  public void countFuturesWithResultWithTimeoutZeroTimeoutTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L254">    List&lt;? extends ListenableFuture&lt;?&gt;&gt; futures = Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
    
<span class="nc" id="L256">    assertEquals(TEST_QTY, FutureUtils.countFuturesWithResult(futures, false, 0));</span>
<span class="nc" id="L257">    fail(&quot;Exception should have thrown&quot;);</span>
<span class="nc" id="L258">  }</span>
  
  private static void verifyCompleteFuture(final ListenableFuture&lt;?&gt; f, 
                                           final List&lt;? extends ListenableFuture&lt;?&gt;&gt; futures) throws InterruptedException, TimeoutException {
<span class="fc" id="L262">    final AsyncVerifier av = new AsyncVerifier();</span>
    
<span class="fc" id="L264">    f.addListener(new Runnable() {</span>
      @Override
      public void run() {
<span class="fc" id="L267">        av.assertTrue(f.isDone());</span>
        
<span class="fc" id="L269">        Iterator&lt;? extends ListenableFuture&lt;?&gt;&gt; it = futures.iterator();</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">        while (it.hasNext()) {</span>
<span class="fc" id="L271">          av.assertTrue(it.next().isDone());</span>
        }
        
<span class="fc" id="L274">        av.signalComplete();</span>
<span class="fc" id="L275">      }</span>
    });
    
<span class="fc" id="L278">    av.waitForTest();</span>
<span class="fc" id="L279">  }</span>
  
  @Test
  public void invokeAfterAllCompleteNullTest() {
<span class="fc" id="L283">    TestRunnable tr = new TestRunnable();</span>
    
<span class="fc" id="L285">    FutureUtils.invokeAfterAllComplete(null, tr);</span>
    
<span class="fc" id="L287">    assertTrue(tr.ranOnce());</span>
<span class="fc" id="L288">  }</span>
  
  @Test
  public void invokeAfterAllCompleteEmptyListTest() {
<span class="fc" id="L292">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L293">    TestRunnable tr = new TestRunnable();</span>
    
<span class="fc" id="L295">    FutureUtils.invokeAfterAllComplete(futures, tr);</span>
    
<span class="fc" id="L297">    assertTrue(tr.ranOnce());</span>
<span class="fc" id="L298">  }</span>
  
  @Test
  public void invokeAfterAllCompleteTest() {
<span class="fc" id="L302">    List&lt;SettableListenableFuture&lt;Void&gt;&gt; futures = </span>
<span class="fc" id="L303">        Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
<span class="fc" id="L304">    TestRunnable tr = new TestRunnable();</span>
    
<span class="fc" id="L306">    FutureUtils.invokeAfterAllComplete(futures, tr);</span>
    
<span class="fc" id="L308">    assertEquals(0, tr.getRunCount());</span>
    
<span class="fc" id="L310">    futures.get(0).setResult(null);</span>
    
<span class="fc" id="L312">    assertTrue(tr.ranOnce());</span>
<span class="fc" id="L313">  }</span>
  
  @Test
  public void invokeAfterAllCompleteOnExecutorTest() {
<span class="fc" id="L317">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L318">    List&lt;SettableListenableFuture&lt;Void&gt;&gt; futures = </span>
<span class="fc" id="L319">        Collections.singletonList(new SettableListenableFuture&lt;&gt;());</span>
<span class="fc" id="L320">    TestRunnable tr = new TestRunnable();</span>
    
<span class="fc" id="L322">    FutureUtils.invokeAfterAllComplete(futures, tr, scheduler);</span>
    
<span class="fc" id="L324">    assertEquals(0, tr.getRunCount());</span>
    
<span class="fc" id="L326">    futures.get(0).setResult(null);</span>
    
<span class="fc" id="L328">    assertEquals(0, tr.getRunCount());</span>
    
<span class="fc" id="L330">    assertEquals(1, scheduler.tick());</span>
    
<span class="fc" id="L332">    assertTrue(tr.ranOnce());</span>
<span class="fc" id="L333">  }</span>
  
  @Test
  public void makeCompleteFutureNullTest() {
<span class="fc" id="L337">    ListenableFuture&lt;?&gt; f = FutureUtils.makeCompleteFuture(null);</span>
    
<span class="fc" id="L339">    assertTrue(f.isDone());</span>
<span class="fc" id="L340">  }</span>
  
  @Test
  public void makeCompleteFutureEmptyListTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L344">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L345">    ListenableFuture&lt;?&gt; f = FutureUtils.makeCompleteFuture(futures);</span>
    
<span class="fc" id="L347">    assertTrue(f.isDone());</span>
<span class="fc" id="L348">    assertNull(f.get());</span>
<span class="fc" id="L349">  }</span>
  
  @Test
  public void makeCompleteFutureSingletonListTest() {
<span class="fc" id="L353">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.singletonList(FutureUtils.immediateResultFuture(null));</span>
<span class="fc" id="L354">    ListenableFuture&lt;?&gt; f = FutureUtils.makeCompleteFuture(futures);</span>
    
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">    assertTrue(f == futures.get(0));</span>
<span class="fc" id="L357">  }</span>
  
  @Test
  public void makeCompleteFutureEmptyCollectionTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L361">    ListenableFuture&lt;?&gt; f = FutureUtils.makeCompleteFuture(Collections.emptySet());</span>
    
<span class="fc" id="L363">    assertTrue(f.isDone());</span>
<span class="fc" id="L364">    assertNull(f.get());</span>
<span class="fc" id="L365">  }</span>
  
  @Test
  public void makeCompleteFutureSinletonCollectionTest() {
<span class="fc" id="L369">    ListenableFuture&lt;?&gt; singletonFuture = FutureUtils.immediateResultFuture(null);</span>
<span class="fc" id="L370">    ListenableFuture&lt;?&gt; f = FutureUtils.makeCompleteFuture(Collections.singleton(singletonFuture));</span>
    
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">    assertTrue(f == singletonFuture);</span>
<span class="fc" id="L373">  }</span>
  
  @Test
  public void makeCompleteFutureTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L377">    makeCompleteFutureTest(-1);</span>
<span class="fc" id="L378">  }</span>
  
  @Test
  public void makeCompleteFutureWithErrorTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L382">    makeCompleteFutureTest(TEST_QTY / 2);</span>
<span class="fc" id="L383">  }</span>
  
  private static void makeCompleteFutureTest(int errorIndex) throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L386">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, errorIndex);</span>

<span class="fc" id="L388">    ListenableFuture&lt;?&gt; f = FutureUtils.makeCompleteFuture(futures);</span>
    
<span class="fc" id="L390">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L391">    assertNull(f.get());</span>
<span class="fc" id="L392">  }</span>
  
  @Test
  public void makeCompleteFutureCancelTest() {
<span class="fc" id="L396">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L397">    assertTrue(FutureUtils.makeCompleteFuture(Collections.singletonList(slf)).cancel(true));</span>
    
<span class="fc" id="L399">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L400">  }</span>
  
  @Test
  public void makeCompleteFutureWithResultNullTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L404">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L405">    ListenableFuture&lt;String&gt; f = FutureUtils.makeCompleteFuture(null, result);</span>
    
<span class="fc" id="L407">    assertTrue(f.isDone());</span>
<span class="fc" id="L408">    assertEquals(result, f.get());</span>
<span class="fc" id="L409">  }</span>
  
  @Test
  public void makeCompleteFutureWithResultEmptyListTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L413">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L414">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L415">    ListenableFuture&lt;String&gt; f = FutureUtils.makeCompleteFuture(futures, result);</span>
    
<span class="fc" id="L417">    assertTrue(f.isDone());</span>
<span class="fc" id="L418">    assertEquals(result, f.get());</span>
<span class="fc" id="L419">  }</span>
  
  @Test
  public void makeCompleteFutureWithResultAlreadyDoneTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L423">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L424">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L426">    ListenableFuture&lt;String&gt; f = FutureUtils.makeCompleteFuture(futures, result);</span>
    
<span class="fc" id="L428">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L429">    assertEquals(result, f.get());</span>
<span class="fc" id="L430">  }</span>
  
  @Test
  public void makeCompleteFutureWithResultNotCompleteTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L434">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L435">    List&lt;SettableListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L436" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L437">      SettableListenableFuture&lt;?&gt; future = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">      if (i != 0) {</span>
<span class="fc" id="L439">        future.setResult(null);</span>
      }
<span class="fc" id="L441">      futures.add(future);</span>
    }
    
<span class="fc" id="L444">    ListenableFuture&lt;String&gt; f = FutureUtils.makeCompleteFuture(futures, result);</span>
<span class="fc" id="L445">    futures.get(0).setResult(null); // complete now</span>
    
<span class="fc" id="L447">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L448">    assertEquals(result, f.get());</span>
<span class="fc" id="L449">  }</span>
  
  @Test
  public void makeCompleteFutureWithNullResultTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L453">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L455">    ListenableFuture&lt;?&gt; f = FutureUtils.makeCompleteFuture(futures, null);</span>
    
<span class="fc" id="L457">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L458">    assertNull(f.get());</span>
<span class="fc" id="L459">  }</span>
  
  @Test
  public void makeCompleteFutureWithResultCancelTest() {
<span class="fc" id="L463">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L464">    assertTrue(FutureUtils.makeCompleteFuture(Collections.singletonList(slf), null).cancel(true));</span>
    
<span class="fc" id="L466">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L467">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureNullTest() {
<span class="fc" id="L471">    ListenableFuture&lt;?&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(null);</span>
    
<span class="fc" id="L473">    assertTrue(f.isDone());</span>
<span class="fc" id="L474">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureEmptyListTest() {
<span class="fc" id="L478">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L479">    ListenableFuture&lt;?&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures);</span>
    
<span class="fc" id="L481">    assertTrue(f.isDone());</span>
<span class="fc" id="L482">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureAlreadyDoneFuturesTest() {
<span class="fc" id="L486">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
    
<span class="fc bfc" id="L488" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L489">      SettableListenableFuture&lt;?&gt; future = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L490">      future.setResult(null);</span>
<span class="fc" id="L491">      futures.add(future);</span>
    }

<span class="fc" id="L494">    ListenableFuture&lt;?&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures);</span>
    
<span class="fc" id="L496">    assertTrue(f.isDone());</span>
<span class="fc" id="L497">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L501">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>

<span class="fc" id="L503">    ListenableFuture&lt;?&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures);</span>
    
<span class="fc" id="L505">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L506">    assertNull(f.get());</span>
<span class="fc" id="L507">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFuturePropagateFailureTest() {
<span class="fc" id="L511">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, TEST_QTY / 2);</span>
<span class="fc" id="L512">    ListenableFuture&lt;?&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures);</span>
    
    try {
<span class="nc" id="L515">      f.get();</span>
<span class="nc" id="L516">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L517">    } catch (ExecutionException e) {</span>
      // expected
<span class="nc" id="L519">    } catch (InterruptedException e) {</span>
<span class="nc" id="L520">      fail(&quot;Interrupted?&quot;);</span>
<span class="pc" id="L521">    }</span>
<span class="fc" id="L522">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFuturePropagateCancelTest() {
<span class="fc" id="L526">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L527">    assertTrue(slf.cancel(false));</span>
<span class="fc" id="L528">    ListenableFuture&lt;?&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(Collections.singletonList(slf));</span>
    
<span class="fc" id="L530">    assertTrue(f.isDone());</span>
<span class="fc" id="L531">    assertTrue(f.isCancelled());</span>
<span class="fc" id="L532">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureCancelTest() {
<span class="fc" id="L536">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L537">    assertTrue(FutureUtils.makeFailurePropagatingCompleteFuture(Collections.singletonList(slf)).cancel(true));</span>
    
<span class="fc" id="L539">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L540">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureWithResultNullTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L544">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L545">    ListenableFuture&lt;String&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(null, result);</span>
    
<span class="fc" id="L547">    assertTrue(f.isDone());</span>
<span class="fc" id="L548">    assertEquals(result, f.get());</span>
<span class="fc" id="L549">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureWithResultEmptyListTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L553">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L554">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L555">    ListenableFuture&lt;String&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures, result);</span>
    
<span class="fc" id="L557">    assertTrue(f.isDone());</span>
<span class="fc" id="L558">    assertEquals(result, f.get());</span>
<span class="fc" id="L559">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureWithResultAlreadyDoneTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L563">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L564">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L566">    ListenableFuture&lt;String&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures, result);</span>
    
<span class="fc" id="L568">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L569">    assertEquals(result, f.get());</span>
<span class="fc" id="L570">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureWithResultNotCompleteTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L574">    String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L575">    List&lt;SettableListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L576" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L577">      SettableListenableFuture&lt;?&gt; future = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">      if (i != 0) {</span>
<span class="fc" id="L579">        future.setResult(null);</span>
      }
<span class="fc" id="L581">      futures.add(future);</span>
    }
    
<span class="fc" id="L584">    ListenableFuture&lt;String&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures, result);</span>
<span class="fc" id="L585">    futures.get(0).setResult(null);</span>
    
<span class="fc" id="L587">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L588">    assertEquals(result, f.get());</span>
<span class="fc" id="L589">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureWithNullResultTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L593">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L595">    ListenableFuture&lt;?&gt; f = FutureUtils.makeFailurePropagatingCompleteFuture(futures, null);</span>
    
<span class="fc" id="L597">    verifyCompleteFuture(f, futures);</span>
<span class="fc" id="L598">    assertNull(f.get());</span>
<span class="fc" id="L599">  }</span>
  
  @Test
  public void makeFailurePropagatingCompleteFutureWithResultCancelTest() {
<span class="fc" id="L603">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L604">    assertTrue(FutureUtils.makeFailurePropagatingCompleteFuture(Collections.singletonList(slf), null).cancel(true));</span>
    
<span class="fc" id="L606">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L607">  }</span>
  
  @Test
  public void makeCompleteListFutureNullTest() {
<span class="fc" id="L611">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeCompleteListFuture(null);</span>
    
<span class="fc" id="L613">    assertTrue(f.isDone());</span>
<span class="fc" id="L614">  }</span>
  
  @Test
  public void makeCompleteListFutureEmptyListTest() {
<span class="fc" id="L618">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L619">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeCompleteListFuture(futures);</span>
    
<span class="fc" id="L621">    assertTrue(f.isDone());</span>
<span class="fc" id="L622">  }</span>
  
  @Test
  public void makeCompleteListFutureAlreadyDoneFuturesTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L626">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
    
<span class="fc bfc" id="L628" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L629">      SettableListenableFuture&lt;?&gt; future = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc bfc" id="L630" title="All 2 branches covered.">      if (i == TEST_QTY / 2) {</span>
<span class="fc" id="L631">        future.setFailure(null);</span>
      } else {
<span class="fc" id="L633">        future.setResult(null);</span>
      }
<span class="fc" id="L635">      futures.add(future);</span>
    }

<span class="fc" id="L638">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeCompleteListFuture(futures);</span>
    
<span class="fc" id="L640">    assertTrue(f.isDone());</span>
    
<span class="fc" id="L642">    verifyAllIncluded(futures, f.get(), null);</span>
<span class="fc" id="L643">  }</span>
  
  private static void verifyAllIncluded(List&lt;ListenableFuture&lt;?&gt;&gt; expected, 
                                        List&lt;ListenableFuture&lt;?&gt;&gt; result, 
                                        ListenableFuture&lt;?&gt; excludedFuture) {
<span class="fc" id="L648">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = expected.iterator();</span>
<span class="fc bfc" id="L649" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L650">      ListenableFuture&lt;?&gt; f = it.next();</span>
<span class="fc bfc" id="L651" title="All 2 branches covered.">      if (f != excludedFuture) {</span>
<span class="fc" id="L652">        assertTrue(result.contains(f));</span>
      }
<span class="fc" id="L654">    }</span>
    
<span class="fc" id="L656">    assertFalse(result.contains(excludedFuture));</span>
<span class="fc bfc" id="L657" title="All 2 branches covered.">    assertEquals(expected.size() - (excludedFuture == null ? 0 : 1), result.size());</span>
<span class="fc" id="L658">  }</span>
  
  @Test
  public void makeCompleteListFutureTest() throws InterruptedException, TimeoutException, ExecutionException {
<span class="fc" id="L662">    makeCompleteListFutureTest(-1);</span>
<span class="fc" id="L663">  }</span>
  
  @Test
  public void makeCompleteListFutureWithErrorTest() throws InterruptedException, 
                                                           TimeoutException, ExecutionException {
<span class="fc" id="L668">    makeCompleteListFutureTest(TEST_QTY / 2);</span>
<span class="fc" id="L669">  }</span>
  
  private static void makeCompleteListFutureTest(int errorIndex) throws InterruptedException, 
                                                                        TimeoutException, ExecutionException {
<span class="fc" id="L673">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, errorIndex);</span>

<span class="fc" id="L675">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeCompleteListFuture(futures);</span>
    
<span class="fc" id="L677">    verifyCompleteFuture(f, futures);</span>
    
<span class="fc" id="L679">    verifyAllIncluded(futures, f.get(), null);</span>
<span class="fc" id="L680">  }</span>
  
  @Test
  public void makeCompleteListFutureCancelTest() {
<span class="fc" id="L684">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L685">    assertTrue(FutureUtils.makeCompleteListFuture(Collections.singletonList(slf)).cancel(true));</span>
    
<span class="fc" id="L687">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L688">  }</span>
  
  @Test
  public void makeSuccessListFutureNullTest() {
<span class="fc" id="L692">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeSuccessListFuture(null);</span>
    
<span class="fc" id="L694">    assertTrue(f.isDone());</span>
<span class="fc" id="L695">  }</span>
  
  @Test
  public void makeSuccessListFutureEmptyListTest() {
<span class="fc" id="L699">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L700">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeSuccessListFuture(futures);</span>
    
<span class="fc" id="L702">    assertTrue(f.isDone());</span>
<span class="fc" id="L703">  }</span>
  
  @Test
  public void makeSuccessListFutureAlreadyDoneFuturesTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L707">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc" id="L708">    ListenableFuture&lt;?&gt; failureFuture = null;</span>
    
<span class="fc bfc" id="L710" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L711">      SettableListenableFuture&lt;?&gt; future = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc bfc" id="L712" title="All 2 branches covered.">      if (i == TEST_QTY / 2) {</span>
<span class="fc" id="L713">        failureFuture = future;</span>
<span class="fc" id="L714">        future.setFailure(null);</span>
      } else {
<span class="fc" id="L716">        future.setResult(null);</span>
      }
<span class="fc" id="L718">      futures.add(future);</span>
    }

<span class="fc" id="L721">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeSuccessListFuture(futures);</span>
    
<span class="fc" id="L723">    assertTrue(f.isDone());</span>
    
<span class="fc" id="L725">    verifyAllIncluded(futures, f.get(), failureFuture);</span>
<span class="fc" id="L726">  }</span>
  
  @Test
  public void makeSuccessListFutureWithErrorTest() throws ExecutionException, InterruptedException, TimeoutException {
<span class="fc" id="L730">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
<span class="fc" id="L731">    SettableListenableFuture&lt;?&gt; failureFuture = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L732">    failureFuture.setFailure(null);</span>
<span class="fc" id="L733">    futures.add(failureFuture);</span>

<span class="fc" id="L735">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeSuccessListFuture(futures);</span>
    
<span class="fc" id="L737">    verifyCompleteFuture(f, futures);</span>
    
<span class="fc" id="L739">    verifyAllIncluded(futures, f.get(), failureFuture);</span>
<span class="fc" id="L740">  }</span>
  
  @Test
  public void makeSuccessListFutureWithCancelErrorTest() throws ExecutionException, InterruptedException, TimeoutException {
<span class="fc" id="L744">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
<span class="fc" id="L745">    SettableListenableFuture&lt;?&gt; cancelFuture = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L746">    cancelFuture.cancel(false);</span>
<span class="fc" id="L747">    futures.add(cancelFuture);</span>

<span class="fc" id="L749">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeSuccessListFuture(futures);</span>
    
<span class="fc" id="L751">    verifyCompleteFuture(f, futures);</span>
    
<span class="fc" id="L753">    verifyAllIncluded(futures, f.get(), cancelFuture);</span>
<span class="fc" id="L754">  }</span>
  
  @Test
  public void makeSuccessListFutureCancelTest() {
<span class="fc" id="L758">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L759">    assertTrue(FutureUtils.makeSuccessListFuture(Collections.singletonList(slf)).cancel(true));</span>
    
<span class="fc" id="L761">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L762">  }</span>
  
  @Test
  public void makeSuccessListOrderTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L766">    List&lt;String&gt; expectedResults = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc" id="L767">    List&lt;SettableListenableFuture&lt;String&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L768" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L769">      SettableListenableFuture&lt;String&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc bfc" id="L770" title="All 2 branches covered.">      if (i == 1) {</span>
<span class="fc" id="L771">        slf.setFailure(new Exception());</span>
      } else {
<span class="fc" id="L773">        String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L774">        expectedResults.add(result);</span>
<span class="fc bfc" id="L775" title="All 2 branches covered.">        if (i % 2 == 0) {</span>
<span class="fc" id="L776">          slf.setResult(result);</span>
        }
      }
<span class="fc" id="L779">      futures.add(slf);</span>
    }
    
<span class="fc" id="L782">    ListenableFuture&lt;List&lt;ListenableFuture&lt;? extends String&gt;&gt;&gt; collectionFuture = </span>
<span class="fc" id="L783">        FutureUtils.makeSuccessListFuture(futures);</span>

<span class="fc bfc" id="L785" title="All 2 branches covered.">    for (int i = 2; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L786">      SettableListenableFuture&lt;String&gt; slf = futures.get(i);</span>
<span class="fc bfc" id="L787" title="All 2 branches covered.">      if (! slf.isDone()) {</span>
<span class="fc" id="L788">        slf.setResult(expectedResults.get(i - 1));</span>
      }
    }
    
<span class="fc" id="L792">    List&lt;ListenableFuture&lt;? extends String&gt;&gt; actualResults = collectionFuture.get();</span>
    
<span class="fc" id="L794">    assertEquals(expectedResults.size(), actualResults.size());</span>
<span class="fc bfc" id="L795" title="All 2 branches covered.">    for (int i = 0; i &lt; expectedResults.size(); i++) {</span>
<span class="fc" id="L796">      assertEquals(expectedResults.get(i), actualResults.get(i).get());</span>
    }
<span class="fc" id="L798">  }</span>
  
  @Test
  public void makeFailureListFutureNullTest() {
<span class="fc" id="L802">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeFailureListFuture(null);</span>
    
<span class="fc" id="L804">    assertTrue(f.isDone());</span>
<span class="fc" id="L805">  }</span>
  
  @Test
  public void makeFailureListFutureEmptyListTest() {
<span class="fc" id="L809">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = Collections.emptyList();</span>
<span class="fc" id="L810">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeFailureListFuture(futures);</span>
    
<span class="fc" id="L812">    assertTrue(f.isDone());</span>
<span class="fc" id="L813">  }</span>
  
  @Test
  public void makeFailureListFutureAlreadyDoneFuturesTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L817">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc" id="L818">    ListenableFuture&lt;?&gt; failureFuture = null;</span>
    
<span class="fc bfc" id="L820" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L821">      SettableListenableFuture&lt;?&gt; future = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc bfc" id="L822" title="All 2 branches covered.">      if (i == TEST_QTY / 2) {</span>
<span class="fc" id="L823">        failureFuture = future;</span>
<span class="fc" id="L824">        future.setFailure(null);</span>
      } else {
<span class="fc" id="L826">        future.setResult(null);</span>
      }
<span class="fc" id="L828">      futures.add(future);</span>
    }

<span class="fc" id="L831">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeFailureListFuture(futures);</span>
    
<span class="fc" id="L833">    assertTrue(f.isDone());</span>
    
<span class="fc" id="L835">    verifyNoneIncluded(futures, f.get(), failureFuture);</span>
<span class="fc" id="L836">  }</span>
  
  private static void verifyNoneIncluded(List&lt;ListenableFuture&lt;?&gt;&gt; exempt, 
                                         List&lt;ListenableFuture&lt;?&gt;&gt; result, 
                                         ListenableFuture&lt;?&gt; includedFuture) {
<span class="fc" id="L841">    Iterator&lt;ListenableFuture&lt;?&gt;&gt; it = exempt.iterator();</span>
<span class="fc bfc" id="L842" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L843">      ListenableFuture&lt;?&gt; f = it.next();</span>
<span class="fc bfc" id="L844" title="All 2 branches covered.">      if (f != includedFuture) {</span>
<span class="fc" id="L845">        assertFalse(result.contains(f));</span>
      }
<span class="fc" id="L847">    }</span>
    
<span class="fc" id="L849">    assertTrue(result.contains(includedFuture));</span>
<span class="fc" id="L850">  }</span>
  
  @Test
  public void makeFailureListFutureWithErrorTest() throws InterruptedException, 
                                                          TimeoutException, ExecutionException {
<span class="fc" id="L855">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
<span class="fc" id="L856">    SettableListenableFuture&lt;?&gt; failureFuture = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L857">    failureFuture.setFailure(null);</span>
<span class="fc" id="L858">    futures.add(failureFuture);</span>

<span class="fc" id="L860">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeFailureListFuture(futures);</span>
    
<span class="fc" id="L862">    verifyCompleteFuture(f, futures);</span>
    
<span class="fc" id="L864">    verifyNoneIncluded(futures, f.get(), failureFuture);</span>
<span class="fc" id="L865">  }</span>
  
  @Test
  public void makeFailureListFutureWithCancelErrorTest() throws InterruptedException, 
                                                                TimeoutException, ExecutionException {
<span class="fc" id="L870">    List&lt;ListenableFuture&lt;?&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
<span class="fc" id="L871">    SettableListenableFuture&lt;?&gt; cancelFuture = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L872">    cancelFuture.cancel(false);</span>
<span class="fc" id="L873">    futures.add(cancelFuture);</span>

<span class="fc" id="L875">    ListenableFuture&lt;List&lt;ListenableFuture&lt;?&gt;&gt;&gt; f = FutureUtils.makeFailureListFuture(futures);</span>
    
<span class="fc" id="L877">    verifyCompleteFuture(f, futures);</span>
    
<span class="fc" id="L879">    verifyNoneIncluded(futures, f.get(), cancelFuture);</span>
<span class="fc" id="L880">  }</span>
  
  @Test
  public void makeFailureListFutureCancelTest() {
<span class="fc" id="L884">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L885">    assertTrue(FutureUtils.makeFailureListFuture(Collections.singletonList(slf)).cancel(true));</span>
    
<span class="fc" id="L887">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L888">  }</span>
  
  @Test
  public void makeResultListFutureNullFuturesTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L892">    ListenableFuture&lt;List&lt;String&gt;&gt; resultFuture = FutureUtils.makeResultListFuture(null, false);</span>
    
<span class="fc" id="L894">    assertTrue(resultFuture.isDone());</span>
<span class="fc" id="L895">    assertNotNull(resultFuture.get());</span>
<span class="fc" id="L896">    assertTrue(resultFuture.get().isEmpty());</span>
<span class="fc" id="L897">  }</span>
  
  @Test
  public void makeResultListFutureAlreadyDoneFuturesTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L901">    List&lt;ListenableFuture&lt;? extends String&gt;&gt; futures = makeFutures(TEST_QTY, -1);</span>
    
<span class="fc" id="L903">    ListenableFuture&lt;List&lt;String&gt;&gt; resultFuture = FutureUtils.makeResultListFuture(futures, false);</span>
    
<span class="fc" id="L905">    assertTrue(resultFuture.isDone());</span>
<span class="fc" id="L906">    assertEquals(TEST_QTY, resultFuture.get().size());</span>
<span class="fc" id="L907">  }</span>
  
  @Test
  public void makeResultListFutureIgnoreFailureTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L911">    List&lt;ListenableFuture&lt;? extends String&gt;&gt; futures = makeFutures(TEST_QTY, TEST_QTY / 2);</span>
    
<span class="fc" id="L913">    ListenableFuture&lt;List&lt;String&gt;&gt; resultFuture = FutureUtils.makeResultListFuture(futures, true);</span>
    
<span class="fc" id="L915">    assertTrue(resultFuture.isDone());</span>
<span class="fc" id="L916">    assertEquals(TEST_QTY - 1, resultFuture.get().size());</span>
<span class="fc" id="L917">  }</span>
  
  @Test (expected = ExecutionException.class)
  public void makeResultListFutureWithFailureTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L921">    List&lt;ListenableFuture&lt;? extends String&gt;&gt; futures = makeFutures(TEST_QTY, TEST_QTY / 2);</span>
    
<span class="fc" id="L923">    ListenableFuture&lt;List&lt;String&gt;&gt; resultFuture = FutureUtils.makeResultListFuture(futures, false);</span>
    
<span class="fc" id="L925">    assertTrue(resultFuture.isDone());</span>
<span class="nc" id="L926">    resultFuture.get();</span>
<span class="nc" id="L927">    fail(&quot;Exception should have thrown&quot;);</span>
<span class="nc" id="L928">  }</span>
  
  @Test
  public void makeResultListFutureCancelTest() {
<span class="fc" id="L932">    SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L933">    assertTrue(FutureUtils.makeResultListFuture(Collections.singletonList(slf), true).cancel(true));</span>
    
<span class="fc" id="L935">    assertTrue(slf.isCancelled());</span>
<span class="fc" id="L936">  }</span>
  
  @Test
  public void makeResultListFutureResultsTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L940">    List&lt;String&gt; expectedResults = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc" id="L941">    List&lt;ListenableFuture&lt;String&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L942" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L943">      String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L944">      expectedResults.add(result);</span>
<span class="fc" id="L945">      futures.add(FutureUtils.immediateResultFuture(result));</span>
    }
    
<span class="fc" id="L948">    List&lt;String&gt; actualResults = FutureUtils.makeResultListFuture(futures, false).get();</span>
   
<span class="fc" id="L950">    assertTrue(actualResults.containsAll(expectedResults));</span>
<span class="fc" id="L951">    assertTrue(expectedResults.containsAll(actualResults));</span>
<span class="fc" id="L952">  }</span>
  
  @Test
  public void makeResultListOrderTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L956">    List&lt;String&gt; expectedResults = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc" id="L957">    List&lt;SettableListenableFuture&lt;String&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L958" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L959">      String result = StringUtils.makeRandomString(5);</span>
<span class="fc" id="L960">      expectedResults.add(result);</span>
<span class="fc" id="L961">      SettableListenableFuture&lt;String&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc bfc" id="L962" title="All 2 branches covered.">      if (i % 2 == 1) {</span>
<span class="fc" id="L963">        slf.setResult(result);</span>
      }
<span class="fc" id="L965">      futures.add(slf);</span>
    }
    
<span class="fc" id="L968">    ListenableFuture&lt;List&lt;String&gt;&gt; collectionFuture = FutureUtils.makeResultListFuture(futures, false);</span>

<span class="fc bfc" id="L970" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L971">      SettableListenableFuture&lt;String&gt; slf = futures.get(i);</span>
<span class="fc bfc" id="L972" title="All 2 branches covered.">      if (! slf.isDone()) {</span>
<span class="fc" id="L973">        slf.setResult(expectedResults.get(i));</span>
      }
    }
    
<span class="fc" id="L977">    List&lt;String&gt; actualResults = collectionFuture.get();</span>

<span class="fc bfc" id="L979" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L980">      assertEquals(expectedResults.get(i), actualResults.get(i));</span>
    }
<span class="fc" id="L982">  }</span>
  
  @Test
  public void cancelIncompleteFuturesTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L986">    List&lt;SettableListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L987" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L988">      SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L989">      futures.add(slf);</span>
<span class="fc bfc" id="L990" title="All 2 branches covered.">      if (i % 2 == 0) {</span>
<span class="fc" id="L991">        slf.setResult(null);</span>
      }
    }
    
<span class="fc" id="L995">    FutureUtils.cancelIncompleteFutures(futures, false);</span>

<span class="fc bfc" id="L997" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L998">      SettableListenableFuture&lt;?&gt; slf = futures.get(i);</span>
<span class="fc" id="L999">      assertTrue(slf.isDone());</span>
<span class="fc bfc" id="L1000" title="All 2 branches covered.">      if (i % 2 == 0) {</span>
<span class="fc" id="L1001">        slf.get();</span>
        // should not throw as was completed normally
      } else {
<span class="fc" id="L1004">        assertTrue(slf.isCancelled());</span>
      }
    }
<span class="fc" id="L1007">  }</span>
  
  @Test
  public void cancelIncompleteFuturesIfAnyFailTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L1011">    List&lt;SettableListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L1012" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L1013">      SettableListenableFuture&lt;?&gt; slf = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L1014">      futures.add(slf);</span>
<span class="fc bfc" id="L1015" title="All 2 branches covered.">      if (i % 2 == 0) {</span>
<span class="fc" id="L1016">        slf.setResult(null);</span>
      }
    }
    
<span class="fc" id="L1020">    FutureUtils.cancelIncompleteFuturesIfAnyFail(false, futures, false);</span>
    
    // fail one future
<span class="fc" id="L1023">    futures.get(1).setFailure(null);</span>

<span class="fc bfc" id="L1025" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L1026">      SettableListenableFuture&lt;?&gt; slf = futures.get(i);</span>
<span class="fc" id="L1027">      assertTrue(slf.isDone());</span>
<span class="fc bfc" id="L1028" title="All 2 branches covered.">      if (i % 2 == 0) {</span>
<span class="fc" id="L1029">        slf.get();</span>
        // should not throw as was completed normally
<span class="fc bfc" id="L1031" title="All 2 branches covered.">      } else if (i != 1) {  // skip manually failed future</span>
<span class="fc" id="L1032">        assertTrue(slf.isCancelled());</span>
      }
    }
<span class="fc" id="L1035">  }</span>
  
  @Test
  public void cancelIncompleteFuturesIfAnyFailCancelTest() {
<span class="fc" id="L1039">    List&lt;SettableListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L1040" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L1041">      futures.add(new SettableListenableFuture&lt;&gt;());</span>
    }
    
<span class="fc" id="L1044">    FutureUtils.cancelIncompleteFuturesIfAnyFail(false, futures, false);</span>
    
    // cancel one future
<span class="fc" id="L1047">    assertTrue(futures.get(1).cancel(false));</span>

<span class="fc bfc" id="L1049" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L1050">      assertTrue(futures.get(i).isCancelled());</span>
    }
<span class="fc" id="L1052">  }</span>
  
  @Test
  public void cancelIncompleteFuturesIfAnyFailCopyTest() {
<span class="fc" id="L1056">    List&lt;SettableListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;(TEST_QTY);</span>
<span class="fc bfc" id="L1057" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L1058">      futures.add(new SettableListenableFuture&lt;&gt;());</span>
    }
    
<span class="fc" id="L1061">    FutureUtils.cancelIncompleteFuturesIfAnyFail(true, futures, false);</span>
    
    // copy and clear futures
<span class="fc" id="L1064">    List&lt;SettableListenableFuture&lt;?&gt;&gt; futuresCopy = new ArrayList&lt;&gt;(futures);</span>
<span class="fc" id="L1065">    futures.clear();</span>
    // cancel one future
<span class="fc" id="L1067">    assertTrue(futuresCopy.get(1).cancel(false));</span>

<span class="fc bfc" id="L1069" title="All 2 branches covered.">    for (int i = 0; i &lt; TEST_QTY; i++) {</span>
<span class="fc" id="L1070">      assertTrue(futuresCopy.get(i).isCancelled());</span>
    }
<span class="fc" id="L1072">  }</span>
  
  @Test
  public void immediateResultFutureNullResultTest() throws InterruptedException, ExecutionException, TimeoutException {
<span class="fc" id="L1076">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateResultFuture(null);</span>
    
<span class="fc" id="L1078">    ImmediateListenableFutureTest.resultTest(testFuture, null);</span>
<span class="pc bpc" id="L1079" title="1 of 2 branches missed.">    assertTrue(testFuture == ImmediateResultListenableFuture.NULL_RESULT);</span>
<span class="fc" id="L1080">  }</span>
  
  @Test
  public void immediateResultFutureTest() throws InterruptedException, ExecutionException, TimeoutException {
<span class="fc" id="L1084">    Object result = new Object();</span>
<span class="fc" id="L1085">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateResultFuture(result);</span>
    
<span class="fc" id="L1087">    ImmediateListenableFutureTest.resultTest(testFuture, result);</span>
<span class="fc" id="L1088">  }</span>
  
  @Test
  public void immediateResultFutureCancelTest() {
<span class="fc" id="L1092">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateResultFuture(null);</span>
    
<span class="fc" id="L1094">    ImmediateListenableFutureTest.cancelTest(testFuture);</span>
<span class="fc" id="L1095">  }</span>
  
  @Test
  public void immediateResultFutureAddListenerTest() {
<span class="fc" id="L1099">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateResultFuture(null);</span>
    
<span class="fc" id="L1101">    ImmediateListenableFutureTest.addListenerTest(testFuture);</span>
<span class="fc" id="L1102">  }</span>
  
  @Test
  public void immediateResultFutureAddCallbackTest() {
<span class="fc" id="L1106">    Object result = new Object();</span>
<span class="fc" id="L1107">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateResultFuture(result);</span>
    
<span class="fc" id="L1109">    ImmediateListenableFutureTest.resultAddCallbackTest(testFuture, result);</span>
<span class="fc" id="L1110">  }</span>
  
  @Test
  public void immediateFailureFutureTest() {
<span class="fc" id="L1114">    Exception failure = new Exception();</span>
<span class="fc" id="L1115">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateFailureFuture(failure);</span>
    
<span class="fc" id="L1117">    ImmediateListenableFutureTest.failureTest(testFuture, failure);</span>
<span class="fc" id="L1118">  }</span>
  
  @Test
  public void immediateFailureFutureCancelTest() {
<span class="fc" id="L1122">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateFailureFuture(null);</span>
    
<span class="fc" id="L1124">    ImmediateListenableFutureTest.cancelTest(testFuture);</span>
<span class="fc" id="L1125">  }</span>
  
  @Test
  public void immediateFailureFutureAddListenerTest() {
<span class="fc" id="L1129">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateFailureFuture(null);</span>
    
<span class="fc" id="L1131">    ImmediateListenableFutureTest.addListenerTest(testFuture);</span>
<span class="fc" id="L1132">  }</span>
  
  @Test
  public void immediateFailureFutureAddCallbackTest() {
<span class="fc" id="L1136">    Throwable failure = new Exception();</span>
<span class="fc" id="L1137">    ListenableFuture&lt;?&gt; testFuture = FutureUtils.immediateFailureFuture(failure);</span>
    
<span class="fc" id="L1139">    ImmediateListenableFutureTest.failureAddCallbackTest(testFuture, failure);</span>
<span class="fc" id="L1140">  }</span>

  @Test
  public void immediateResultFutureListenerOptimizeListenerExecutorTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L1144">    ListenableFutureInterfaceTest.optimizeDoneListenerExecutorTest(FutureUtils.immediateResultFuture(null));</span>
<span class="fc" id="L1145">  }</span>

  @Test
  public void immediateResultFutureDontOptimizeListenerExecutorTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L1149">    ListenableFutureInterfaceTest.dontOptimizeDoneListenerExecutorTest(FutureUtils.immediateResultFuture(null));</span>
<span class="fc" id="L1150">  }</span>

  @Test
  public void immediateFailureFutureListenerOptimizeListenerExecutorTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L1154">    ListenableFutureInterfaceTest.optimizeDoneListenerExecutorTest(FutureUtils.immediateFailureFuture(null));</span>
<span class="fc" id="L1155">  }</span>

  @Test
  public void immediateFailureFutureDontOptimizeListenerExecutorTest() throws InterruptedException, TimeoutException {
<span class="fc" id="L1159">    ListenableFutureInterfaceTest.dontOptimizeDoneListenerExecutorTest(FutureUtils.immediateFailureFuture(null));</span>
<span class="fc" id="L1160">  }</span>
  
  @Test
  public void scheduleWhileTaskResultNullFirstRunInThreadTest() throws Exception {
<span class="fc" id="L1164">    int scheduleDelayMillis = 10;</span>
<span class="fc" id="L1165">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1166">    Object result = new Object();</span>
    @SuppressWarnings(&quot;deprecation&quot;)
<span class="fc" id="L1168">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1169">        FutureUtils.scheduleWhileTaskResultNull(scheduler, scheduleDelayMillis, false, </span>
<span class="fc" id="L1170">                                                new Callable&lt;Object&gt;() {</span>
<span class="fc" id="L1171">      private boolean first = true;</span>
      @Override
      public Object call() throws Exception {
<span class="fc bfc" id="L1174" title="All 2 branches covered.">        if (first) {</span>
<span class="fc" id="L1175">          first = false;</span>
<span class="fc" id="L1176">          return null;</span>
        } else {
<span class="fc" id="L1178">          return result;</span>
        }
      }
    });

<span class="fc" id="L1183">    assertFalse(f.isDone());</span>
<span class="fc" id="L1184">    assertEquals(1, scheduler.advance(scheduleDelayMillis));</span>
<span class="fc" id="L1185">    assertTrue(f.isDone());</span>
<span class="pc bpc" id="L1186" title="1 of 2 branches missed.">    assertTrue(result == f.get());</span>
<span class="fc" id="L1187">  }</span>
  
  @Test
  public void scheduleWhileTaskResultNullFirstRunOnSchedulerTest() throws Exception {
<span class="fc" id="L1191">    int scheduleDelayMillis = 10;</span>
<span class="fc" id="L1192">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1193">    Object result = new Object();</span>
    @SuppressWarnings(&quot;deprecation&quot;)
<span class="fc" id="L1195">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1196">        FutureUtils.scheduleWhileTaskResultNull(scheduler, scheduleDelayMillis, true, </span>
<span class="fc" id="L1197">                                                new Callable&lt;Object&gt;() {</span>
<span class="fc" id="L1198">      private boolean first = true;</span>
      @Override
      public Object call() throws Exception {
<span class="fc bfc" id="L1201" title="All 2 branches covered.">        if (first) {</span>
<span class="fc" id="L1202">          first = false;</span>
<span class="fc" id="L1203">          return null;</span>
        } else {
<span class="fc" id="L1205">          return result;</span>
        }
      }
    });

<span class="fc" id="L1210">    assertFalse(f.isDone());</span>
<span class="fc" id="L1211">    assertEquals(1, scheduler.tick());  // first run async</span>
<span class="fc" id="L1212">    assertFalse(f.isDone());</span>
<span class="fc" id="L1213">    assertEquals(1, scheduler.advance(scheduleDelayMillis));</span>
<span class="fc" id="L1214">    assertTrue(f.isDone());</span>
<span class="pc bpc" id="L1215" title="1 of 2 branches missed.">    assertTrue(result == f.get());</span>
<span class="fc" id="L1216">  }</span>
  
  @Test
  public void scheduleWhileTaskResultNullTaskFailureInThreadTest() throws InterruptedException {
<span class="fc" id="L1220">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1221">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
    @SuppressWarnings(&quot;deprecation&quot;)
<span class="fc" id="L1223">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1224">        FutureUtils.scheduleWhileTaskResultNull(scheduler, 10, false, () -&gt; { throw failure; });</span>
    
<span class="fc" id="L1226">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1228">      f.get();</span>
<span class="nc" id="L1229">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1230">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1231" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1232">    }</span>
<span class="fc" id="L1233">  }</span>
  
  @Test
  public void scheduleWhileTaskResultNullTaskFailureOnSchedulerTest() throws InterruptedException {
<span class="fc" id="L1237">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1238">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
    @SuppressWarnings(&quot;deprecation&quot;)
<span class="fc" id="L1240">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1241">        FutureUtils.scheduleWhileTaskResultNull(scheduler, 10, true, () -&gt; { throw failure; });</span>

<span class="fc" id="L1243">    assertFalse(f.isDone());</span>
<span class="fc" id="L1244">    assertEquals(1, scheduler.tick());  // first run async</span>
<span class="fc" id="L1245">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1247">      f.get();</span>
<span class="nc" id="L1248">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1249">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1250" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1251">    }</span>
<span class="fc" id="L1252">  }</span>
  
  @Test
  public void scheduleWhileTaskResultNullTimeoutTest() throws Exception {
<span class="fc" id="L1256">    SingleThreadScheduler scheduler = new SingleThreadScheduler();</span>
    try {
      @SuppressWarnings(&quot;deprecation&quot;)
<span class="fc" id="L1259">      ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1260">          FutureUtils.scheduleWhileTaskResultNull(scheduler, 2, true, () -&gt; null, DELAY_TIME);</span>
      
<span class="fc" id="L1262">      assertNull(f.get(DELAY_TIME + 1_000, TimeUnit.MILLISECONDS));</span>
    } finally {
<span class="fc" id="L1264">      scheduler.shutdownNow();</span>
    }
<span class="fc" id="L1266">  }</span>
  
  @Test
  public void scheduleWhileTaskResultNullCancelReturnedFutureTest() {
<span class="fc" id="L1270">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1271">    AtomicInteger runCount = new AtomicInteger();</span>
    @SuppressWarnings(&quot;deprecation&quot;)
<span class="fc" id="L1273">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1274">        FutureUtils.scheduleWhileTaskResultNull(scheduler, 1, false, () -&gt; {</span>
<span class="fc" id="L1275">          runCount.incrementAndGet();</span>
<span class="fc" id="L1276">          return null;</span>
        });
    
<span class="fc" id="L1279">    assertEquals(1, scheduler.advance(1));</span>
<span class="fc" id="L1280">    int startCount = runCount.get();</span>
<span class="fc" id="L1281">    f.cancel(false);</span>
<span class="fc" id="L1282">    assertEquals(1, scheduler.advance(1));  // should be task realizing it was canceled</span>
    // verify task did not run
<span class="fc" id="L1284">    assertEquals(startCount, runCount.get());</span>
<span class="fc" id="L1285">    assertEquals(0, scheduler.advance(100));  // should never run again</span>
<span class="fc" id="L1286">  }</span>
  
  @Test
  public void scheduleWhileFirstRunInThreadTest() throws Exception {
<span class="fc" id="L1290">    int scheduleDelayMillis = 10;</span>
<span class="fc" id="L1291">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1292">    Optional&lt;Object&gt; result = Optional.of(new Object());</span>
<span class="fc" id="L1293">    ListenableFuture&lt;?&gt; f = FutureUtils.scheduleWhile(scheduler, scheduleDelayMillis, false, </span>
<span class="fc" id="L1294">                                                      new Callable&lt;Optional&lt;Object&gt;&gt;() {</span>
<span class="fc" id="L1295">      private boolean first = true;</span>
      @Override
      public Optional&lt;Object&gt; call() throws Exception {
<span class="fc bfc" id="L1298" title="All 2 branches covered.">        if (first) {</span>
<span class="fc" id="L1299">          first = false;</span>
<span class="fc" id="L1300">          return Optional.empty();</span>
        } else {
<span class="fc" id="L1302">          return result;</span>
        }
      }
<span class="fc bfc" id="L1305" title="All 2 branches covered.">    }, (o) -&gt; ! o.isPresent());</span>

<span class="fc" id="L1307">    assertFalse(f.isDone());</span>
<span class="fc" id="L1308">    assertEquals(1, scheduler.advance(scheduleDelayMillis));</span>
<span class="fc" id="L1309">    assertTrue(f.isDone());</span>
<span class="pc bpc" id="L1310" title="1 of 2 branches missed.">    assertTrue(result == f.get());</span>
<span class="fc" id="L1311">  }</span>
  
  @Test
  public void scheduleWhileFirstRunOnSchedulerTest() throws Exception {
<span class="fc" id="L1315">    int scheduleDelayMillis = 10;</span>
<span class="fc" id="L1316">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1317">    Optional&lt;Object&gt; result = Optional.of(new Object());</span>
<span class="fc" id="L1318">    ListenableFuture&lt;?&gt; f = FutureUtils.scheduleWhile(scheduler, scheduleDelayMillis, true, </span>
<span class="fc" id="L1319">                                                      new Callable&lt;Optional&lt;Object&gt;&gt;() {</span>
<span class="fc" id="L1320">      private boolean first = true;</span>
      
      @Override
      public Optional&lt;Object&gt; call() throws Exception {
<span class="fc bfc" id="L1324" title="All 2 branches covered.">        if (first) {</span>
<span class="fc" id="L1325">          first = false;</span>
<span class="fc" id="L1326">          return Optional.empty();</span>
        } else {
<span class="fc" id="L1328">          return result;</span>
        }
      }
<span class="fc bfc" id="L1331" title="All 2 branches covered.">    }, (o) -&gt; ! o.isPresent());</span>

<span class="fc" id="L1333">    assertFalse(f.isDone());</span>
<span class="fc" id="L1334">    assertEquals(1, scheduler.tick());  // first run async</span>
<span class="fc" id="L1335">    assertFalse(f.isDone());</span>
<span class="fc" id="L1336">    assertEquals(1, scheduler.advance(scheduleDelayMillis));</span>
<span class="fc" id="L1337">    assertTrue(f.isDone());</span>
<span class="pc bpc" id="L1338" title="1 of 2 branches missed.">    assertTrue(result == f.get());</span>
<span class="fc" id="L1339">  }</span>
  
  @Test
  public void scheduleWhileTaskFailureInThreadTest() throws InterruptedException {
<span class="fc" id="L1343">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1344">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1345">    ListenableFuture&lt;?&gt; f = </span>
<span class="pc" id="L1346">        FutureUtils.scheduleWhile(scheduler, 10, false, () -&gt; { throw failure; }, (o) -&gt; false);</span>
    
<span class="fc" id="L1348">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1350">      f.get();</span>
<span class="nc" id="L1351">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1352">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1353" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1354">    }</span>
<span class="fc" id="L1355">  }</span>
  
  @Test
  public void scheduleWhileTaskFailureOnSchedulerTest() throws InterruptedException {
<span class="fc" id="L1359">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1360">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1361">    ListenableFuture&lt;?&gt; f = </span>
<span class="pc" id="L1362">        FutureUtils.scheduleWhile(scheduler, 10, true, () -&gt; { throw failure; }, (o) -&gt; false);</span>

<span class="fc" id="L1364">    assertFalse(f.isDone());</span>
<span class="fc" id="L1365">    assertEquals(1, scheduler.tick());  // first run async</span>
<span class="fc" id="L1366">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1368">      f.get();</span>
<span class="nc" id="L1369">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1370">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1371" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1372">    }</span>
<span class="fc" id="L1373">  }</span>
  
  @Test
  public void scheduleWhileTimeoutWithResultTest() throws Exception {
<span class="fc" id="L1377">    SingleThreadScheduler scheduler = new SingleThreadScheduler();</span>
    try {
<span class="fc" id="L1379">      ListenableFuture&lt;Optional&lt;?&gt;&gt; f = </span>
<span class="fc" id="L1380">          FutureUtils.scheduleWhile(scheduler, 2, true, () -&gt; Optional.empty(), </span>
<span class="pc bpc" id="L1381" title="1 of 2 branches missed.">                                    (o) -&gt; ! o.isPresent(), DELAY_TIME, true);</span>
      
<span class="fc" id="L1383">      assertFalse(f.get(DELAY_TIME + 1_000, TimeUnit.MILLISECONDS).isPresent());</span>
    } finally {
<span class="fc" id="L1385">      scheduler.shutdownNow();</span>
    }
<span class="fc" id="L1387">  }</span>
  
  @Test
  public void scheduleWhileTimeoutWithExceptionTest() throws Exception {
<span class="fc" id="L1391">    SingleThreadScheduler scheduler = new SingleThreadScheduler();</span>
    try {
<span class="fc" id="L1393">      ListenableFuture&lt;Optional&lt;?&gt;&gt; f = </span>
<span class="fc" id="L1394">          FutureUtils.scheduleWhile(scheduler, 2, true, () -&gt; Optional.empty(), </span>
<span class="pc bpc" id="L1395" title="1 of 2 branches missed.">                                    (o) -&gt; ! o.isPresent(), DELAY_TIME, false);</span>
      
      try {
<span class="nc" id="L1398">        f.get(DELAY_TIME + 1_000, TimeUnit.MILLISECONDS);</span>
<span class="nc" id="L1399">        fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1400">      } catch (ExecutionException e) {</span>
        // expected
<span class="fc" id="L1402">        assertTrue(e.getCause() instanceof TimeoutException);</span>
<span class="nc" id="L1403">      }</span>
    } finally {
<span class="fc" id="L1405">      scheduler.shutdownNow();</span>
    }
<span class="fc" id="L1407">  }</span>
  
  @Test
  public void scheduleWhilePredicateThrowsInThreadTest() throws InterruptedException {
<span class="fc" id="L1411">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1412">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1413">    ListenableFuture&lt;Object&gt; f = </span>
<span class="fc" id="L1414">        FutureUtils.scheduleWhile(scheduler, 2, false, () -&gt; null, (o) -&gt; { throw failure; });</span>
    
<span class="fc" id="L1416">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1418">      f.get();</span>
<span class="nc" id="L1419">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1420">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1421" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1422">    }</span>
<span class="fc" id="L1423">  }</span>
  
  @Test
  public void scheduleWhilePredicateThrowsOnSchedulerTest() throws InterruptedException {
<span class="fc" id="L1427">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1428">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1429">    ListenableFuture&lt;Object&gt; f = </span>
<span class="fc" id="L1430">        FutureUtils.scheduleWhile(scheduler, 2, true, () -&gt; null, (o) -&gt; { throw failure; });</span>

<span class="fc" id="L1432">    assertFalse(f.isDone());</span>
<span class="fc" id="L1433">    assertEquals(1, scheduler.tick());</span>
<span class="fc" id="L1434">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1436">      f.get();</span>
<span class="nc" id="L1437">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1438">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1439" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1440">    }</span>
<span class="fc" id="L1441">  }</span>
  
  @Test
  public void scheduleWhileAlreadyDoneWithFinalResultTest() throws Exception {
<span class="fc" id="L1445">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1446">    Object result = new Object();</span>
<span class="fc" id="L1447">    ListenableFuture&lt;Object&gt; f = </span>
<span class="fc" id="L1448">        FutureUtils.scheduleWhile(scheduler, 2, FutureUtils.immediateResultFuture(result), </span>
<span class="pc" id="L1449">                                  () -&gt; result, (o) -&gt; false);</span>
    
<span class="fc" id="L1451">    assertTrue(f.isDone());</span>
<span class="pc bpc" id="L1452" title="1 of 2 branches missed.">    assertTrue(result == f.get());</span>
<span class="fc" id="L1453">  }</span>
  
  @Test
  public void scheduleWhileAlreadyDoneWithFailureTest() throws InterruptedException {
<span class="fc" id="L1457">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1458">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1459">    ListenableFuture&lt;Object&gt; f = </span>
<span class="fc" id="L1460">        FutureUtils.scheduleWhile(scheduler, 2, FutureUtils.immediateFailureFuture(failure), </span>
<span class="nc" id="L1461">                                  () -&gt; null, (o) -&gt; false);</span>
    
<span class="fc" id="L1463">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1465">      f.get();</span>
<span class="nc" id="L1466">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1467">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1468" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1469">    }</span>
<span class="fc" id="L1470">  }</span>
  
  @Test
  public void scheduleWhileAlreadyDoneCanceledTest() {
<span class="fc" id="L1474">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1475">    SettableListenableFuture&lt;?&gt; startingFuture = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L1476">    startingFuture.cancel(false);</span>
<span class="fc" id="L1477">    ListenableFuture&lt;Object&gt; f = </span>
<span class="pc" id="L1478">        FutureUtils.scheduleWhile(scheduler, 2, startingFuture, () -&gt; null, (o) -&gt; false);</span>
    
<span class="fc" id="L1480">    assertTrue(f.isDone());</span>
<span class="fc" id="L1481">    assertTrue(f.isCancelled());</span>
<span class="fc" id="L1482">  }</span>
  
  @Test
  public void scheduleWhileCancelReturnedFutureTest() {
<span class="fc" id="L1486">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1487">    AtomicInteger runCount = new AtomicInteger();</span>
<span class="fc" id="L1488">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1489">        FutureUtils.scheduleWhile(scheduler, 1, false, () -&gt; {</span>
<span class="fc" id="L1490">          runCount.incrementAndGet();</span>
<span class="fc" id="L1491">          return null;</span>
<span class="fc" id="L1492">        }, (o) -&gt; true);</span>
    
<span class="fc" id="L1494">    assertEquals(1, scheduler.advance(1));</span>
<span class="fc" id="L1495">    int startCount = runCount.get();</span>
<span class="fc" id="L1496">    f.cancel(false);</span>
<span class="fc" id="L1497">    assertEquals(1, scheduler.advance(1));  // should be task realizing it was canceled</span>
    // verify task did not run
<span class="fc" id="L1499">    assertEquals(startCount, runCount.get());</span>
<span class="fc" id="L1500">    assertEquals(0, scheduler.advance(100));  // should never run again</span>
<span class="fc" id="L1501">  }</span>
  
  @Test
  public void runnableScheduleWhileFirstRunInThreadTest() throws Exception {
<span class="fc" id="L1505">    int scheduleDelayMillis = 10;</span>
<span class="fc" id="L1506">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1507">    TestRunnable tr = new TestRunnable();</span>
<span class="fc" id="L1508">    ListenableFuture&lt;?&gt; f = FutureUtils.scheduleWhile(scheduler, scheduleDelayMillis, false, </span>
<span class="fc bfc" id="L1509" title="All 2 branches covered.">                                                      tr, () -&gt; tr.getRunCount() &lt; 2);</span>

<span class="fc" id="L1511">    assertFalse(f.isDone());</span>
<span class="fc" id="L1512">    assertEquals(1, scheduler.advance(scheduleDelayMillis));</span>
<span class="fc" id="L1513">    assertTrue(f.isDone());</span>
<span class="fc" id="L1514">    assertNull(f.get());  // verify no error state</span>
<span class="fc" id="L1515">  }</span>
  
  @Test
  public void runnableScheduleWhileFirstRunOnSchedulerTest() throws Exception {
<span class="fc" id="L1519">    int scheduleDelayMillis = 10;</span>
<span class="fc" id="L1520">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1521">    TestRunnable tr = new TestRunnable();</span>
<span class="fc" id="L1522">    ListenableFuture&lt;?&gt; f = FutureUtils.scheduleWhile(scheduler, scheduleDelayMillis, true, </span>
<span class="fc bfc" id="L1523" title="All 2 branches covered.">                                                      tr, () -&gt; tr.getRunCount() &lt; 2);</span>

<span class="fc" id="L1525">    assertFalse(f.isDone());</span>
<span class="fc" id="L1526">    assertEquals(1, scheduler.tick());  // first run async</span>
<span class="fc" id="L1527">    assertFalse(f.isDone());</span>
<span class="fc" id="L1528">    assertEquals(1, scheduler.advance(scheduleDelayMillis));</span>
<span class="fc" id="L1529">    assertTrue(f.isDone());</span>
<span class="fc" id="L1530">    assertNull(f.get());  // verify no error state</span>
<span class="fc" id="L1531">  }</span>
  
  @Test
  public void runnableScheduleWhileTaskFailureInThreadTest() throws InterruptedException {
<span class="fc" id="L1535">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1536">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1537">    ListenableFuture&lt;?&gt; f = </span>
<span class="pc" id="L1538">        FutureUtils.scheduleWhile(scheduler, 10, false, () -&gt; { throw failure; }, () -&gt; false);</span>
    
<span class="fc" id="L1540">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1542">      f.get();</span>
<span class="nc" id="L1543">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1544">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1545" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1546">    }</span>
<span class="fc" id="L1547">  }</span>
  
  @Test
  public void runnableScheduleWhileTaskFailureOnSchedulerTest() throws InterruptedException {
<span class="fc" id="L1551">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1552">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1553">    ListenableFuture&lt;?&gt; f = </span>
<span class="pc" id="L1554">        FutureUtils.scheduleWhile(scheduler, 10, true, () -&gt; { throw failure; }, () -&gt; false);</span>

<span class="fc" id="L1556">    assertFalse(f.isDone());</span>
<span class="fc" id="L1557">    assertEquals(1, scheduler.tick());  // first run async</span>
<span class="fc" id="L1558">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1560">      f.get();</span>
<span class="nc" id="L1561">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1562">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1563" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1564">    }</span>
<span class="fc" id="L1565">  }</span>
  
  @Test
  public void runnableScheduleWhileTimeoutTest() throws Exception {
<span class="fc" id="L1569">    SingleThreadScheduler scheduler = new SingleThreadScheduler();</span>
    try {
<span class="fc" id="L1571">      ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1572">          FutureUtils.scheduleWhile(scheduler, 2, true, DoNothingRunnable.instance(), </span>
<span class="fc" id="L1573">                                    () -&gt; true, DELAY_TIME);</span>
      
      try {
<span class="nc" id="L1576">        f.get(DELAY_TIME + 1_000, TimeUnit.MILLISECONDS);</span>
<span class="nc" id="L1577">        fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1578">      } catch (ExecutionException e) {</span>
        // expected
<span class="fc" id="L1580">        assertTrue(e.getCause() instanceof TimeoutException);</span>
<span class="nc" id="L1581">      }</span>
    } finally {
<span class="fc" id="L1583">      scheduler.shutdownNow();</span>
    }
<span class="fc" id="L1585">  }</span>
  
  @Test
  public void runnableScheduleWhilePredicateThrowsInThreadTest() throws InterruptedException {
<span class="fc" id="L1589">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1590">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1591">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1592">        FutureUtils.scheduleWhile(scheduler, 2, false, DoNothingRunnable.instance(), () -&gt; { throw failure; });</span>
    
<span class="fc" id="L1594">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1596">      f.get();</span>
<span class="nc" id="L1597">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1598">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1599" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1600">    }</span>
<span class="fc" id="L1601">  }</span>
  
  @Test
  public void runnableScheduleWhilePredicateThrowsOnSchedulerTest() throws InterruptedException {
<span class="fc" id="L1605">    TestableScheduler scheduler = new TestableScheduler();</span>
<span class="fc" id="L1606">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1607">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1608">        FutureUtils.scheduleWhile(scheduler, 2, true, DoNothingRunnable.instance(), () -&gt; { throw failure; });</span>

<span class="fc" id="L1610">    assertFalse(f.isDone());</span>
<span class="fc" id="L1611">    assertEquals(1, scheduler.tick());</span>
<span class="fc" id="L1612">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1614">      f.get();</span>
<span class="nc" id="L1615">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1616">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1617" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1618">    }</span>
<span class="fc" id="L1619">  }</span>
  
  @Test
  public void scheduleWhileGetRunningStackTraceTest() {
<span class="fc" id="L1623">    SingleThreadScheduler sts = new SingleThreadScheduler();</span>
<span class="fc" id="L1624">    BlockingTestRunnable btr = new BlockingTestRunnable();</span>
<span class="fc" id="L1625">    ListenableFuture&lt;Boolean&gt; future = </span>
<span class="fc" id="L1626">        FutureUtils.scheduleWhile(sts, 0, </span>
<span class="fc" id="L1627">                                  sts.submitScheduled(() -&gt; { return true; }, DELAY_TIME), </span>
                                  () -&gt; { 
<span class="fc" id="L1629">                                    btr.run();</span>
<span class="fc" id="L1630">                                    return false;</span>
                                  }, 
<span class="fc" id="L1632">                                  (loop) -&gt; loop);</span>
    try {
<span class="fc" id="L1634">      btr.blockTillStarted();</span>
      
<span class="fc" id="L1636">      StackTraceElement[] stack = future.getRunningStackTrace();</span>
<span class="fc" id="L1637">      assertNotNull(stack);</span>
<span class="fc" id="L1638">      assertEquals(BlockingTestRunnable.class.getName(), stack[2].getClassName());</span>
    } finally {
<span class="fc" id="L1640">      btr.unblock();</span>
<span class="fc" id="L1641">      sts.shutdown();</span>
    }
<span class="fc" id="L1643">  }</span>
  
  @Test
  public void executeWhileTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L1647">    AtomicInteger ai = new AtomicInteger();</span>
<span class="fc" id="L1648">    ListenableFuture&lt;Integer&gt; f = </span>
<span class="fc" id="L1649">        FutureUtils.executeWhile(() -&gt; FutureUtils.immediateResultFuture(ai.getAndIncrement()), </span>
<span class="fc bfc" id="L1650" title="All 2 branches covered.">                                 (i) -&gt; i &lt; 10);</span>

<span class="fc" id="L1652">    assertTrue(f.isDone());</span>
<span class="fc" id="L1653">    assertEquals(10, f.get().intValue());</span>
<span class="fc" id="L1654">  }</span>
  
  @Test
  public void executeWhileThreadedTest() throws InterruptedException, ExecutionException {
<span class="fc" id="L1658">    SingleThreadScheduler scheduler = new SingleThreadScheduler();</span>
    try {
<span class="fc" id="L1660">      AtomicInteger ai = new AtomicInteger();</span>
<span class="fc" id="L1661">      ListenableFuture&lt;Integer&gt; f = </span>
<span class="fc" id="L1662">          FutureUtils.executeWhile(() -&gt; scheduler.submitScheduled(ai::getAndIncrement, 1), </span>
<span class="fc bfc" id="L1663" title="All 2 branches covered.">                                   (i) -&gt; i &lt; 10);</span>
  
<span class="fc" id="L1665">      assertEquals(10, f.get().intValue());</span>
    } finally {
<span class="fc" id="L1667">      scheduler.shutdown();</span>
    }
<span class="fc" id="L1669">  }</span>
  
  @Test
  public void executeWhileTaskFailureTest() throws InterruptedException {
<span class="fc" id="L1673">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1674">    ListenableFuture&lt;?&gt; f = </span>
<span class="fc" id="L1675">        FutureUtils.executeWhile(FutureUtils.immediateResultFuture(null), </span>
<span class="fc" id="L1676">                                 () -&gt; { throw failure; }, </span>
<span class="fc" id="L1677">                                 (o) -&gt; true);</span>

<span class="fc" id="L1679">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1681">      f.get();</span>
<span class="nc" id="L1682">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1683">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1684" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1685">    }</span>
<span class="fc" id="L1686">  }</span>
  
  @Test
  public void executeWhileTimeoutWithResultTest() throws Exception {
<span class="fc" id="L1690">    ListenableFuture&lt;Optional&lt;?&gt;&gt; f = </span>
<span class="fc" id="L1691">        FutureUtils.executeWhile(() -&gt; FutureUtils.immediateResultFuture(Optional.empty()), </span>
<span class="pc bpc" id="L1692" title="1 of 2 branches missed.">                                 (o) -&gt; ! o.isPresent(), DELAY_TIME, true);</span>
<span class="fc" id="L1693">    assertNotNull(f.get());</span>
<span class="fc" id="L1694">    assertFalse(f.get(DELAY_TIME + 1_000, TimeUnit.MILLISECONDS).isPresent());</span>
<span class="fc" id="L1695">  }</span>
  
  @Test
  public void executeWhileTimeoutWithExceptionTest() throws Exception {
<span class="fc" id="L1699">    ListenableFuture&lt;Optional&lt;?&gt;&gt; f = </span>
<span class="fc" id="L1700">        FutureUtils.executeWhile(() -&gt; FutureUtils.immediateResultFuture(Optional.empty()), </span>
<span class="pc bpc" id="L1701" title="1 of 2 branches missed.">                                 (o) -&gt; ! o.isPresent(), DELAY_TIME, false);</span>
      
    try {
<span class="nc" id="L1704">      f.get(DELAY_TIME + 1_000, TimeUnit.MILLISECONDS);</span>
<span class="nc" id="L1705">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1706">    } catch (ExecutionException e) {</span>
      // expected
<span class="fc" id="L1708">      assertTrue(e.getCause() instanceof TimeoutException);</span>
<span class="nc" id="L1709">    }</span>
<span class="fc" id="L1710">  }</span>
  
  @Test
  public void executeWhilePredicateThrowsTest() throws InterruptedException {
<span class="fc" id="L1714">    RuntimeException failure = new SuppressedStackRuntimeException();</span>
<span class="fc" id="L1715">    ListenableFuture&lt;Object&gt; f = </span>
<span class="fc" id="L1716">        FutureUtils.executeWhile(() -&gt; FutureUtils.immediateResultFuture(null), (o) -&gt; { throw failure; });</span>
    
<span class="fc" id="L1718">    assertTrue(f.isDone());</span>
    try {
<span class="nc" id="L1720">      f.get();</span>
<span class="nc" id="L1721">      fail(&quot;Exception should have thrown&quot;);</span>
<span class="fc" id="L1722">    } catch (ExecutionException e) {</span>
<span class="pc bpc" id="L1723" title="1 of 2 branches missed.">      assertTrue(e.getCause() == failure);</span>
<span class="nc" id="L1724">    }</span>
<span class="fc" id="L1725">  }</span>
  
  @Test
  public void executeWhileGetRunningStackTraceTest() {
<span class="fc" id="L1729">    SettableListenableFuture&lt;Boolean&gt; startingFuture = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L1730">    SettableListenableFuture&lt;Boolean&gt; runningFuture = new SettableListenableFuture&lt;&gt;();</span>
<span class="fc" id="L1731">    ListenableFuture&lt;Boolean&gt; future = </span>
<span class="fc" id="L1732">        FutureUtils.executeWhile(startingFuture, </span>
<span class="fc" id="L1733">                                 () -&gt; runningFuture, </span>
<span class="fc" id="L1734">                                 (loop) -&gt; loop);</span>
    try {
<span class="fc" id="L1736">      startingFuture.setResult(true); // loop to running future</span>
<span class="fc" id="L1737">      runningFuture.setRunningThread(Thread.currentThread());</span>

<span class="fc" id="L1739">      StackTraceElement[] stack = future.getRunningStackTrace();</span>
<span class="fc" id="L1740">      assertNotNull(stack);</span>
<span class="fc" id="L1741">      assertEquals(this.getClass().getName(), stack[3].getClassName());</span>
    } finally {
<span class="fc" id="L1743">      runningFuture.setResult(false);</span>
    }
<span class="fc" id="L1745">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>