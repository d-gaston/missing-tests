<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SparseGradientTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">commons_math4$All_in_commons_math4.exec</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.math4.analysis.differentiation</a> &gt; <span class="el_source">SparseGradientTest.java</span></div><h1>SparseGradientTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.math4.analysis.differentiation;

import java.util.Arrays;
import java.util.List;

import org.apache.commons.math4.ExtendedFieldElementAbstractTest;
import org.apache.commons.math4.TestUtils;
import org.apache.commons.math4.analysis.polynomials.PolynomialFunction;
import org.apache.commons.rng.UniformRandomProvider;
import org.apache.commons.rng.simple.RandomSource;
import org.apache.commons.math4.util.FastMath;
import org.junit.Assert;
import org.junit.Test;

<span class="fc" id="L31">public class SparseGradientTest extends ExtendedFieldElementAbstractTest&lt;SparseGradient&gt; {</span>

    @Override
    protected SparseGradient build(final double x) {
<span class="fc" id="L35">        return SparseGradient.createVariable(0, x);</span>
    }

    @Test
    public void testConstant() {
<span class="fc" id="L40">        double c = 1.0;</span>
<span class="fc" id="L41">        SparseGradient grad = SparseGradient.createConstant(c);</span>
<span class="fc" id="L42">        Assert.assertEquals(c, grad.getValue(), 1.0e-15); // returns the value</span>
<span class="fc" id="L43">        Assert.assertEquals(0, grad.numVars(), 1.0e-15); // has no variables</span>
<span class="fc" id="L44">    }</span>

    @Test
    public void testVariable() {
<span class="fc" id="L48">        double v = 1.0;</span>
<span class="fc" id="L49">        int id = 0;</span>
<span class="fc" id="L50">        SparseGradient grad = SparseGradient.createVariable(id, v);</span>
<span class="fc" id="L51">        Assert.assertEquals(v, grad.getValue(), 1.0e-15); // returns the value</span>
<span class="fc" id="L52">        Assert.assertEquals(1, grad.numVars(), 1.0e-15); // has one variable</span>
<span class="fc" id="L53">        Assert.assertEquals(1.0, grad.getDerivative(id), 1.0e-15); // derivative wr.t itself is 1</span>
<span class="fc" id="L54">    }</span>

    @Test
    public void testVarAddition() {
<span class="fc" id="L58">        final double v1 = 1.0;</span>
<span class="fc" id="L59">        final double v2 = 2.0;</span>
<span class="fc" id="L60">        final int id1 = -1;</span>
<span class="fc" id="L61">        final int id2 = 3;</span>
<span class="fc" id="L62">        final SparseGradient var1 = SparseGradient.createVariable(id1, v1);</span>
<span class="fc" id="L63">        final SparseGradient var2 = SparseGradient.createVariable(id2, v2);</span>
<span class="fc" id="L64">        final SparseGradient sum = var1.add(var2);</span>

<span class="fc" id="L66">        Assert.assertEquals(v1 + v2, sum.getValue(), 1.0e-15); // returns the value</span>
<span class="fc" id="L67">        Assert.assertEquals(2, sum.numVars());</span>
<span class="fc" id="L68">        Assert.assertEquals(1.0, sum.getDerivative(id1), 1.0e-15);</span>
<span class="fc" id="L69">        Assert.assertEquals(1.0, sum.getDerivative(id2), 1.0e-15);</span>
<span class="fc" id="L70">    }</span>

    @Test
    public void testSubtraction() {
<span class="fc" id="L74">        final double v1 = 1.0;</span>
<span class="fc" id="L75">        final double v2 = 2.0;</span>
<span class="fc" id="L76">        final int id1 = -1;</span>
<span class="fc" id="L77">        final int id2 = 3;</span>
<span class="fc" id="L78">        final SparseGradient var1 = SparseGradient.createVariable(id1, v1);</span>
<span class="fc" id="L79">        final SparseGradient var2 = SparseGradient.createVariable(id2, v2);</span>
<span class="fc" id="L80">        final SparseGradient sum = var1.subtract(var2);</span>

<span class="fc" id="L82">        Assert.assertEquals(v1 - v2, sum.getValue(), 1.0e-15); // returns the value</span>
<span class="fc" id="L83">        Assert.assertEquals(2, sum.numVars());</span>
<span class="fc" id="L84">        Assert.assertEquals(1.0, sum.getDerivative(id1), 1.0e-15);</span>
<span class="fc" id="L85">        Assert.assertEquals(-1.0, sum.getDerivative(id2), 1.0e-15);</span>
<span class="fc" id="L86">    }</span>

    @Test
    public void testDivision() {
<span class="fc" id="L90">        final double v1 = 1.0;</span>
<span class="fc" id="L91">        final double v2 = 2.0;</span>
<span class="fc" id="L92">        final int id1 = -1;</span>
<span class="fc" id="L93">        final int id2 = 3;</span>
<span class="fc" id="L94">        final SparseGradient var1 = SparseGradient.createVariable(id1, v1);</span>
<span class="fc" id="L95">        final SparseGradient var2 = SparseGradient.createVariable(id2, v2);</span>
<span class="fc" id="L96">        final SparseGradient out = var1.divide(var2);</span>
<span class="fc" id="L97">        Assert.assertEquals(v1 / v2, out.getValue(), 1.0e-15); // returns the value</span>
<span class="fc" id="L98">        Assert.assertEquals(2, out.numVars());</span>
<span class="fc" id="L99">        Assert.assertEquals(1 / v2, out.getDerivative(id1), 1.0e-15);</span>
<span class="fc" id="L100">        Assert.assertEquals(-1 / (v2 * v2), out.getDerivative(id2), 1.0e-15);</span>
<span class="fc" id="L101">    }</span>

    @Test
    public void testMult() {
<span class="fc" id="L105">        final double v1 = 1.0;</span>
<span class="fc" id="L106">        final double c1 = 0.5;</span>
<span class="fc" id="L107">        final double v2 = 2.0;</span>
<span class="fc" id="L108">        final int id1 = -1;</span>
<span class="fc" id="L109">        final int id2 = 3;</span>
<span class="fc" id="L110">        final SparseGradient var1 = SparseGradient.createVariable(id1, v1);</span>
<span class="fc" id="L111">        final SparseGradient unit1 = var1.multiply(c1);</span>
<span class="fc" id="L112">        final SparseGradient unit2 = SparseGradient.createVariable(id2, v2).multiply(var1);</span>
<span class="fc" id="L113">        final SparseGradient sum = unit1.add(unit2);</span>
<span class="fc" id="L114">        Assert.assertEquals(v1 * c1 + v2 * v1, sum.getValue(), 1.0e-15); // returns the value</span>
<span class="fc" id="L115">        Assert.assertEquals(2, sum.numVars());</span>
<span class="fc" id="L116">        Assert.assertEquals(c1 + v2, sum.getDerivative(id1), 1.0e-15);</span>
<span class="fc" id="L117">        Assert.assertEquals(v1, sum.getDerivative(id2), 1.0e-15);</span>
<span class="fc" id="L118">    }</span>

    @Test
    public void testVarMultInPlace() {
<span class="fc" id="L122">        final double v1 = 1.0;</span>
<span class="fc" id="L123">        final double c1 = 0.5;</span>
<span class="fc" id="L124">        final double v2 = 2.0;</span>
<span class="fc" id="L125">        final int id1 = -1;</span>
<span class="fc" id="L126">        final int id2 = 3;</span>
<span class="fc" id="L127">        final SparseGradient var1 = SparseGradient.createVariable(id1, v1);</span>
<span class="fc" id="L128">        final SparseGradient sum = var1.multiply(c1);</span>
<span class="fc" id="L129">        final SparseGradient mult = SparseGradient.createVariable(id2, v2);</span>
<span class="fc" id="L130">        mult.multiplyInPlace(var1);</span>
<span class="fc" id="L131">        sum.addInPlace(mult);</span>
<span class="fc" id="L132">        Assert.assertEquals(v1 * c1 + v2 * v1, sum.getValue(), 1.0e-15); // returns the value</span>
<span class="fc" id="L133">        Assert.assertEquals(2, sum.numVars());</span>
<span class="fc" id="L134">        Assert.assertEquals(c1 + v2, sum.getDerivative(id1), 1.0e-15);</span>
<span class="fc" id="L135">        Assert.assertEquals(v1, sum.getDerivative(id2), 1.0e-15);</span>
<span class="fc" id="L136">    }</span>

    @Test
    public void testPrimitiveAdd() {
<span class="fc" id="L140">        checkF0F1(SparseGradient.createVariable(0, 1.0).add(5), 6.0, 1.0, 0.0, 0.0);</span>
<span class="fc" id="L141">        checkF0F1(SparseGradient.createVariable(1, 2.0).add(5), 7.0, 0.0, 1.0, 0.0);</span>
<span class="fc" id="L142">        checkF0F1(SparseGradient.createVariable(2, 3.0).add(5), 8.0, 0.0, 0.0, 1.0);</span>
<span class="fc" id="L143">    }</span>

    @Test
    public void testAdd() {
<span class="fc" id="L147">        SparseGradient x = SparseGradient.createVariable(0, 1.0);</span>
<span class="fc" id="L148">        SparseGradient y = SparseGradient.createVariable(1, 2.0);</span>
<span class="fc" id="L149">        SparseGradient z = SparseGradient.createVariable(2, 3.0);</span>
<span class="fc" id="L150">        SparseGradient xyz = x.add(y.add(z));</span>
<span class="fc" id="L151">        checkF0F1(xyz, x.getValue() + y.getValue() + z.getValue(), 1.0, 1.0, 1.0);</span>
<span class="fc" id="L152">    }</span>

    @Test
    public void testPrimitiveSubtract() {
<span class="fc" id="L156">        checkF0F1(SparseGradient.createVariable(0, 1.0).subtract(5), -4.0, 1.0, 0.0, 0.0);</span>
<span class="fc" id="L157">        checkF0F1(SparseGradient.createVariable(1, 2.0).subtract(5), -3.0, 0.0, 1.0, 0.0);</span>
<span class="fc" id="L158">        checkF0F1(SparseGradient.createVariable(2, 3.0).subtract(5), -2.0, 0.0, 0.0, 1.0);</span>
<span class="fc" id="L159">    }</span>

    @Test
    public void testSubtract() {
<span class="fc" id="L163">        SparseGradient x = SparseGradient.createVariable(0, 1.0);</span>
<span class="fc" id="L164">        SparseGradient y = SparseGradient.createVariable(1, 2.0);</span>
<span class="fc" id="L165">        SparseGradient z = SparseGradient.createVariable(2, 3.0);</span>
<span class="fc" id="L166">        SparseGradient xyz = x.subtract(y.subtract(z));</span>
<span class="fc" id="L167">        checkF0F1(xyz, x.getValue() - (y.getValue() - z.getValue()), 1.0, -1.0, 1.0);</span>
<span class="fc" id="L168">    }</span>

    @Test
    public void testPrimitiveMultiply() {
<span class="fc" id="L172">        checkF0F1(SparseGradient.createVariable(0, 1.0).multiply(5),  5.0, 5.0, 0.0, 0.0);</span>
<span class="fc" id="L173">        checkF0F1(SparseGradient.createVariable(1, 2.0).multiply(5), 10.0, 0.0, 5.0, 0.0);</span>
<span class="fc" id="L174">        checkF0F1(SparseGradient.createVariable(2, 3.0).multiply(5), 15.0, 0.0, 0.0, 5.0);</span>
<span class="fc" id="L175">    }</span>

    @Test
    public void testMultiply() {
<span class="fc" id="L179">        SparseGradient x = SparseGradient.createVariable(0, 1.0);</span>
<span class="fc" id="L180">        SparseGradient y = SparseGradient.createVariable(1, 2.0);</span>
<span class="fc" id="L181">        SparseGradient z = SparseGradient.createVariable(2, 3.0);</span>
<span class="fc" id="L182">        SparseGradient xyz = x.multiply(y.multiply(z));</span>
<span class="fc" id="L183">        checkF0F1(xyz, 6.0, 6.0, 3.0, 2.0);</span>
<span class="fc" id="L184">    }</span>

    @Test
    public void testNegate() {
<span class="fc" id="L188">        checkF0F1(SparseGradient.createVariable(0, 1.0).negate(), -1.0, -1.0, 0.0, 0.0);</span>
<span class="fc" id="L189">        checkF0F1(SparseGradient.createVariable(1, 2.0).negate(), -2.0, 0.0, -1.0, 0.0);</span>
<span class="fc" id="L190">        checkF0F1(SparseGradient.createVariable(2, 3.0).negate(), -3.0, 0.0, 0.0, -1.0);</span>
<span class="fc" id="L191">    }</span>

    @Test
    public void testReciprocal() {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L196">            SparseGradient r = SparseGradient.createVariable(0, x).reciprocal();</span>
<span class="fc" id="L197">            Assert.assertEquals(1 / x, r.getValue(), 1.0e-15);</span>
<span class="fc" id="L198">            final double expected = -1 / (x * x);</span>
<span class="fc" id="L199">            Assert.assertEquals(expected, r.getDerivative(0), 1.0e-15 * FastMath.abs(expected));</span>
        }
<span class="fc" id="L201">    }</span>

    @Test
    public void testPow() {
<span class="fc bfc" id="L205" title="All 2 branches covered.">        for (int n = 0; n &lt; 10; ++n) {</span>

<span class="fc" id="L207">            SparseGradient x = SparseGradient.createVariable(0, 1.0);</span>
<span class="fc" id="L208">            SparseGradient y = SparseGradient.createVariable(1, 2.0);</span>
<span class="fc" id="L209">            SparseGradient z = SparseGradient.createVariable(2, 3.0);</span>
<span class="fc" id="L210">            List&lt;SparseGradient&gt; list = Arrays.asList(x, y, z,</span>
<span class="fc" id="L211">                                                      x.add(y).add(z),</span>
<span class="fc" id="L212">                                                      x.multiply(y).multiply(z));</span>

<span class="fc bfc" id="L214" title="All 2 branches covered.">            if (n == 0) {</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">                for (SparseGradient sg : list) {</span>
<span class="fc" id="L216">                    Assert.assertEquals(sg.getField().getOne(), sg.pow(n));</span>
<span class="fc" id="L217">                }</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">            } else if (n == 1) {</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">                for (SparseGradient sg : list) {</span>
<span class="fc" id="L220">                    Assert.assertEquals(sg, sg.pow(n));</span>
<span class="fc" id="L221">                }</span>
            } else {
<span class="fc bfc" id="L223" title="All 2 branches covered.">                for (SparseGradient sg : list) {</span>
<span class="fc" id="L224">                    SparseGradient p = sg.getField().getOne();</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">                    for (int i = 0; i &lt; n; ++i) {</span>
<span class="fc" id="L226">                        p = p.multiply(sg);</span>
                    }
<span class="fc" id="L228">                    Assert.assertEquals(p, sg.pow(n));</span>
<span class="fc" id="L229">                }</span>
            }
        }
<span class="fc" id="L232">    }</span>

    @Test
    public void testPowDoubleDS() {
<span class="fc bfc" id="L236" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>

<span class="fc" id="L238">            SparseGradient x = SparseGradient.createVariable(0, 0.1);</span>
<span class="fc" id="L239">            SparseGradient y = SparseGradient.createVariable(1, 0.2);</span>
<span class="fc" id="L240">            SparseGradient z = SparseGradient.createVariable(2, 0.3);</span>
<span class="fc" id="L241">            List&lt;SparseGradient&gt; list = Arrays.asList(x, y, z,</span>
<span class="fc" id="L242">                                                      x.add(y).add(z),</span>
<span class="fc" id="L243">                                                      x.multiply(y).multiply(z));</span>

<span class="fc bfc" id="L245" title="All 2 branches covered.">            for (SparseGradient sg : list) {</span>
                // the special case a = 0 is included here
<span class="fc bfc" id="L247" title="All 2 branches covered.">                for (double a : new double[] { 0.0, 0.1, 1.0, 2.0, 5.0 }) {</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">                    SparseGradient reference = (a == 0) ?</span>
<span class="fc" id="L249">                                               x.getField().getZero() :</span>
<span class="fc" id="L250">                                               SparseGradient.createConstant(a).pow(sg);</span>
<span class="fc" id="L251">                    SparseGradient result = SparseGradient.pow(a, sg);</span>
<span class="fc" id="L252">                    Assert.assertEquals(reference, result);</span>
                }

<span class="fc" id="L255">            }</span>

            // negative base: -1^x can be evaluated for integers only, so value is sometimes OK, derivatives are always NaN
<span class="fc" id="L258">            SparseGradient negEvenInteger = SparseGradient.pow(-2.0, SparseGradient.createVariable(0, 2.0));</span>
<span class="fc" id="L259">            Assert.assertEquals(4.0, negEvenInteger.getValue(), 1.0e-15);</span>
<span class="fc" id="L260">            Assert.assertTrue(Double.isNaN(negEvenInteger.getDerivative(0)));</span>
<span class="fc" id="L261">            SparseGradient negOddInteger = SparseGradient.pow(-2.0, SparseGradient.createVariable(0, 3.0));</span>
<span class="fc" id="L262">            Assert.assertEquals(-8.0, negOddInteger.getValue(), 1.0e-15);</span>
<span class="fc" id="L263">            Assert.assertTrue(Double.isNaN(negOddInteger.getDerivative(0)));</span>
<span class="fc" id="L264">            SparseGradient negNonInteger = SparseGradient.pow(-2.0, SparseGradient.createVariable(0, 2.001));</span>
<span class="fc" id="L265">            Assert.assertTrue(Double.isNaN(negNonInteger.getValue()));</span>
<span class="fc" id="L266">            Assert.assertTrue(Double.isNaN(negNonInteger.getDerivative(0)));</span>

<span class="fc" id="L268">            SparseGradient zeroNeg = SparseGradient.pow(0.0, SparseGradient.createVariable(0, -1.0));</span>
<span class="fc" id="L269">            Assert.assertTrue(Double.isNaN(zeroNeg.getValue()));</span>
<span class="fc" id="L270">            Assert.assertTrue(Double.isNaN(zeroNeg.getDerivative(0)));</span>
<span class="fc" id="L271">            SparseGradient posNeg = SparseGradient.pow(2.0, SparseGradient.createVariable(0, -2.0));</span>
<span class="fc" id="L272">            Assert.assertEquals(1.0 / 4.0, posNeg.getValue(), 1.0e-15);</span>
<span class="fc" id="L273">            Assert.assertEquals(FastMath.log(2.0) / 4.0, posNeg.getDerivative(0), 1.0e-15);</span>

            // very special case: a = 0 and power = 0
<span class="fc" id="L276">            SparseGradient zeroZero = SparseGradient.pow(0.0, SparseGradient.createVariable(0, 0.0));</span>

            // this should be OK for simple first derivative with one variable only ...
<span class="fc" id="L279">            Assert.assertEquals(1.0, zeroZero.getValue(), 1.0e-15);</span>
<span class="fc" id="L280">            Assert.assertEquals(Double.NEGATIVE_INFINITY, zeroZero.getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L281">            Assert.assertEquals(0.0, zeroZero.getDerivative(1), 1.0e-15);</span>
<span class="fc" id="L282">            Assert.assertEquals(0.0, zeroZero.getDerivative(2), 1.0e-15);</span>

        }

<span class="fc" id="L286">    }</span>

    @Test
    public void testExpression() {
<span class="fc" id="L290">        double epsilon = 2.5e-13;</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">        for (double x = 0; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L292">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">            for (double y = 0; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L294">                SparseGradient sgY = SparseGradient.createVariable(1, y);</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">                for (double z = 0; z &gt;- 2; z -= 0.2) {</span>
<span class="fc" id="L296">                    SparseGradient sgZ = SparseGradient.createVariable(2, z);</span>

                    // f(x, y, z) = x + 5 x y - 2 z + (8 z x - y)^3
<span class="fc" id="L299">                    SparseGradient sg =</span>
<span class="fc" id="L300">                            sgZ.linearCombination(1, sgX,</span>
<span class="fc" id="L301">                                                  5, sgX.multiply(sgY),</span>
                                                 -2, sgZ,
<span class="fc" id="L303">                                                 1, sgZ.linearCombination(8, sgZ.multiply(sgX), -1, sgY).pow(3));</span>
<span class="fc" id="L304">                    double f = x + 5 * x * y - 2 * z + FastMath.pow(8 * z * x - y, 3);</span>
<span class="fc" id="L305">                    Assert.assertEquals(f, sg.getValue(), FastMath.abs(epsilon * f));</span>

                    // df/dx = 1 + 5 y + 24 (8 z x - y)^2 z
<span class="fc" id="L308">                    double dfdx = 1 + 5 * y + 24 * z * FastMath.pow(8 * z * x - y, 2);</span>
<span class="fc" id="L309">                    Assert.assertEquals(dfdx, sg.getDerivative(0), FastMath.abs(epsilon * dfdx));</span>

                }

            }
        }
<span class="fc" id="L315">    }</span>

    @Test
    public void testCompositionOneVariableX() {
<span class="fc" id="L319">        double epsilon = 1.0e-13;</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L321">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">            for (double y = 0.1; y &lt; 1.2; y += 0.1) {</span>
<span class="fc" id="L323">                SparseGradient sgY = SparseGradient.createConstant(y);</span>
<span class="fc" id="L324">                SparseGradient f = sgX.divide(sgY).sqrt();</span>
<span class="fc" id="L325">                double f0 = FastMath.sqrt(x / y);</span>
<span class="fc" id="L326">                Assert.assertEquals(f0, f.getValue(), FastMath.abs(epsilon * f0));</span>
<span class="fc" id="L327">                double f1 = 1 / (2 * FastMath.sqrt(x * y));</span>
<span class="fc" id="L328">                Assert.assertEquals(f1, f.getDerivative(0), FastMath.abs(epsilon * f1));</span>
            }
        }
<span class="fc" id="L331">    }</span>

    @Test
    public void testTrigo() {
<span class="fc" id="L335">        double epsilon = 2.0e-12;</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L337">                SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">                for (double y = 0.1; y &lt; 1.2; y += 0.1) {</span>
<span class="fc" id="L339">                    SparseGradient sgY = SparseGradient.createVariable(1, y);</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">                    for (double z = 0.1; z &lt; 1.2; z += 0.1) {</span>
<span class="fc" id="L341">                        SparseGradient sgZ = SparseGradient.createVariable(2, z);</span>
<span class="fc" id="L342">                        SparseGradient f = sgX.divide(sgY.cos().add(sgZ.tan())).sin();</span>
<span class="fc" id="L343">                        double a = FastMath.cos(y) + FastMath.tan(z);</span>
<span class="fc" id="L344">                        double f0 = FastMath.sin(x / a);</span>
<span class="fc" id="L345">                        Assert.assertEquals(f0, f.getValue(), FastMath.abs(epsilon * f0));</span>
<span class="fc" id="L346">                        double dfdx = FastMath.cos(x / a) / a;</span>
<span class="fc" id="L347">                        Assert.assertEquals(dfdx, f.getDerivative(0), FastMath.abs(epsilon * dfdx));</span>
<span class="fc" id="L348">                        double dfdy =  x * FastMath.sin(y) * dfdx / a;</span>
<span class="fc" id="L349">                        Assert.assertEquals(dfdy, f.getDerivative(1), FastMath.abs(epsilon * dfdy));</span>
<span class="fc" id="L350">                        double cz = FastMath.cos(z);</span>
<span class="fc" id="L351">                        double cz2 = cz * cz;</span>
<span class="fc" id="L352">                        double dfdz = -x * dfdx / (a * cz2);</span>
<span class="fc" id="L353">                        Assert.assertEquals(dfdz, f.getDerivative(2), FastMath.abs(epsilon * dfdz));</span>
                    }
                }
            }
<span class="fc" id="L357">    }</span>

    @Test
    public void testSqrtDefinition() {
<span class="fc bfc" id="L361" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L362">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L363">            SparseGradient sqrt1 = sgX.pow(0.5);</span>
<span class="fc" id="L364">            SparseGradient sqrt2 = sgX.sqrt();</span>
<span class="fc" id="L365">            SparseGradient zero = sqrt1.subtract(sqrt2);</span>
<span class="fc" id="L366">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L368">    }</span>

    @Test
    public void testRootNSingularity() {
<span class="fc bfc" id="L372" title="All 2 branches covered.">        for (int n = 2; n &lt; 10; ++n) {</span>
<span class="fc" id="L373">            SparseGradient sgZero = SparseGradient.createVariable(0, 0.0);</span>
<span class="fc" id="L374">            SparseGradient rootN  = sgZero.rootN(n);</span>
<span class="fc" id="L375">            Assert.assertEquals(0.0, rootN.getValue(), 1.0e-5);</span>
<span class="fc" id="L376">            Assert.assertTrue(Double.isInfinite(rootN.getDerivative(0)));</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">            Assert.assertTrue(rootN.getDerivative(0) &gt; 0);</span>
        }

<span class="fc" id="L380">    }</span>

    @Test
    public void testSqrtPow2() {
<span class="fc bfc" id="L384" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L385">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L386">            SparseGradient rebuiltX = sgX.multiply(sgX).sqrt();</span>
<span class="fc" id="L387">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L388">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L390">    }</span>

    @Test
    public void testCbrtDefinition() {
<span class="fc bfc" id="L394" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L395">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L396">            SparseGradient cbrt1 = sgX.pow(1.0 / 3.0);</span>
<span class="fc" id="L397">            SparseGradient cbrt2 = sgX.cbrt();</span>
<span class="fc" id="L398">            SparseGradient zero = cbrt1.subtract(cbrt2);</span>
<span class="fc" id="L399">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L401">    }</span>

    @Test
    public void testCbrtPow3() {
<span class="fc bfc" id="L405" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L406">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L407">            SparseGradient rebuiltX = sgX.multiply(sgX.multiply(sgX)).cbrt();</span>
<span class="fc" id="L408">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L409">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L411">    }</span>

    @Test
    public void testPowReciprocalPow() {
<span class="fc bfc" id="L415" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.01) {</span>
<span class="fc" id="L416">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L417" title="All 2 branches covered.">            for (double y = 0.1; y &lt; 1.2; y += 0.01) {</span>
<span class="fc" id="L418">                SparseGradient sgY = SparseGradient.createVariable(1, y);</span>
<span class="fc" id="L419">                SparseGradient rebuiltX = sgX.pow(sgY).pow(sgY.reciprocal());</span>
<span class="fc" id="L420">                SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L421">                checkF0F1(zero, 0.0, 0.0, 0.0);</span>
            }
        }
<span class="fc" id="L424">    }</span>

    @Test
    public void testHypotDefinition() {
<span class="fc bfc" id="L428" title="All 2 branches covered.">        for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L429">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">            for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L431">                SparseGradient sgY = SparseGradient.createVariable(1, y);</span>
<span class="fc" id="L432">                SparseGradient hypot = SparseGradient.hypot(sgY, sgX);</span>
<span class="fc" id="L433">                SparseGradient ref = sgX.multiply(sgX).add(sgY.multiply(sgY)).sqrt();</span>
<span class="fc" id="L434">                SparseGradient zero = hypot.subtract(ref);</span>
<span class="fc" id="L435">                checkF0F1(zero, 0.0, 0.0, 0.0);</span>

            }
        }
<span class="fc" id="L439">    }</span>

    @Test
    public void testHypotNoOverflow() {

<span class="fc" id="L444">        SparseGradient sgX = SparseGradient.createVariable(0, +3.0e250);</span>
<span class="fc" id="L445">        SparseGradient sgY = SparseGradient.createVariable(1, -4.0e250);</span>
<span class="fc" id="L446">        SparseGradient hypot = SparseGradient.hypot(sgX, sgY);</span>
<span class="fc" id="L447">        Assert.assertEquals(5.0e250, hypot.getValue(), 1.0e235);</span>
<span class="fc" id="L448">        Assert.assertEquals(sgX.getValue() / hypot.getValue(), hypot.getDerivative(0), 1.0e-10);</span>
<span class="fc" id="L449">        Assert.assertEquals(sgY.getValue() / hypot.getValue(), hypot.getDerivative(1), 1.0e-10);</span>

<span class="fc" id="L451">        SparseGradient sqrt  = sgX.multiply(sgX).add(sgY.multiply(sgY)).sqrt();</span>
<span class="fc" id="L452">        Assert.assertTrue(Double.isInfinite(sqrt.getValue()));</span>

<span class="fc" id="L454">    }</span>

    @Test
    public void testHypotNeglectible() {

<span class="fc" id="L459">        SparseGradient sgSmall = SparseGradient.createVariable(0, +3.0e-10);</span>
<span class="fc" id="L460">        SparseGradient sgLarge = SparseGradient.createVariable(1, -4.0e25);</span>

<span class="fc" id="L462">        Assert.assertEquals(sgLarge.abs().getValue(),</span>
<span class="fc" id="L463">                            SparseGradient.hypot(sgSmall, sgLarge).getValue(),</span>
                            1.0e-10);
<span class="fc" id="L465">        Assert.assertEquals(0,</span>
<span class="fc" id="L466">                            SparseGradient.hypot(sgSmall, sgLarge).getDerivative(0),</span>
                            1.0e-10);
<span class="fc" id="L468">        Assert.assertEquals(-1,</span>
<span class="fc" id="L469">                            SparseGradient.hypot(sgSmall, sgLarge).getDerivative(1),</span>
                            1.0e-10);

<span class="fc" id="L472">        Assert.assertEquals(sgLarge.abs().getValue(),</span>
<span class="fc" id="L473">                            SparseGradient.hypot(sgLarge, sgSmall).getValue(),</span>
                            1.0e-10);
<span class="fc" id="L475">        Assert.assertEquals(0,</span>
<span class="fc" id="L476">                            SparseGradient.hypot(sgLarge, sgSmall).getDerivative(0),</span>
                            1.0e-10);
<span class="fc" id="L478">        Assert.assertEquals(-1,</span>
<span class="fc" id="L479">                            SparseGradient.hypot(sgLarge, sgSmall).getDerivative(1),</span>
                            1.0e-10);

<span class="fc" id="L482">    }</span>

    @Test
    public void testHypotSpecial() {
<span class="fc" id="L486">        Assert.assertTrue(Double.isNaN(SparseGradient.hypot(SparseGradient.createVariable(0, Double.NaN),</span>
<span class="fc" id="L487">                                                                 SparseGradient.createVariable(0, +3.0e250)).getValue()));</span>
<span class="fc" id="L488">        Assert.assertTrue(Double.isNaN(SparseGradient.hypot(SparseGradient.createVariable(0, +3.0e250),</span>
<span class="fc" id="L489">                                                                 SparseGradient.createVariable(0, Double.NaN)).getValue()));</span>
<span class="fc" id="L490">        Assert.assertTrue(Double.isInfinite(SparseGradient.hypot(SparseGradient.createVariable(0, Double.POSITIVE_INFINITY),</span>
<span class="fc" id="L491">                                                                      SparseGradient.createVariable(0, +3.0e250)).getValue()));</span>
<span class="fc" id="L492">        Assert.assertTrue(Double.isInfinite(SparseGradient.hypot(SparseGradient.createVariable(0, +3.0e250),</span>
<span class="fc" id="L493">                                                                      SparseGradient.createVariable(0, Double.POSITIVE_INFINITY)).getValue()));</span>
<span class="fc" id="L494">    }</span>

    @Test
    public void testPrimitiveRemainder() {
<span class="fc bfc" id="L498" title="All 2 branches covered.">        for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L499">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L500" title="All 2 branches covered.">            for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L501">                SparseGradient remainder = sgX.remainder(y);</span>
<span class="fc" id="L502">                SparseGradient ref = sgX.subtract(x - FastMath.IEEEremainder(x, y));</span>
<span class="fc" id="L503">                SparseGradient zero = remainder.subtract(ref);</span>
<span class="fc" id="L504">                checkF0F1(zero, 0.0, 0.0, 0.0);</span>
            }
        }
<span class="fc" id="L507">    }</span>

    @Test
    public void testRemainder() {
<span class="fc bfc" id="L511" title="All 2 branches covered.">        for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L512">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">            for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L514">                SparseGradient sgY = SparseGradient.createVariable(1, y);</span>
<span class="fc" id="L515">                SparseGradient remainder = sgX.remainder(sgY);</span>
<span class="fc" id="L516">                SparseGradient ref = sgX.subtract(sgY.multiply((x - FastMath.IEEEremainder(x, y)) / y));</span>
<span class="fc" id="L517">                SparseGradient zero = remainder.subtract(ref);</span>
<span class="fc" id="L518">                checkF0F1(zero, 0.0, 0.0, 0.0);</span>
            }
        }
<span class="fc" id="L521">    }</span>

    @Override
    @Test
    public void testExp() {
<span class="fc bfc" id="L526" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L527">            double refExp = FastMath.exp(x);</span>
<span class="fc" id="L528">            checkF0F1(SparseGradient.createVariable(0, x).exp(), refExp, refExp);</span>
        }
<span class="fc" id="L530">    }</span>

    @Test
    public void testExpm1Definition() {
<span class="fc bfc" id="L534" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L535">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L536">            SparseGradient expm11 = sgX.expm1();</span>
<span class="fc" id="L537">            SparseGradient expm12 = sgX.exp().subtract(sgX.getField().getOne());</span>
<span class="fc" id="L538">            SparseGradient zero = expm11.subtract(expm12);</span>
<span class="fc" id="L539">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L541">    }</span>

    @Override
    @Test
    public void testLog() {
<span class="fc bfc" id="L546" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L547">            checkF0F1(SparseGradient.createVariable(0, x).log(), FastMath.log(x), 1.0 / x);</span>
        }
<span class="fc" id="L549">    }</span>

    @Test
    public void testLog1pDefinition() {
<span class="fc bfc" id="L553" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L554">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L555">            SparseGradient log1p1 = sgX.log1p();</span>
<span class="fc" id="L556">            SparseGradient log1p2 = sgX.add(sgX.getField().getOne()).log();</span>
<span class="fc" id="L557">            SparseGradient zero = log1p1.subtract(log1p2);</span>
<span class="fc" id="L558">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L560">    }</span>

    @Test
    public void testLog10Definition() {
<span class="fc bfc" id="L564" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L565">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L566">            SparseGradient log101 = sgX.log10();</span>
<span class="fc" id="L567">            SparseGradient log102 = sgX.log().divide(FastMath.log(10.0));</span>
<span class="fc" id="L568">            SparseGradient zero = log101.subtract(log102);</span>
<span class="fc" id="L569">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L571">    }</span>

    @Test
    public void testLogExp() {
<span class="fc bfc" id="L575" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L576">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L577">            SparseGradient rebuiltX = sgX.exp().log();</span>
<span class="fc" id="L578">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L579">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L581">    }</span>

    @Test
    public void testLog1pExpm1() {
<span class="fc bfc" id="L585" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L586">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L587">            SparseGradient rebuiltX = sgX.expm1().log1p();</span>
<span class="fc" id="L588">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L589">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L591">    }</span>

    @Test
    public void testLog10Power() {
<span class="fc bfc" id="L595" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L596">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L597">            SparseGradient rebuiltX = SparseGradient.pow(10.0, sgX).log10();</span>
<span class="fc" id="L598">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L599">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L601">    }</span>

    @Test
    public void testSinCos() {
<span class="fc bfc" id="L605" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L606">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L607">            SparseGradient sin = sgX.sin();</span>
<span class="fc" id="L608">            SparseGradient cos = sgX.cos();</span>
<span class="fc" id="L609">            double s = FastMath.sin(x);</span>
<span class="fc" id="L610">            double c = FastMath.cos(x);</span>
<span class="fc" id="L611">            checkF0F1(sin, s, c);</span>
<span class="fc" id="L612">            checkF0F1(cos, c, -s);</span>
        }
<span class="fc" id="L614">    }</span>

    @Test
    public void testSinAsin() {
<span class="fc bfc" id="L618" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L619">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L620">            SparseGradient rebuiltX = sgX.sin().asin();</span>
<span class="fc" id="L621">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L622">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L624">    }</span>

    @Test
    public void testCosAcos() {
<span class="fc bfc" id="L628" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L629">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L630">            SparseGradient rebuiltX = sgX.cos().acos();</span>
<span class="fc" id="L631">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L632">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L634">    }</span>

    @Test
    public void testTanAtan() {
<span class="fc bfc" id="L638" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L639">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L640">            SparseGradient rebuiltX = sgX.tan().atan();</span>
<span class="fc" id="L641">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L642">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L644">    }</span>

    @Test
    public void testTangentDefinition() {
<span class="fc bfc" id="L648" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L649">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L650">            SparseGradient tan1 = sgX.sin().divide(sgX.cos());</span>
<span class="fc" id="L651">            SparseGradient tan2 = sgX.tan();</span>
<span class="fc" id="L652">            SparseGradient zero = tan1.subtract(tan2);</span>
<span class="fc" id="L653">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L655">    }</span>

    @Override
    @Test
    public void testAtan2() {
<span class="fc bfc" id="L660" title="All 2 branches covered.">        for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L661">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L662" title="All 2 branches covered.">            for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L663">                SparseGradient sgY = SparseGradient.createVariable(1, y);</span>
<span class="fc" id="L664">                SparseGradient atan2 = SparseGradient.atan2(sgY, sgX);</span>
<span class="fc" id="L665">                SparseGradient ref = sgY.divide(sgX).atan();</span>
<span class="fc bfc" id="L666" title="All 2 branches covered.">                if (x &lt; 0) {</span>
<span class="fc bfc" id="L667" title="All 2 branches covered.">                    ref = (y &lt; 0) ? ref.subtract(FastMath.PI) : ref.add(FastMath.PI);</span>
                }
<span class="fc" id="L669">                SparseGradient zero = atan2.subtract(ref);</span>
<span class="fc" id="L670">                checkF0F1(zero, 0.0, 0.0);</span>
            }
        }
<span class="fc" id="L673">    }</span>

    @Test
    public void testAtan2SpecialCases() {

<span class="fc" id="L678">        SparseGradient pp =</span>
<span class="fc" id="L679">                SparseGradient.atan2(SparseGradient.createVariable(1, +0.0),</span>
<span class="fc" id="L680">                                          SparseGradient.createVariable(1, +0.0));</span>
<span class="fc" id="L681">        Assert.assertEquals(0, pp.getValue(), 1.0e-15);</span>
<span class="fc" id="L682">        Assert.assertEquals(+1, FastMath.copySign(1, pp.getValue()), 1.0e-15);</span>

<span class="fc" id="L684">        SparseGradient pn =</span>
<span class="fc" id="L685">                SparseGradient.atan2(SparseGradient.createVariable(1, +0.0),</span>
<span class="fc" id="L686">                                          SparseGradient.createVariable(1, -0.0));</span>
<span class="fc" id="L687">        Assert.assertEquals(FastMath.PI, pn.getValue(), 1.0e-15);</span>

<span class="fc" id="L689">        SparseGradient np =</span>
<span class="fc" id="L690">                SparseGradient.atan2(SparseGradient.createVariable(1, -0.0),</span>
<span class="fc" id="L691">                                          SparseGradient.createVariable(1, +0.0));</span>
<span class="fc" id="L692">        Assert.assertEquals(0, np.getValue(), 1.0e-15);</span>
<span class="fc" id="L693">        Assert.assertEquals(-1, FastMath.copySign(1, np.getValue()), 1.0e-15);</span>

<span class="fc" id="L695">        SparseGradient nn =</span>
<span class="fc" id="L696">                SparseGradient.atan2(SparseGradient.createVariable(1, -0.0),</span>
<span class="fc" id="L697">                                          SparseGradient.createVariable(1, -0.0));</span>
<span class="fc" id="L698">        Assert.assertEquals(-FastMath.PI, nn.getValue(), 1.0e-15);</span>

<span class="fc" id="L700">    }</span>

    @Test
    public void testSinhDefinition() {
<span class="fc bfc" id="L704" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L705">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L706">            SparseGradient sinh1 = sgX.exp().subtract(sgX.exp().reciprocal()).multiply(0.5);</span>
<span class="fc" id="L707">            SparseGradient sinh2 = sgX.sinh();</span>
<span class="fc" id="L708">            SparseGradient zero = sinh1.subtract(sinh2);</span>
<span class="fc" id="L709">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L711">    }</span>

    @Test
    public void testCoshDefinition() {
<span class="fc bfc" id="L715" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L716">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L717">            SparseGradient cosh1 = sgX.exp().add(sgX.exp().reciprocal()).multiply(0.5);</span>
<span class="fc" id="L718">            SparseGradient cosh2 = sgX.cosh();</span>
<span class="fc" id="L719">            SparseGradient zero = cosh1.subtract(cosh2);</span>
<span class="fc" id="L720">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L722">    }</span>

    @Test
    public void testTanhDefinition() {
<span class="fc bfc" id="L726" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L727">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L728">            SparseGradient tanh1 = sgX.exp().subtract(sgX.exp().reciprocal()).divide(sgX.exp().add(sgX.exp().reciprocal()));</span>
<span class="fc" id="L729">            SparseGradient tanh2 = sgX.tanh();</span>
<span class="fc" id="L730">            SparseGradient zero = tanh1.subtract(tanh2);</span>
<span class="fc" id="L731">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L733">    }</span>

    @Test
    public void testSinhAsinh() {
<span class="fc bfc" id="L737" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L738">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L739">            SparseGradient rebuiltX = sgX.sinh().asinh();</span>
<span class="fc" id="L740">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L741">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L743">    }</span>

    @Test
    public void testCoshAcosh() {
<span class="fc bfc" id="L747" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L748">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L749">            SparseGradient rebuiltX = sgX.cosh().acosh();</span>
<span class="fc" id="L750">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L751">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L753">    }</span>

    @Test
    public void testTanhAtanh() {
<span class="fc bfc" id="L757" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L758">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L759">            SparseGradient rebuiltX = sgX.tanh().atanh();</span>
<span class="fc" id="L760">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L761">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L763">    }</span>

    @Test
    public void testCompositionOneVariableY() {
<span class="fc bfc" id="L767" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L768">            SparseGradient sgX = SparseGradient.createConstant(x);</span>
<span class="fc bfc" id="L769" title="All 2 branches covered.">            for (double y = 0.1; y &lt; 1.2; y += 0.1) {</span>
<span class="fc" id="L770">                SparseGradient sgY = SparseGradient.createVariable(0, y);</span>
<span class="fc" id="L771">                SparseGradient f = sgX.divide(sgY).sqrt();</span>
<span class="fc" id="L772">                double f0 = FastMath.sqrt(x / y);</span>
<span class="fc" id="L773">                double f1 = -x / (2 * y * y * f0);</span>
<span class="fc" id="L774">                checkF0F1(f, f0, f1);</span>
            }
        }
<span class="fc" id="L777">    }</span>

    @Test
    public void testTaylorPolynomial() {
<span class="fc bfc" id="L781" title="All 2 branches covered.">        for (double x = 0; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L782">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc bfc" id="L783" title="All 2 branches covered.">            for (double y = 0; y &lt; 1.2; y += 0.2) {</span>
<span class="fc" id="L784">                SparseGradient sgY = SparseGradient.createVariable(1, y);</span>
<span class="fc bfc" id="L785" title="All 2 branches covered.">                for (double z = 0; z &lt; 1.2; z += 0.2) {</span>
<span class="fc" id="L786">                    SparseGradient sgZ = SparseGradient.createVariable(2, z);</span>
<span class="fc" id="L787">                    SparseGradient f = sgX.multiply(3).add(sgZ.multiply(-2)).add(sgY.multiply(5));</span>
<span class="fc bfc" id="L788" title="All 2 branches covered.">                    for (double dx = -0.2; dx &lt; 0.2; dx += 0.2) {</span>
<span class="fc bfc" id="L789" title="All 2 branches covered.">                        for (double dy = -0.2; dy &lt; 0.2; dy += 0.1) {</span>
<span class="fc bfc" id="L790" title="All 2 branches covered.">                            for (double dz = -0.2; dz &lt; 0.2; dz += 0.1) {</span>
<span class="fc" id="L791">                                double ref = 3 * (x + dx) + 5 * (y + dy) -2 * (z + dz);</span>
<span class="fc" id="L792">                                Assert.assertEquals(ref, f.taylor(dx, dy, dz), 3.0e-15);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L799">    }</span>

    @Test
    public void testTaylorAtan2() {
<span class="fc" id="L803">        double x0 =  0.1;</span>
<span class="fc" id="L804">        double y0 = -0.3;</span>
<span class="fc" id="L805">            SparseGradient sgX   = SparseGradient.createVariable(0, x0);</span>
<span class="fc" id="L806">            SparseGradient sgY   = SparseGradient.createVariable(1, y0);</span>
<span class="fc" id="L807">            SparseGradient atan2 = SparseGradient.atan2(sgY, sgX);</span>
<span class="fc" id="L808">            double maxError = 0;</span>
<span class="fc bfc" id="L809" title="All 2 branches covered.">            for (double dx = -0.05; dx &lt; 0.05; dx += 0.001) {</span>
<span class="fc bfc" id="L810" title="All 2 branches covered.">                for (double dy = -0.05; dy &lt; 0.05; dy += 0.001) {</span>
<span class="fc" id="L811">                    double ref = FastMath.atan2(y0 + dy, x0 + dx);</span>
<span class="fc" id="L812">                    maxError = FastMath.max(maxError, FastMath.abs(ref - atan2.taylor(dx, dy)));</span>
                }
            }
<span class="fc" id="L815">            double expectedError = 0.0241;</span>
<span class="fc" id="L816">            Assert.assertEquals(expectedError, maxError, 0.01 * expectedError);</span>
<span class="fc" id="L817">    }</span>

    @Override
    @Test
    public void testAbs() {

<span class="fc" id="L823">        SparseGradient minusOne = SparseGradient.createVariable(0, -1.0);</span>
<span class="fc" id="L824">        Assert.assertEquals(+1.0, minusOne.abs().getValue(), 1.0e-15);</span>
<span class="fc" id="L825">        Assert.assertEquals(-1.0, minusOne.abs().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L827">        SparseGradient plusOne = SparseGradient.createVariable(0, +1.0);</span>
<span class="fc" id="L828">        Assert.assertEquals(+1.0, plusOne.abs().getValue(), 1.0e-15);</span>
<span class="fc" id="L829">        Assert.assertEquals(+1.0, plusOne.abs().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L831">        SparseGradient minusZero = SparseGradient.createVariable(0, -0.0);</span>
<span class="fc" id="L832">        Assert.assertEquals(+0.0, minusZero.abs().getValue(), 1.0e-15);</span>
<span class="fc" id="L833">        Assert.assertEquals(-1.0, minusZero.abs().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L835">        SparseGradient plusZero = SparseGradient.createVariable(0, +0.0);</span>
<span class="fc" id="L836">        Assert.assertEquals(+0.0, plusZero.abs().getValue(), 1.0e-15);</span>
<span class="fc" id="L837">        Assert.assertEquals(+1.0, plusZero.abs().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L839">    }</span>

    @Override
    @Test
    public void testSignum() {

<span class="fc" id="L845">        SparseGradient minusOne = SparseGradient.createVariable(0, -1.0);</span>
<span class="fc" id="L846">        Assert.assertEquals(-1.0, minusOne.signum().getValue(), 1.0e-15);</span>
<span class="fc" id="L847">        Assert.assertEquals( 0.0, minusOne.signum().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L849">        SparseGradient plusOne = SparseGradient.createVariable(0, +1.0);</span>
<span class="fc" id="L850">        Assert.assertEquals(+1.0, plusOne.signum().getValue(), 1.0e-15);</span>
<span class="fc" id="L851">        Assert.assertEquals( 0.0, plusOne.signum().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L853">        SparseGradient minusZero = SparseGradient.createVariable(0, -0.0);</span>
<span class="fc" id="L854">        Assert.assertEquals(-0.0, minusZero.signum().getValue(), 1.0e-15);</span>
<span class="pc bpc" id="L855" title="1 of 2 branches missed.">        Assert.assertTrue(Double.doubleToLongBits(minusZero.signum().getValue()) &lt; 0);</span>
<span class="fc" id="L856">        Assert.assertEquals( 0.0, minusZero.signum().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L858">        SparseGradient plusZero = SparseGradient.createVariable(0, +0.0);</span>
<span class="fc" id="L859">        Assert.assertEquals(+0.0, plusZero.signum().getValue(), 1.0e-15);</span>
<span class="pc bpc" id="L860" title="1 of 2 branches missed.">        Assert.assertTrue(Double.doubleToLongBits(plusZero.signum().getValue()) == 0);</span>
<span class="fc" id="L861">        Assert.assertEquals( 0.0, plusZero.signum().getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L863">    }</span>

    @Test
    public void testCeilFloorRintLong() {

<span class="fc" id="L868">        SparseGradient x = SparseGradient.createVariable(0, -1.5);</span>
<span class="fc" id="L869">        Assert.assertEquals(-1.5, x.getValue(), 1.0e-15);</span>
<span class="fc" id="L870">        Assert.assertEquals(+1.0, x.getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L871">        Assert.assertEquals(-1.0, x.ceil().getValue(), 1.0e-15);</span>
<span class="fc" id="L872">        Assert.assertEquals(+0.0, x.ceil().getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L873">        Assert.assertEquals(-2.0, x.floor().getValue(), 1.0e-15);</span>
<span class="fc" id="L874">        Assert.assertEquals(+0.0, x.floor().getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L875">        Assert.assertEquals(-2.0, x.rint().getValue(), 1.0e-15);</span>
<span class="fc" id="L876">        Assert.assertEquals(+0.0, x.rint().getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L877">        Assert.assertEquals(-2.0, x.subtract(x.getField().getOne()).rint().getValue(), 1.0e-15);</span>
<span class="fc" id="L878">        Assert.assertEquals(-1l, x.round(), 1.0e-15);</span>

<span class="fc" id="L880">    }</span>

    @Test
    public void testCopySign() {

<span class="fc" id="L885">        SparseGradient minusOne = SparseGradient.createVariable(0, -1.0);</span>
<span class="fc" id="L886">        Assert.assertEquals(+1.0, minusOne.copySign(+1.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L887">        Assert.assertEquals(-1.0, minusOne.copySign(+1.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L888">        Assert.assertEquals(-1.0, minusOne.copySign(-1.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L889">        Assert.assertEquals(+1.0, minusOne.copySign(-1.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L890">        Assert.assertEquals(+1.0, minusOne.copySign(+0.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L891">        Assert.assertEquals(-1.0, minusOne.copySign(+0.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L892">        Assert.assertEquals(-1.0, minusOne.copySign(-0.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L893">        Assert.assertEquals(+1.0, minusOne.copySign(-0.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L894">        Assert.assertEquals(+1.0, minusOne.copySign(Double.NaN).getValue(), 1.0e-15);</span>
<span class="fc" id="L895">        Assert.assertEquals(-1.0, minusOne.copySign(Double.NaN).getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L897">        SparseGradient plusOne = SparseGradient.createVariable(0, +1.0);</span>
<span class="fc" id="L898">        Assert.assertEquals(+1.0, plusOne.copySign(+1.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L899">        Assert.assertEquals(+1.0, plusOne.copySign(+1.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L900">        Assert.assertEquals(-1.0, plusOne.copySign(-1.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L901">        Assert.assertEquals(-1.0, plusOne.copySign(-1.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L902">        Assert.assertEquals(+1.0, plusOne.copySign(+0.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L903">        Assert.assertEquals(+1.0, plusOne.copySign(+0.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L904">        Assert.assertEquals(-1.0, plusOne.copySign(-0.0).getValue(), 1.0e-15);</span>
<span class="fc" id="L905">        Assert.assertEquals(-1.0, plusOne.copySign(-0.0).getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L906">        Assert.assertEquals(+1.0, plusOne.copySign(Double.NaN).getValue(), 1.0e-15);</span>
<span class="fc" id="L907">        Assert.assertEquals(+1.0, plusOne.copySign(Double.NaN).getDerivative(0), 1.0e-15);</span>

<span class="fc" id="L909">    }</span>

    @Test
    public void testToDegreesDefinition() {
<span class="fc" id="L913">        double epsilon = 3.0e-16;</span>
<span class="fc bfc" id="L914" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L915" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L916">                SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L917">                Assert.assertEquals(FastMath.toDegrees(x), sgX.toDegrees().getValue(), epsilon);</span>
<span class="fc" id="L918">                Assert.assertEquals(180 / FastMath.PI, sgX.toDegrees().getDerivative(0), epsilon);</span>
            }
        }
<span class="fc" id="L921">    }</span>

    @Test
    public void testToRadiansDefinition() {
<span class="fc" id="L925">        double epsilon = 3.0e-16;</span>
<span class="fc bfc" id="L926" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L927" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L928">                SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L929">                Assert.assertEquals(FastMath.toRadians(x), sgX.toRadians().getValue(), epsilon);</span>
<span class="fc" id="L930">                Assert.assertEquals(FastMath.PI / 180, sgX.toRadians().getDerivative(0), epsilon);</span>
            }
        }
<span class="fc" id="L933">    }</span>

    @Test
    public void testDegRad() {
<span class="fc bfc" id="L937" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L938">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L939">            SparseGradient rebuiltX = sgX.toDegrees().toRadians();</span>
<span class="fc" id="L940">            SparseGradient zero = rebuiltX.subtract(sgX);</span>
<span class="fc" id="L941">            checkF0F1(zero, 0, 0);</span>
        }
<span class="fc" id="L943">    }</span>

    @Test
    public void testCompose() {
<span class="fc" id="L947">        PolynomialFunction poly =</span>
                new PolynomialFunction(new double[] { 1.0, 2.0, 3.0, 4.0, 5.0, 6.0 });
<span class="fc bfc" id="L949" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L950">            SparseGradient sgX = SparseGradient.createVariable(0, x);</span>
<span class="fc" id="L951">            SparseGradient sgY1 = sgX.getField().getZero();</span>
<span class="fc bfc" id="L952" title="All 2 branches covered.">            for (int i = poly.degree(); i &gt;= 0; --i) {</span>
<span class="fc" id="L953">                sgY1 = sgY1.multiply(sgX).add(poly.getCoefficients()[i]);</span>
            }
<span class="fc" id="L955">            SparseGradient sgY2 = sgX.compose(poly.value(x), poly.polynomialDerivative().value(x));</span>
<span class="fc" id="L956">            SparseGradient zero = sgY1.subtract(sgY2);</span>
<span class="fc" id="L957">            checkF0F1(zero, 0.0, 0.0);</span>
        }
<span class="fc" id="L959">    }</span>

    @Test
    public void testField() {
<span class="fc" id="L963">            SparseGradient x = SparseGradient.createVariable(0, 1.0);</span>
<span class="fc" id="L964">            checkF0F1(x.getField().getZero(), 0.0, 0.0, 0.0, 0.0);</span>
<span class="fc" id="L965">            checkF0F1(x.getField().getOne(), 1.0, 0.0, 0.0, 0.0);</span>
<span class="fc" id="L966">            Assert.assertEquals(SparseGradient.class, x.getField().getRuntimeClass());</span>
<span class="fc" id="L967">    }</span>

    @Test
    public void testLinearCombination1DSDS() {
<span class="fc" id="L971">        final SparseGradient[] a = new SparseGradient[] {</span>
<span class="fc" id="L972">            SparseGradient.createVariable(0, -1321008684645961.0 / 268435456.0),</span>
<span class="fc" id="L973">            SparseGradient.createVariable(1, -5774608829631843.0 / 268435456.0),</span>
<span class="fc" id="L974">            SparseGradient.createVariable(2, -7645843051051357.0 / 8589934592.0)</span>
        };
<span class="fc" id="L976">        final SparseGradient[] b = new SparseGradient[] {</span>
<span class="fc" id="L977">            SparseGradient.createVariable(3, -5712344449280879.0 / 2097152.0),</span>
<span class="fc" id="L978">            SparseGradient.createVariable(4, -4550117129121957.0 / 2097152.0),</span>
<span class="fc" id="L979">            SparseGradient.createVariable(5, 8846951984510141.0 / 131072.0)</span>
        };

<span class="fc" id="L982">        final SparseGradient abSumInline = a[0].linearCombination(a[0], b[0], a[1], b[1], a[2], b[2]);</span>
<span class="fc" id="L983">        final SparseGradient abSumArray = a[0].linearCombination(a, b);</span>

<span class="fc" id="L985">        Assert.assertEquals(abSumInline.getValue(), abSumArray.getValue(), 1.0e-15);</span>
<span class="fc" id="L986">        Assert.assertEquals(-1.8551294182586248737720779899, abSumInline.getValue(), 1.0e-15);</span>
<span class="fc" id="L987">        Assert.assertEquals(b[0].getValue(), abSumInline.getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L988">        Assert.assertEquals(b[1].getValue(), abSumInline.getDerivative(1), 1.0e-15);</span>
<span class="fc" id="L989">        Assert.assertEquals(b[2].getValue(), abSumInline.getDerivative(2), 1.0e-15);</span>
<span class="fc" id="L990">        Assert.assertEquals(a[0].getValue(), abSumInline.getDerivative(3), 1.0e-15);</span>
<span class="fc" id="L991">        Assert.assertEquals(a[1].getValue(), abSumInline.getDerivative(4), 1.0e-15);</span>
<span class="fc" id="L992">        Assert.assertEquals(a[2].getValue(), abSumInline.getDerivative(5), 1.0e-15);</span>

<span class="fc" id="L994">    }</span>

    @Test
    public void testLinearCombination1DoubleDS() {
<span class="fc" id="L998">        final double[] a = new double[] {</span>
            -1321008684645961.0 / 268435456.0,
            -5774608829631843.0 / 268435456.0,
            -7645843051051357.0 / 8589934592.0
        };
<span class="fc" id="L1003">        final SparseGradient[] b = new SparseGradient[] {</span>
<span class="fc" id="L1004">            SparseGradient.createVariable(0, -5712344449280879.0 / 2097152.0),</span>
<span class="fc" id="L1005">            SparseGradient.createVariable(1, -4550117129121957.0 / 2097152.0),</span>
<span class="fc" id="L1006">            SparseGradient.createVariable(2, 8846951984510141.0 / 131072.0)</span>
        };

<span class="fc" id="L1009">        final SparseGradient abSumInline = b[0].linearCombination(a[0], b[0],</span>
                                                                       a[1], b[1],
                                                                       a[2], b[2]);
<span class="fc" id="L1012">        final SparseGradient abSumArray = b[0].linearCombination(a, b);</span>

<span class="fc" id="L1014">        Assert.assertEquals(abSumInline.getValue(), abSumArray.getValue(), 1.0e-15);</span>
<span class="fc" id="L1015">        Assert.assertEquals(-1.8551294182586248737720779899, abSumInline.getValue(), 1.0e-15);</span>
<span class="fc" id="L1016">        Assert.assertEquals(a[0], abSumInline.getDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1017">        Assert.assertEquals(a[1], abSumInline.getDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1018">        Assert.assertEquals(a[2], abSumInline.getDerivative(2), 1.0e-15);</span>

<span class="fc" id="L1020">    }</span>

    @Test
    public void testLinearCombination2DSDS() {
        // we compare accurate versus naive dot product implementations
        // on regular vectors (i.e. not extreme cases like in the previous test)
<span class="fc" id="L1026">        UniformRandomProvider random = RandomSource.create(RandomSource.WELL_1024_A,</span>
<span class="fc" id="L1027">                                                           0xc6af886975069f11l);</span>

<span class="fc bfc" id="L1029" title="All 2 branches covered.">        for (int i = 0; i &lt; 10000; ++i) {</span>
<span class="fc" id="L1030">            final SparseGradient[] u = new SparseGradient[4];</span>
<span class="fc" id="L1031">            final SparseGradient[] v = new SparseGradient[4];</span>
<span class="fc bfc" id="L1032" title="All 2 branches covered.">            for (int j = 0; j &lt; u.length; ++j) {</span>
<span class="fc" id="L1033">                u[j] = SparseGradient.createVariable(j, 1e17 * random.nextDouble());</span>
<span class="fc" id="L1034">                v[j] = SparseGradient.createConstant(1e17 * random.nextDouble());</span>
            }

<span class="fc" id="L1037">            SparseGradient lin = u[0].linearCombination(u[0], v[0], u[1], v[1]);</span>
<span class="fc" id="L1038">            double ref = u[0].getValue() * v[0].getValue() +</span>
<span class="fc" id="L1039">                         u[1].getValue() * v[1].getValue();</span>
<span class="fc" id="L1040">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1041">            Assert.assertEquals(v[0].getValue(), lin.getDerivative(0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1042">            Assert.assertEquals(v[1].getValue(), lin.getDerivative(1), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>

<span class="fc" id="L1044">            lin = u[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2]);</span>
<span class="fc" id="L1045">            ref = u[0].getValue() * v[0].getValue() +</span>
<span class="fc" id="L1046">                  u[1].getValue() * v[1].getValue() +</span>
<span class="fc" id="L1047">                  u[2].getValue() * v[2].getValue();</span>
<span class="fc" id="L1048">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1049">            Assert.assertEquals(v[0].getValue(), lin.getDerivative(0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1050">            Assert.assertEquals(v[1].getValue(), lin.getDerivative(1), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1051">            Assert.assertEquals(v[2].getValue(), lin.getDerivative(2), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>

<span class="fc" id="L1053">            lin = u[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2], u[3], v[3]);</span>
<span class="fc" id="L1054">            ref = u[0].getValue() * v[0].getValue() +</span>
<span class="fc" id="L1055">                  u[1].getValue() * v[1].getValue() +</span>
<span class="fc" id="L1056">                  u[2].getValue() * v[2].getValue() +</span>
<span class="fc" id="L1057">                  u[3].getValue() * v[3].getValue();</span>
<span class="fc" id="L1058">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1059">            Assert.assertEquals(v[0].getValue(), lin.getDerivative(0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1060">            Assert.assertEquals(v[1].getValue(), lin.getDerivative(1), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1061">            Assert.assertEquals(v[2].getValue(), lin.getDerivative(2), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>
<span class="fc" id="L1062">            Assert.assertEquals(v[3].getValue(), lin.getDerivative(3), 1.0e-15 * FastMath.abs(v[3].getValue()));</span>

        }
<span class="fc" id="L1065">    }</span>

    @Test
    public void testLinearCombination2DoubleDS() {
        // we compare accurate versus naive dot product implementations
        // on regular vectors (i.e. not extreme cases like in the previous test)
<span class="fc" id="L1071">        UniformRandomProvider random = RandomSource.create(RandomSource.WELL_1024_A,</span>
<span class="fc" id="L1072">                                                           0xc6af886975069f11l);</span>

<span class="fc bfc" id="L1074" title="All 2 branches covered.">        for (int i = 0; i &lt; 10000; ++i) {</span>
<span class="fc" id="L1075">            final double[] u = new double[4];</span>
<span class="fc" id="L1076">            final SparseGradient[] v = new SparseGradient[4];</span>
<span class="fc bfc" id="L1077" title="All 2 branches covered.">            for (int j = 0; j &lt; u.length; ++j) {</span>
<span class="fc" id="L1078">                u[j] = 1e17 * random.nextDouble();</span>
<span class="fc" id="L1079">                v[j] = SparseGradient.createVariable(j, 1e17 * random.nextDouble());</span>
            }

<span class="fc" id="L1082">            SparseGradient lin = v[0].linearCombination(u[0], v[0], u[1], v[1]);</span>
<span class="fc" id="L1083">            double ref = u[0] * v[0].getValue() +</span>
<span class="fc" id="L1084">                         u[1] * v[1].getValue();</span>
<span class="fc" id="L1085">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1086">            Assert.assertEquals(u[0], lin.getDerivative(0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1087">            Assert.assertEquals(u[1], lin.getDerivative(1), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>

<span class="fc" id="L1089">            lin = v[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2]);</span>
<span class="fc" id="L1090">            ref = u[0] * v[0].getValue() +</span>
<span class="fc" id="L1091">                  u[1] * v[1].getValue() +</span>
<span class="fc" id="L1092">                  u[2] * v[2].getValue();</span>
<span class="fc" id="L1093">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1094">            Assert.assertEquals(u[0], lin.getDerivative(0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1095">            Assert.assertEquals(u[1], lin.getDerivative(1), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1096">            Assert.assertEquals(u[2], lin.getDerivative(2), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>

<span class="fc" id="L1098">            lin = v[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2], u[3], v[3]);</span>
<span class="fc" id="L1099">            ref = u[0] * v[0].getValue() +</span>
<span class="fc" id="L1100">                  u[1] * v[1].getValue() +</span>
<span class="fc" id="L1101">                  u[2] * v[2].getValue() +</span>
<span class="fc" id="L1102">                  u[3] * v[3].getValue();</span>
<span class="fc" id="L1103">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1104">            Assert.assertEquals(u[0], lin.getDerivative(0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1105">            Assert.assertEquals(u[1], lin.getDerivative(1), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1106">            Assert.assertEquals(u[2], lin.getDerivative(2), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>
<span class="fc" id="L1107">            Assert.assertEquals(u[3], lin.getDerivative(3), 1.0e-15 * FastMath.abs(v[3].getValue()));</span>

        }
<span class="fc" id="L1110">    }</span>

    @Test
    public void testSerialization() {
<span class="fc" id="L1114">        SparseGradient a = SparseGradient.createVariable(0, 1.3);</span>
<span class="fc" id="L1115">        SparseGradient b = (SparseGradient) TestUtils.serializeAndRecover(a);</span>
<span class="fc" id="L1116">        Assert.assertEquals(a, b);</span>
<span class="fc" id="L1117">    }</span>

    private void checkF0F1(SparseGradient sg, double value, double...derivatives) {

        // check value
<span class="fc" id="L1122">        Assert.assertEquals(value, sg.getValue(), 1.0e-13);</span>

        // check first order derivatives
<span class="fc bfc" id="L1125" title="All 2 branches covered.">        for (int i = 0; i &lt; derivatives.length; ++i) {</span>
<span class="fc" id="L1126">            Assert.assertEquals(derivatives[i], sg.getDerivative(i), 1.0e-13);</span>
        }

<span class="fc" id="L1129">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>