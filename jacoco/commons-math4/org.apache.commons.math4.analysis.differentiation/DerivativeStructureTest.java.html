<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DerivativeStructureTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">commons_math4$All_in_commons_math4.exec</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.math4.analysis.differentiation</a> &gt; <span class="el_source">DerivativeStructureTest.java</span></div><h1>DerivativeStructureTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.commons.math4.analysis.differentiation;

import java.util.Arrays;
import java.util.List;

import org.apache.commons.math4.ExtendedFieldElementAbstractTest;
import org.apache.commons.math4.TestUtils;
import org.apache.commons.math4.analysis.differentiation.DerivativeStructure;
import org.apache.commons.math4.analysis.polynomials.PolynomialFunction;
import org.apache.commons.math4.exception.DimensionMismatchException;
import org.apache.commons.math4.exception.NumberIsTooLargeException;
import org.apache.commons.rng.UniformRandomProvider;
import org.apache.commons.rng.simple.RandomSource;
import org.apache.commons.numbers.core.ArithmeticUtils;
import org.apache.commons.numbers.combinatorics.Factorial;
import org.apache.commons.math4.util.FastMath;
import org.apache.commons.numbers.core.Precision;
import org.junit.Assert;
import org.junit.Test;

/**
 * Test for class {@link DerivativeStructure}.
 */
<span class="fc" id="L41">public class DerivativeStructureTest extends ExtendedFieldElementAbstractTest&lt;DerivativeStructure&gt; {</span>

    @Override
    protected DerivativeStructure build(final double x) {
<span class="fc" id="L45">        return new DerivativeStructure(2, 1, 0, x);</span>
    }

    @Test(expected=NumberIsTooLargeException.class)
    public void testWrongVariableIndex() {
<span class="nc" id="L50">        new DerivativeStructure(3, 1, 3, 1.0);</span>
<span class="nc" id="L51">    }</span>

    @Test(expected=DimensionMismatchException.class)
    public void testMissingOrders() {
<span class="nc" id="L55">        new DerivativeStructure(3, 1, 0, 1.0).getPartialDerivative(0, 1);</span>
<span class="nc" id="L56">    }</span>

    @Test(expected=NumberIsTooLargeException.class)
    public void testTooLargeOrder() {
<span class="nc" id="L60">        new DerivativeStructure(3, 1, 0, 1.0).getPartialDerivative(1, 1, 2);</span>
<span class="nc" id="L61">    }</span>

    @Test
    public void testVariableWithoutDerivative0() {
<span class="fc" id="L65">        DerivativeStructure v = new DerivativeStructure(1, 0, 0, 1.0);</span>
<span class="fc" id="L66">        Assert.assertEquals(1.0, v.getValue(), 1.0e-15);</span>
<span class="fc" id="L67">    }</span>

    @Test(expected=NumberIsTooLargeException.class)
    public void testVariableWithoutDerivative1() {
<span class="fc" id="L71">        DerivativeStructure v = new DerivativeStructure(1, 0, 0, 1.0);</span>
<span class="nc" id="L72">        Assert.assertEquals(1.0, v.getPartialDerivative(1), 1.0e-15);</span>
<span class="nc" id="L73">    }</span>

    @Test
    public void testVariable() {
<span class="fc bfc" id="L77" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L78">            checkF0F1(new DerivativeStructure(3, maxOrder, 0, 1.0),</span>
                      1.0, 1.0, 0.0, 0.0);
<span class="fc" id="L80">            checkF0F1(new DerivativeStructure(3, maxOrder, 1, 2.0),</span>
                      2.0, 0.0, 1.0, 0.0);
<span class="fc" id="L82">            checkF0F1(new DerivativeStructure(3, maxOrder, 2, 3.0),</span>
                      3.0, 0.0, 0.0, 1.0);
        }
<span class="fc" id="L85">    }</span>

    @Test
    public void testConstant() {
<span class="fc bfc" id="L89" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L90">            checkF0F1(new DerivativeStructure(3, maxOrder, FastMath.PI),</span>
                      FastMath.PI, 0.0, 0.0, 0.0);
        }
<span class="fc" id="L93">    }</span>

    @Test
    public void testCreateConstant() {
<span class="fc" id="L97">        DerivativeStructure a = new DerivativeStructure(3, 2, 0, 1.3);</span>
<span class="fc" id="L98">        DerivativeStructure b = a.createConstant(2.5);</span>
<span class="fc" id="L99">        Assert.assertEquals(a.getFreeParameters(), b.getFreeParameters());</span>
<span class="fc" id="L100">        Assert.assertEquals(a.getOrder(), b.getOrder());</span>
<span class="fc" id="L101">        checkEquals(a.getField().getOne().multiply(2.5), b, 1.0e-15);</span>
<span class="fc" id="L102">    }</span>

    @Test
    public void testPrimitiveAdd() {
<span class="fc bfc" id="L106" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L107">            checkF0F1(new DerivativeStructure(3, maxOrder, 0, 1.0).add(5), 6.0, 1.0, 0.0, 0.0);</span>
<span class="fc" id="L108">            checkF0F1(new DerivativeStructure(3, maxOrder, 1, 2.0).add(5), 7.0, 0.0, 1.0, 0.0);</span>
<span class="fc" id="L109">            checkF0F1(new DerivativeStructure(3, maxOrder, 2, 3.0).add(5), 8.0, 0.0, 0.0, 1.0);</span>
        }
<span class="fc" id="L111">    }</span>

    @Test
    public void testAdd() {
<span class="fc bfc" id="L115" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L116">            DerivativeStructure x = new DerivativeStructure(3, maxOrder, 0, 1.0);</span>
<span class="fc" id="L117">            DerivativeStructure y = new DerivativeStructure(3, maxOrder, 1, 2.0);</span>
<span class="fc" id="L118">            DerivativeStructure z = new DerivativeStructure(3, maxOrder, 2, 3.0);</span>
<span class="fc" id="L119">            DerivativeStructure xyz = x.add(y.add(z));</span>
<span class="fc" id="L120">            checkF0F1(xyz, x.getValue() + y.getValue() + z.getValue(), 1.0, 1.0, 1.0);</span>
        }
<span class="fc" id="L122">    }</span>

    @Test
    public void testPrimitiveSubtract() {
<span class="fc bfc" id="L126" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L127">            checkF0F1(new DerivativeStructure(3, maxOrder, 0, 1.0).subtract(5), -4.0, 1.0, 0.0, 0.0);</span>
<span class="fc" id="L128">            checkF0F1(new DerivativeStructure(3, maxOrder, 1, 2.0).subtract(5), -3.0, 0.0, 1.0, 0.0);</span>
<span class="fc" id="L129">            checkF0F1(new DerivativeStructure(3, maxOrder, 2, 3.0).subtract(5), -2.0, 0.0, 0.0, 1.0);</span>
        }
<span class="fc" id="L131">    }</span>

    @Test
    public void testSubtract() {
<span class="fc bfc" id="L135" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L136">            DerivativeStructure x = new DerivativeStructure(3, maxOrder, 0, 1.0);</span>
<span class="fc" id="L137">            DerivativeStructure y = new DerivativeStructure(3, maxOrder, 1, 2.0);</span>
<span class="fc" id="L138">            DerivativeStructure z = new DerivativeStructure(3, maxOrder, 2, 3.0);</span>
<span class="fc" id="L139">            DerivativeStructure xyz = x.subtract(y.subtract(z));</span>
<span class="fc" id="L140">            checkF0F1(xyz, x.getValue() - (y.getValue() - z.getValue()), 1.0, -1.0, 1.0);</span>
        }
<span class="fc" id="L142">    }</span>

    @Test
    public void testPrimitiveMultiply() {
<span class="fc bfc" id="L146" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L147">            checkF0F1(new DerivativeStructure(3, maxOrder, 0, 1.0).multiply(5),  5.0, 5.0, 0.0, 0.0);</span>
<span class="fc" id="L148">            checkF0F1(new DerivativeStructure(3, maxOrder, 1, 2.0).multiply(5), 10.0, 0.0, 5.0, 0.0);</span>
<span class="fc" id="L149">            checkF0F1(new DerivativeStructure(3, maxOrder, 2, 3.0).multiply(5), 15.0, 0.0, 0.0, 5.0);</span>
        }
<span class="fc" id="L151">    }</span>

    @Test
    public void testMultiply() {
<span class="fc bfc" id="L155" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L156">            DerivativeStructure x = new DerivativeStructure(3, maxOrder, 0, 1.0);</span>
<span class="fc" id="L157">            DerivativeStructure y = new DerivativeStructure(3, maxOrder, 1, 2.0);</span>
<span class="fc" id="L158">            DerivativeStructure z = new DerivativeStructure(3, maxOrder, 2, 3.0);</span>
<span class="fc" id="L159">            DerivativeStructure xyz = x.multiply(y.multiply(z));</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">            for (int i = 0; i &lt;= maxOrder; ++i) {</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">                for (int j = 0; j &lt;= maxOrder; ++j) {</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">                    for (int k = 0; k &lt;= maxOrder; ++k) {</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">                        if (i + j + k &lt;= maxOrder) {</span>
<span class="fc bfc" id="L164" title="All 6 branches covered.">                            Assert.assertEquals((i == 0 ? x.getValue() : (i == 1 ? 1.0 : 0.0)) *</span>
<span class="fc bfc" id="L165" title="All 4 branches covered.">                                                (j == 0 ? y.getValue() : (j == 1 ? 1.0 : 0.0)) *</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">                                                (k == 0 ? z.getValue() : (k == 1 ? 1.0 : 0.0)),</span>
<span class="fc" id="L167">                                                xyz.getPartialDerivative(i, j, k),</span>
                                                1.0e-15);
                        }
                    }
                }
            }
        }
<span class="fc" id="L174">    }</span>

    @Test
    public void testNegate() {
<span class="fc bfc" id="L178" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L179">            checkF0F1(new DerivativeStructure(3, maxOrder, 0, 1.0).negate(), -1.0, -1.0, 0.0, 0.0);</span>
<span class="fc" id="L180">            checkF0F1(new DerivativeStructure(3, maxOrder, 1, 2.0).negate(), -2.0, 0.0, -1.0, 0.0);</span>
<span class="fc" id="L181">            checkF0F1(new DerivativeStructure(3, maxOrder, 2, 3.0).negate(), -3.0, 0.0, 0.0, -1.0);</span>
        }
<span class="fc" id="L183">    }</span>

    @Test
    public void testReciprocal() {
<span class="fc bfc" id="L187" title="All 2 branches covered.">        for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L188">            DerivativeStructure r = new DerivativeStructure(1, 6, 0, x).reciprocal();</span>
<span class="fc" id="L189">            Assert.assertEquals(1 / x, r.getValue(), 1.0e-15);</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">            for (int i = 1; i &lt; r.getOrder(); ++i) {</span>
<span class="fc" id="L191">                double expected = ArithmeticUtils.pow(-1, i) * Factorial.value(i) /</span>
<span class="fc" id="L192">                                  FastMath.pow(x, i + 1);</span>
<span class="fc" id="L193">                Assert.assertEquals(expected, r.getPartialDerivative(i), 1.0e-15 * FastMath.abs(expected));</span>
            }
        }
<span class="fc" id="L196">    }</span>

    @Test
    public void testPow() {
<span class="fc bfc" id="L200" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">            for (int n = 0; n &lt; 10; ++n) {</span>

<span class="fc" id="L203">                DerivativeStructure x = new DerivativeStructure(3, maxOrder, 0, 1.0);</span>
<span class="fc" id="L204">                DerivativeStructure y = new DerivativeStructure(3, maxOrder, 1, 2.0);</span>
<span class="fc" id="L205">                DerivativeStructure z = new DerivativeStructure(3, maxOrder, 2, 3.0);</span>
<span class="fc" id="L206">                List&lt;DerivativeStructure&gt; list = Arrays.asList(x, y, z,</span>
<span class="fc" id="L207">                                                               x.add(y).add(z),</span>
<span class="fc" id="L208">                                                               x.multiply(y).multiply(z));</span>

<span class="fc bfc" id="L210" title="All 2 branches covered.">                if (n == 0) {</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">                    for (DerivativeStructure ds : list) {</span>
<span class="fc" id="L212">                        checkEquals(ds.getField().getOne(), ds.pow(n), 1.0e-15);</span>
<span class="fc" id="L213">                    }</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">                } else if (n == 1) {</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">                    for (DerivativeStructure ds : list) {</span>
<span class="fc" id="L216">                        checkEquals(ds, ds.pow(n), 1.0e-15);</span>
<span class="fc" id="L217">                    }</span>
                } else {
<span class="fc bfc" id="L219" title="All 2 branches covered.">                    for (DerivativeStructure ds : list) {</span>
<span class="fc" id="L220">                        DerivativeStructure p = ds.getField().getOne();</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">                        for (int i = 0; i &lt; n; ++i) {</span>
<span class="fc" id="L222">                            p = p.multiply(ds);</span>
                        }
<span class="fc" id="L224">                        checkEquals(p, ds.pow(n), 1.0e-15);</span>
<span class="fc" id="L225">                    }</span>
                }
            }
        }
<span class="fc" id="L229">    }</span>

    @Test
    public void testPowDoubleDS() {
<span class="fc bfc" id="L233" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>

<span class="fc" id="L235">            DerivativeStructure x = new DerivativeStructure(3, maxOrder, 0, 0.1);</span>
<span class="fc" id="L236">            DerivativeStructure y = new DerivativeStructure(3, maxOrder, 1, 0.2);</span>
<span class="fc" id="L237">            DerivativeStructure z = new DerivativeStructure(3, maxOrder, 2, 0.3);</span>
<span class="fc" id="L238">            List&lt;DerivativeStructure&gt; list = Arrays.asList(x, y, z,</span>
<span class="fc" id="L239">                                                           x.add(y).add(z),</span>
<span class="fc" id="L240">                                                           x.multiply(y).multiply(z));</span>

<span class="fc bfc" id="L242" title="All 2 branches covered.">            for (DerivativeStructure ds : list) {</span>
                // the special case a = 0 is included here
<span class="fc bfc" id="L244" title="All 2 branches covered.">                for (double a : new double[] { 0.0, 0.1, 1.0, 2.0, 5.0 }) {</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">                    DerivativeStructure reference = (a == 0) ?</span>
<span class="fc" id="L246">                                                    x.getField().getZero() :</span>
<span class="fc" id="L247">                                                    new DerivativeStructure(3, maxOrder, a).pow(ds);</span>
<span class="fc" id="L248">                    DerivativeStructure result = DerivativeStructure.pow(a, ds);</span>
<span class="fc" id="L249">                    checkEquals(reference, result, 1.0e-15);</span>
                }

<span class="fc" id="L252">            }</span>

            // negative base: -1^x can be evaluated for integers only, so value is sometimes OK, derivatives are always NaN
<span class="fc" id="L255">            DerivativeStructure negEvenInteger = DerivativeStructure.pow(-2.0, new DerivativeStructure(3,  maxOrder, 0, 2.0));</span>
<span class="fc" id="L256">            Assert.assertEquals(4.0, negEvenInteger.getValue(), 1.0e-15);</span>
<span class="fc" id="L257">            Assert.assertTrue(Double.isNaN(negEvenInteger.getPartialDerivative(1, 0, 0)));</span>
<span class="fc" id="L258">            DerivativeStructure negOddInteger = DerivativeStructure.pow(-2.0, new DerivativeStructure(3,  maxOrder, 0, 3.0));</span>
<span class="fc" id="L259">            Assert.assertEquals(-8.0, negOddInteger.getValue(), 1.0e-15);</span>
<span class="fc" id="L260">            Assert.assertTrue(Double.isNaN(negOddInteger.getPartialDerivative(1, 0, 0)));</span>
<span class="fc" id="L261">            DerivativeStructure negNonInteger = DerivativeStructure.pow(-2.0, new DerivativeStructure(3,  maxOrder, 0, 2.001));</span>
<span class="fc" id="L262">            Assert.assertTrue(Double.isNaN(negNonInteger.getValue()));</span>
<span class="fc" id="L263">            Assert.assertTrue(Double.isNaN(negNonInteger.getPartialDerivative(1, 0, 0)));</span>

<span class="fc" id="L265">            DerivativeStructure zeroNeg = DerivativeStructure.pow(0.0, new DerivativeStructure(3,  maxOrder, 0, -1.0));</span>
<span class="fc" id="L266">            Assert.assertTrue(Double.isNaN(zeroNeg.getValue()));</span>
<span class="fc" id="L267">            Assert.assertTrue(Double.isNaN(zeroNeg.getPartialDerivative(1, 0, 0)));</span>
<span class="fc" id="L268">            DerivativeStructure posNeg = DerivativeStructure.pow(2.0, new DerivativeStructure(3,  maxOrder, 0, -2.0));</span>
<span class="fc" id="L269">            Assert.assertEquals(1.0 / 4.0, posNeg.getValue(), 1.0e-15);</span>
<span class="fc" id="L270">            Assert.assertEquals(FastMath.log(2.0) / 4.0, posNeg.getPartialDerivative(1, 0, 0), 1.0e-15);</span>

            // very special case: a = 0 and power = 0
<span class="fc" id="L273">            DerivativeStructure zeroZero = DerivativeStructure.pow(0.0, new DerivativeStructure(3,  maxOrder, 0, 0.0));</span>

            // this should be OK for simple first derivative with one variable only ...
<span class="fc" id="L276">            Assert.assertEquals(1.0, zeroZero.getValue(), 1.0e-15);</span>
<span class="fc" id="L277">            Assert.assertEquals(Double.NEGATIVE_INFINITY, zeroZero.getPartialDerivative(1, 0, 0), 1.0e-15);</span>

            // the following checks show a LIMITATION of the current implementation
            // we have no way to tell x is a pure linear variable x = 0
            // we only say: &quot;x is a structure with value = 0.0,
            // first derivative with respect to x = 1.0, and all other derivatives
            // (first order with respect to y and z and higher derivatives) all 0.0.
            // We have function f(x) = a^x and x = 0 so we compute:
            // f(0) = 1, f'(0) = ln(a), f''(0) = ln(a)^2. The limit of these values
            // when a converges to 0 implies all derivatives keep switching between
            // +infinity and -infinity.
            //
            // Function composition rule for first derivatives is:
            // d[f(g(x,y,z))]/dy = f'(g(x,y,z)) * dg(x,y,z)/dy
            // so given that in our case x represents g and does not depend
            // on y or z, we have dg(x,y,z)/dy = 0
            // applying the composition rules gives:
            // d[f(g(x,y,z))]/dy = f'(g(x,y,z)) * dg(x,y,z)/dy
            //                 = -infinity * 0
            //                 = NaN
            // if we knew x is really the x variable and not the identity
            // function applied to x, we would not have computed f'(g(x,y,z)) * dg(x,y,z)/dy
            // and we would have found that the result was 0 and not NaN
<span class="fc" id="L300">            Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(0, 1, 0)));</span>
<span class="fc" id="L301">            Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(0, 0, 1)));</span>

            // Function composition rule for second derivatives is:
            // d2[f(g(x))]/dx2 = f''(g(x)) * [g'(x)]^2 + f'(g(x)) * g''(x)
            // when function f is the a^x root and x = 0 we have:
            // f(0) = 1, f'(0) = ln(a), f''(0) = ln(a)^2 which for a = 0 implies
            // all derivatives keep switching between +infinity and -infinity
            // so given that in our case x represents g, we have g(x) = 0,
            // g'(x) = 1 and g''(x) = 0
            // applying the composition rules gives:
            // d2[f(g(x))]/dx2 = f''(g(x)) * [g'(x)]^2 + f'(g(x)) * g''(x)
            //                 = +infinity * 1^2 + -infinity * 0
            //                 = +infinity + NaN
            //                 = NaN
            // if we knew x is really the x variable and not the identity
            // function applied to x, we would not have computed f'(g(x)) * g''(x)
            // and we would have found that the result was +infinity and not NaN
<span class="fc bfc" id="L318" title="All 2 branches covered.">            if (maxOrder &gt; 1) {</span>
<span class="fc" id="L319">                Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(2, 0, 0)));</span>
<span class="fc" id="L320">                Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(0, 2, 0)));</span>
<span class="fc" id="L321">                Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(0, 0, 2)));</span>
<span class="fc" id="L322">                Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(1, 1, 0)));</span>
<span class="fc" id="L323">                Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(0, 1, 1)));</span>
<span class="fc" id="L324">                Assert.assertTrue(Double.isNaN(zeroZero.getPartialDerivative(1, 1, 0)));</span>
            }

            // very special case: 0^0 where the power is a primitive
<span class="fc" id="L328">            DerivativeStructure zeroDsZeroDouble = new DerivativeStructure(3,  maxOrder, 0, 0.0).pow(0.0);</span>
<span class="fc" id="L329">            boolean first = true;</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">            for (final double d : zeroDsZeroDouble.getAllDerivatives()) {</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L332">                    Assert.assertEquals(1.0, d, Precision.EPSILON);</span>
<span class="fc" id="L333">                    first = false;</span>
                } else {
<span class="fc" id="L335">                    Assert.assertEquals(0.0, d, Precision.SAFE_MIN);</span>
                }
            }
<span class="fc" id="L338">            DerivativeStructure zeroDsZeroInt = new DerivativeStructure(3,  maxOrder, 0, 0.0).pow(0);</span>
<span class="fc" id="L339">            first = true;</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">            for (final double d : zeroDsZeroInt.getAllDerivatives()) {</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L342">                    Assert.assertEquals(1.0, d, Precision.EPSILON);</span>
<span class="fc" id="L343">                    first = false;</span>
                } else {
<span class="fc" id="L345">                    Assert.assertEquals(0.0, d, Precision.SAFE_MIN);</span>
                }
            }

            // 0^p with p smaller than 1.0
<span class="fc" id="L350">            DerivativeStructure u = new DerivativeStructure(3, maxOrder, 1, -0.0).pow(0.25);</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">            for (int i0 = 0; i0 &lt;= maxOrder; ++i0) {</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">                for (int i1 = 0; i1 &lt;= maxOrder; ++i1) {</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">                    for (int i2 = 0; i2 &lt;= maxOrder; ++i2) {</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">                        if (i0 + i1 + i2 &lt;= maxOrder) {</span>
<span class="fc" id="L355">                            Assert.assertEquals(0.0, u.getPartialDerivative(i0, i1, i2), 1.0e-10);</span>
                        }
                    }
                }
            }
        }

<span class="fc" id="L362">    }</span>

    @Test
    public void testExpression() {
<span class="fc" id="L366">        double epsilon = 2.5e-13;</span>
<span class="fc bfc" id="L367" title="All 2 branches covered.">        for (double x = 0; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L368">            DerivativeStructure dsX = new DerivativeStructure(3, 5, 0, x);</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">            for (double y = 0; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L370">                DerivativeStructure dsY = new DerivativeStructure(3, 5, 1, y);</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">                for (double z = 0; z &gt;- 2; z -= 0.2) {</span>
<span class="fc" id="L372">                    DerivativeStructure dsZ = new DerivativeStructure(3, 5, 2, z);</span>

                    // f(x, y, z) = x + 5 x y - 2 z + (8 z x - y)^3
<span class="fc" id="L375">                    DerivativeStructure ds =</span>
                            new DerivativeStructure(1, dsX,
<span class="fc" id="L377">                                                    5, dsX.multiply(dsY),</span>
                                                    -2, dsZ,
<span class="fc" id="L379">                                                    1, new DerivativeStructure(8, dsZ.multiply(dsX),</span>
<span class="fc" id="L380">                                                                               -1, dsY).pow(3));</span>
<span class="fc" id="L381">                    DerivativeStructure dsOther =</span>
                            new DerivativeStructure(1, dsX,
<span class="fc" id="L383">                                                    5, dsX.multiply(dsY),</span>
<span class="fc" id="L384">                                                    -2, dsZ).add(new DerivativeStructure(8, dsZ.multiply(dsX),</span>
<span class="fc" id="L385">                                                                                         -1, dsY).pow(3));</span>
<span class="fc" id="L386">                    double f = x + 5 * x * y - 2 * z + FastMath.pow(8 * z * x - y, 3);</span>
<span class="fc" id="L387">                    Assert.assertEquals(f, ds.getValue(),</span>
<span class="fc" id="L388">                                        FastMath.abs(epsilon * f));</span>
<span class="fc" id="L389">                    Assert.assertEquals(f, dsOther.getValue(),</span>
<span class="fc" id="L390">                                        FastMath.abs(epsilon * f));</span>

                    // df/dx = 1 + 5 y + 24 (8 z x - y)^2 z
<span class="fc" id="L393">                    double dfdx = 1 + 5 * y + 24 * z * FastMath.pow(8 * z * x - y, 2);</span>
<span class="fc" id="L394">                    Assert.assertEquals(dfdx, ds.getPartialDerivative(1, 0, 0),</span>
<span class="fc" id="L395">                                        FastMath.abs(epsilon * dfdx));</span>
<span class="fc" id="L396">                    Assert.assertEquals(dfdx, dsOther.getPartialDerivative(1, 0, 0),</span>
<span class="fc" id="L397">                                        FastMath.abs(epsilon * dfdx));</span>

                    // df/dxdy = 5 + 48 z*(y - 8 z x)
<span class="fc" id="L400">                    double dfdxdy = 5 + 48 * z * (y - 8 * z * x);</span>
<span class="fc" id="L401">                    Assert.assertEquals(dfdxdy, ds.getPartialDerivative(1, 1, 0),</span>
<span class="fc" id="L402">                                        FastMath.abs(epsilon * dfdxdy));</span>
<span class="fc" id="L403">                    Assert.assertEquals(dfdxdy, dsOther.getPartialDerivative(1, 1, 0),</span>
<span class="fc" id="L404">                                        FastMath.abs(epsilon * dfdxdy));</span>

                    // df/dxdydz = 48 (y - 16 z x)
<span class="fc" id="L407">                    double dfdxdydz = 48 * (y - 16 * z * x);</span>
<span class="fc" id="L408">                    Assert.assertEquals(dfdxdydz, ds.getPartialDerivative(1, 1, 1),</span>
<span class="fc" id="L409">                                        FastMath.abs(epsilon * dfdxdydz));</span>
<span class="fc" id="L410">                    Assert.assertEquals(dfdxdydz, dsOther.getPartialDerivative(1, 1, 1),</span>
<span class="fc" id="L411">                                        FastMath.abs(epsilon * dfdxdydz));</span>

                }

            }
        }
<span class="fc" id="L417">    }</span>

    @Test
    public void testCompositionOneVariableX() {
<span class="fc" id="L421">        double epsilon = 1.0e-13;</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L423" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L424">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc bfc" id="L425" title="All 2 branches covered.">                for (double y = 0.1; y &lt; 1.2; y += 0.1) {</span>
<span class="fc" id="L426">                    DerivativeStructure dsY = new DerivativeStructure(1, maxOrder, y);</span>
<span class="fc" id="L427">                    DerivativeStructure f = dsX.divide(dsY).sqrt();</span>
<span class="fc" id="L428">                    double f0 = FastMath.sqrt(x / y);</span>
<span class="fc" id="L429">                    Assert.assertEquals(f0, f.getValue(), FastMath.abs(epsilon * f0));</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">                    if (f.getOrder() &gt; 0) {</span>
<span class="fc" id="L431">                        double f1 = 1 / (2 * FastMath.sqrt(x * y));</span>
<span class="fc" id="L432">                        Assert.assertEquals(f1, f.getPartialDerivative(1), FastMath.abs(epsilon * f1));</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">                        if (f.getOrder() &gt; 1) {</span>
<span class="fc" id="L434">                            double f2 = -f1 / (2 * x);</span>
<span class="fc" id="L435">                            Assert.assertEquals(f2, f.getPartialDerivative(2), FastMath.abs(epsilon * f2));</span>
<span class="fc bfc" id="L436" title="All 2 branches covered.">                            if (f.getOrder() &gt; 2) {</span>
<span class="fc" id="L437">                                double f3 = (f0 + x / (2 * y * f0)) / (4 * x * x * x);</span>
<span class="fc" id="L438">                                Assert.assertEquals(f3, f.getPartialDerivative(3), FastMath.abs(epsilon * f3));</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L445">    }</span>

    @Test
    public void testTrigo() {
<span class="fc" id="L449">        double epsilon = 2.0e-12;</span>
<span class="fc bfc" id="L450" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L452">                DerivativeStructure dsX = new DerivativeStructure(3, maxOrder, 0, x);</span>
<span class="fc bfc" id="L453" title="All 2 branches covered.">                for (double y = 0.1; y &lt; 1.2; y += 0.1) {</span>
<span class="fc" id="L454">                    DerivativeStructure dsY = new DerivativeStructure(3, maxOrder, 1, y);</span>
<span class="fc bfc" id="L455" title="All 2 branches covered.">                    for (double z = 0.1; z &lt; 1.2; z += 0.1) {</span>
<span class="fc" id="L456">                        DerivativeStructure dsZ = new DerivativeStructure(3, maxOrder, 2, z);</span>
<span class="fc" id="L457">                        DerivativeStructure f = dsX.divide(dsY.cos().add(dsZ.tan())).sin();</span>
<span class="fc" id="L458">                        double a = FastMath.cos(y) + FastMath.tan(z);</span>
<span class="fc" id="L459">                        double f0 = FastMath.sin(x / a);</span>
<span class="fc" id="L460">                        Assert.assertEquals(f0, f.getValue(), FastMath.abs(epsilon * f0));</span>
<span class="fc bfc" id="L461" title="All 2 branches covered.">                        if (f.getOrder() &gt; 0) {</span>
<span class="fc" id="L462">                            double dfdx = FastMath.cos(x / a) / a;</span>
<span class="fc" id="L463">                            Assert.assertEquals(dfdx, f.getPartialDerivative(1, 0, 0), FastMath.abs(epsilon * dfdx));</span>
<span class="fc" id="L464">                            double dfdy =  x * FastMath.sin(y) * dfdx / a;</span>
<span class="fc" id="L465">                            Assert.assertEquals(dfdy, f.getPartialDerivative(0, 1, 0), FastMath.abs(epsilon * dfdy));</span>
<span class="fc" id="L466">                            double cz = FastMath.cos(z);</span>
<span class="fc" id="L467">                            double cz2 = cz * cz;</span>
<span class="fc" id="L468">                            double dfdz = -x * dfdx / (a * cz2);</span>
<span class="fc" id="L469">                            Assert.assertEquals(dfdz, f.getPartialDerivative(0, 0, 1), FastMath.abs(epsilon * dfdz));</span>
<span class="fc bfc" id="L470" title="All 2 branches covered.">                            if (f.getOrder() &gt; 1) {</span>
<span class="fc" id="L471">                                double df2dx2 = -(f0 / (a * a));</span>
<span class="fc" id="L472">                                Assert.assertEquals(df2dx2, f.getPartialDerivative(2, 0, 0), FastMath.abs(epsilon * df2dx2));</span>
<span class="fc" id="L473">                                double df2dy2 = x * FastMath.cos(y) * dfdx / a -</span>
<span class="fc" id="L474">                                                x * x * FastMath.sin(y) * FastMath.sin(y) * f0 / (a * a * a * a) +</span>
<span class="fc" id="L475">                                                2 * FastMath.sin(y) * dfdy / a;</span>
<span class="fc" id="L476">                                Assert.assertEquals(df2dy2, f.getPartialDerivative(0, 2, 0), FastMath.abs(epsilon * df2dy2));</span>
<span class="fc" id="L477">                                double c4 = cz2 * cz2;</span>
<span class="fc" id="L478">                                double df2dz2 = x * (2 * a * (1 - a * cz * FastMath.sin(z)) * dfdx - x * f0 / a ) / (a * a * a * c4);</span>
<span class="fc" id="L479">                                Assert.assertEquals(df2dz2, f.getPartialDerivative(0, 0, 2), FastMath.abs(epsilon * df2dz2));</span>
<span class="fc" id="L480">                                double df2dxdy = dfdy / x  - x * FastMath.sin(y) * f0 / (a * a * a);</span>
<span class="fc" id="L481">                                Assert.assertEquals(df2dxdy, f.getPartialDerivative(1, 1, 0), FastMath.abs(epsilon * df2dxdy));</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L488">    }</span>

    @Test
    public void testSqrtDefinition() {
<span class="fc" id="L492">        double[] epsilon = new double[] { 5.0e-16, 5.0e-16, 2.0e-15, 5.0e-14, 2.0e-12 };</span>
<span class="fc bfc" id="L493" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L494" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L495">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L496">                DerivativeStructure sqrt1 = dsX.pow(0.5);</span>
<span class="fc" id="L497">                DerivativeStructure sqrt2 = dsX.sqrt();</span>
<span class="fc" id="L498">                DerivativeStructure zero = sqrt1.subtract(sqrt2);</span>
<span class="fc bfc" id="L499" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L500">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L504">    }</span>

    @Test
    public void testRootNSingularity() {
<span class="fc bfc" id="L508" title="All 2 branches covered.">        for (int n = 2; n &lt; 10; ++n) {</span>
<span class="fc bfc" id="L509" title="All 2 branches covered.">            for (int maxOrder = 0; maxOrder &lt; 12; ++maxOrder) {</span>
<span class="fc" id="L510">                DerivativeStructure dsZero = new DerivativeStructure(1, maxOrder, 0, 0.0);</span>
<span class="fc" id="L511">                DerivativeStructure rootN  = dsZero.rootN(n);</span>
<span class="fc" id="L512">                Assert.assertEquals(0.0, rootN.getValue(), 1.0e-20);</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">                if (maxOrder &gt; 0) {</span>
<span class="fc" id="L514">                    Assert.assertTrue(Double.isInfinite(rootN.getPartialDerivative(1)));</span>
<span class="pc bpc" id="L515" title="1 of 2 branches missed.">                    Assert.assertTrue(rootN.getPartialDerivative(1) &gt; 0);</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">                    for (int order = 2; order &lt;= maxOrder; ++order) {</span>
                        // the following checks shows a LIMITATION of the current implementation
                        // we have no way to tell dsZero is a pure linear variable x = 0
                        // we only say: &quot;dsZero is a structure with value = 0.0,
                        // first derivative = 1.0, second and higher derivatives = 0.0&quot;.
                        // Function composition rule for second derivatives is:
                        // d2[f(g(x))]/dx2 = f''(g(x)) * [g'(x)]^2 + f'(g(x)) * g''(x)
                        // when function f is the nth root and x = 0 we have:
                        // f(0) = 0, f'(0) = +infinity, f''(0) = -infinity (and higher
                        // derivatives keep switching between +infinity and -infinity)
                        // so given that in our case dsZero represents g, we have g(x) = 0,
                        // g'(x) = 1 and g''(x) = 0
                        // applying the composition rules gives:
                        // d2[f(g(x))]/dx2 = f''(g(x)) * [g'(x)]^2 + f'(g(x)) * g''(x)
                        //                 = -infinity * 1^2 + +infinity * 0
                        //                 = -infinity + NaN
                        //                 = NaN
                        // if we knew dsZero is really the x variable and not the identity
                        // function applied to x, we would not have computed f'(g(x)) * g''(x)
                        // and we would have found that the result was -infinity and not NaN
<span class="fc" id="L536">                        Assert.assertTrue(Double.isNaN(rootN.getPartialDerivative(order)));</span>
                    }
                }

                // the following shows that the limitation explained above is NOT a bug...
                // if we set up the higher order derivatives for g appropriately, we do
                // compute the higher order derivatives of the composition correctly
<span class="fc" id="L543">                double[] gDerivatives = new double[ 1 + maxOrder];</span>
<span class="fc" id="L544">                gDerivatives[0] = 0.0;</span>
<span class="fc bfc" id="L545" title="All 2 branches covered.">                for (int k = 1; k &lt;= maxOrder; ++k) {</span>
<span class="fc" id="L546">                    gDerivatives[k] = FastMath.pow(-1.0, k + 1);</span>
                }
<span class="fc" id="L548">                DerivativeStructure correctRoot = new DerivativeStructure(1, maxOrder, gDerivatives).rootN(n);</span>
<span class="fc" id="L549">                Assert.assertEquals(0.0, correctRoot.getValue(), 1.0e-20);</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">                if (maxOrder &gt; 0) {</span>
<span class="fc" id="L551">                    Assert.assertTrue(Double.isInfinite(correctRoot.getPartialDerivative(1)));</span>
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">                    Assert.assertTrue(correctRoot.getPartialDerivative(1) &gt; 0);</span>
<span class="fc bfc" id="L553" title="All 2 branches covered.">                    for (int order = 2; order &lt;= maxOrder; ++order) {</span>
<span class="fc" id="L554">                        Assert.assertTrue(Double.isInfinite(correctRoot.getPartialDerivative(order)));</span>
<span class="fc bfc" id="L555" title="All 2 branches covered.">                        if ((order % 2) == 0) {</span>
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">                            Assert.assertTrue(correctRoot.getPartialDerivative(order) &lt; 0);</span>
                        } else {
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">                            Assert.assertTrue(correctRoot.getPartialDerivative(order) &gt; 0);</span>
                        }
                    }
                }

            }

        }

<span class="fc" id="L567">    }</span>

    @Test
    public void testSqrtPow2() {
<span class="fc" id="L571">        double[] epsilon = new double[] { 1.0e-16, 3.0e-16, 2.0e-15, 6.0e-14, 6.0e-12 };</span>
<span class="fc bfc" id="L572" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L573" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L574">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L575">                DerivativeStructure rebuiltX = dsX.multiply(dsX).sqrt();</span>
<span class="fc" id="L576">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L578">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L582">    }</span>

    @Test
    public void testCbrtDefinition() {
<span class="fc" id="L586">        double[] epsilon = new double[] { 4.0e-16, 9.0e-16, 6.0e-15, 2.0e-13, 4.0e-12 };</span>
<span class="fc bfc" id="L587" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L589">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L590">                DerivativeStructure cbrt1 = dsX.pow(1.0 / 3.0);</span>
<span class="fc" id="L591">                DerivativeStructure cbrt2 = dsX.cbrt();</span>
<span class="fc" id="L592">                DerivativeStructure zero = cbrt1.subtract(cbrt2);</span>
<span class="fc bfc" id="L593" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L594">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L598">    }</span>

    @Test
    public void testCbrtPow3() {
<span class="fc" id="L602">        double[] epsilon = new double[] { 1.0e-16, 5.0e-16, 8.0e-15, 3.0e-13, 4.0e-11 };</span>
<span class="fc bfc" id="L603" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L604" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L605">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L606">                DerivativeStructure rebuiltX = dsX.multiply(dsX.multiply(dsX)).cbrt();</span>
<span class="fc" id="L607">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L608" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L609">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L613">    }</span>

    @Test
    public void testPowReciprocalPow() {
<span class="fc" id="L617">        double[] epsilon = new double[] { 2.0e-15, 2.0e-14, 3.0e-13, 8.0e-12, 3.0e-10 };</span>
<span class="fc bfc" id="L618" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L619" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.01) {</span>
<span class="fc" id="L620">                DerivativeStructure dsX = new DerivativeStructure(2, maxOrder, 0, x);</span>
<span class="fc bfc" id="L621" title="All 2 branches covered.">                for (double y = 0.1; y &lt; 1.2; y += 0.01) {</span>
<span class="fc" id="L622">                    DerivativeStructure dsY = new DerivativeStructure(2, maxOrder, 1, y);</span>
<span class="fc" id="L623">                    DerivativeStructure rebuiltX = dsX.pow(dsY).pow(dsY.reciprocal());</span>
<span class="fc" id="L624">                    DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L625" title="All 2 branches covered.">                    for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L626" title="All 2 branches covered.">                        for (int m = 0; m &lt;= maxOrder; ++m) {</span>
<span class="fc bfc" id="L627" title="All 2 branches covered.">                            if (n + m &lt;= maxOrder) {</span>
<span class="fc" id="L628">                                Assert.assertEquals(0.0, zero.getPartialDerivative(n, m), epsilon[n + m]);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L635">    }</span>

    @Test
    public void testHypotDefinition() {
<span class="fc" id="L639">        double epsilon = 1.0e-20;</span>
<span class="fc bfc" id="L640" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L641" title="All 2 branches covered.">            for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L642">                DerivativeStructure dsX = new DerivativeStructure(2, maxOrder, 0, x);</span>
<span class="fc bfc" id="L643" title="All 2 branches covered.">                for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L644">                    DerivativeStructure dsY = new DerivativeStructure(2, maxOrder, 1, y);</span>
<span class="fc" id="L645">                    DerivativeStructure hypot = DerivativeStructure.hypot(dsY, dsX);</span>
<span class="fc" id="L646">                    DerivativeStructure ref = dsX.multiply(dsX).add(dsY.multiply(dsY)).sqrt();</span>
<span class="fc" id="L647">                    DerivativeStructure zero = hypot.subtract(ref);</span>
<span class="fc bfc" id="L648" title="All 2 branches covered.">                    for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L649" title="All 2 branches covered.">                        for (int m = 0; m &lt;= maxOrder; ++m) {</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">                            if (n + m &lt;= maxOrder) {</span>
<span class="fc" id="L651">                                Assert.assertEquals(0, zero.getPartialDerivative(n, m), epsilon);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L658">    }</span>

    @Test
    public void testHypotNoOverflow() {

<span class="fc" id="L663">        DerivativeStructure dsX = new DerivativeStructure(2, 5, 0, +3.0e250);</span>
<span class="fc" id="L664">        DerivativeStructure dsY = new DerivativeStructure(2, 5, 1, -4.0e250);</span>
<span class="fc" id="L665">        DerivativeStructure hypot = DerivativeStructure.hypot(dsX, dsY);</span>
<span class="fc" id="L666">        Assert.assertEquals(5.0e250, hypot.getValue(), 1.0e235);</span>
<span class="fc" id="L667">        Assert.assertEquals(dsX.getValue() / hypot.getValue(), hypot.getPartialDerivative(1, 0), 1.0e-10);</span>
<span class="fc" id="L668">        Assert.assertEquals(dsY.getValue() / hypot.getValue(), hypot.getPartialDerivative(0, 1), 1.0e-10);</span>

<span class="fc" id="L670">        DerivativeStructure sqrt  = dsX.multiply(dsX).add(dsY.multiply(dsY)).sqrt();</span>
<span class="fc" id="L671">        Assert.assertTrue(Double.isInfinite(sqrt.getValue()));</span>

<span class="fc" id="L673">    }</span>

    @Test
    public void testHypotNeglectible() {

<span class="fc" id="L678">        DerivativeStructure dsSmall = new DerivativeStructure(2, 5, 0, +3.0e-10);</span>
<span class="fc" id="L679">        DerivativeStructure dsLarge = new DerivativeStructure(2, 5, 1, -4.0e25);</span>

<span class="fc" id="L681">        Assert.assertEquals(dsLarge.abs().getValue(),</span>
<span class="fc" id="L682">                            DerivativeStructure.hypot(dsSmall, dsLarge).getValue(),</span>
                            1.0e-10);
<span class="fc" id="L684">        Assert.assertEquals(0,</span>
<span class="fc" id="L685">                            DerivativeStructure.hypot(dsSmall, dsLarge).getPartialDerivative(1, 0),</span>
                            1.0e-10);
<span class="fc" id="L687">        Assert.assertEquals(-1,</span>
<span class="fc" id="L688">                            DerivativeStructure.hypot(dsSmall, dsLarge).getPartialDerivative(0, 1),</span>
                            1.0e-10);

<span class="fc" id="L691">        Assert.assertEquals(dsLarge.abs().getValue(),</span>
<span class="fc" id="L692">                            DerivativeStructure.hypot(dsLarge, dsSmall).getValue(),</span>
                            1.0e-10);
<span class="fc" id="L694">        Assert.assertEquals(0,</span>
<span class="fc" id="L695">                            DerivativeStructure.hypot(dsLarge, dsSmall).getPartialDerivative(1, 0),</span>
                            1.0e-10);
<span class="fc" id="L697">        Assert.assertEquals(-1,</span>
<span class="fc" id="L698">                            DerivativeStructure.hypot(dsLarge, dsSmall).getPartialDerivative(0, 1),</span>
                            1.0e-10);

<span class="fc" id="L701">    }</span>

    @Test
    public void testHypotSpecial() {
<span class="fc" id="L705">        Assert.assertTrue(Double.isNaN(DerivativeStructure.hypot(new DerivativeStructure(2, 5, 0, Double.NaN),</span>
<span class="fc" id="L706">                                                                 new DerivativeStructure(2, 5, 0, +3.0e250)).getValue()));</span>
<span class="fc" id="L707">        Assert.assertTrue(Double.isNaN(DerivativeStructure.hypot(new DerivativeStructure(2, 5, 0, +3.0e250),</span>
<span class="fc" id="L708">                                                                 new DerivativeStructure(2, 5, 0, Double.NaN)).getValue()));</span>
<span class="fc" id="L709">        Assert.assertTrue(Double.isInfinite(DerivativeStructure.hypot(new DerivativeStructure(2, 5, 0, Double.POSITIVE_INFINITY),</span>
<span class="fc" id="L710">                                                                      new DerivativeStructure(2, 5, 0, +3.0e250)).getValue()));</span>
<span class="fc" id="L711">        Assert.assertTrue(Double.isInfinite(DerivativeStructure.hypot(new DerivativeStructure(2, 5, 0, +3.0e250),</span>
<span class="fc" id="L712">                                                                      new DerivativeStructure(2, 5, 0, Double.POSITIVE_INFINITY)).getValue()));</span>
<span class="fc" id="L713">    }</span>

    @Test
    public void testPrimitiveRemainder() {
<span class="fc" id="L717">        double epsilon = 1.0e-15;</span>
<span class="fc bfc" id="L718" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L719" title="All 2 branches covered.">            for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L720">                DerivativeStructure dsX = new DerivativeStructure(2, maxOrder, 0, x);</span>
<span class="fc bfc" id="L721" title="All 2 branches covered.">                for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L722">                    DerivativeStructure remainder = dsX.remainder(y);</span>
<span class="fc" id="L723">                    DerivativeStructure ref = dsX.subtract(x - FastMath.IEEEremainder(x, y));</span>
<span class="fc" id="L724">                    DerivativeStructure zero = remainder.subtract(ref);</span>
<span class="fc bfc" id="L725" title="All 2 branches covered.">                    for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L726" title="All 2 branches covered.">                        for (int m = 0; m &lt;= maxOrder; ++m) {</span>
<span class="fc bfc" id="L727" title="All 2 branches covered.">                            if (n + m &lt;= maxOrder) {</span>
<span class="fc" id="L728">                                Assert.assertEquals(0, zero.getPartialDerivative(n, m), epsilon);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L735">    }</span>

    @Test
    public void testRemainder() {
<span class="fc" id="L739">        double epsilon = 2.0e-15;</span>
<span class="fc bfc" id="L740" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L741" title="All 2 branches covered.">            for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L742">                DerivativeStructure dsX = new DerivativeStructure(2, maxOrder, 0, x);</span>
<span class="fc bfc" id="L743" title="All 2 branches covered.">                for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L744">                    DerivativeStructure dsY = new DerivativeStructure(2, maxOrder, 1, y);</span>
<span class="fc" id="L745">                    DerivativeStructure remainder = dsX.remainder(dsY);</span>
<span class="fc" id="L746">                    DerivativeStructure ref = dsX.subtract(dsY.multiply((x - FastMath.IEEEremainder(x, y)) / y));</span>
<span class="fc" id="L747">                    DerivativeStructure zero = remainder.subtract(ref);</span>
<span class="fc bfc" id="L748" title="All 2 branches covered.">                    for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L749" title="All 2 branches covered.">                        for (int m = 0; m &lt;= maxOrder; ++m) {</span>
<span class="fc bfc" id="L750" title="All 2 branches covered.">                            if (n + m &lt;= maxOrder) {</span>
<span class="fc" id="L751">                                Assert.assertEquals(0, zero.getPartialDerivative(n, m), epsilon);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L758">    }</span>

    @Override
    @Test
    public void testExp() {
<span class="fc" id="L763">        double[] epsilon = new double[] { 1.0e-16, 1.0e-16, 1.0e-16, 1.0e-16, 1.0e-16 };</span>
<span class="fc bfc" id="L764" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L765" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L766">                double refExp = FastMath.exp(x);</span>
<span class="fc" id="L767">                DerivativeStructure exp = new DerivativeStructure(1, maxOrder, 0, x).exp();</span>
<span class="fc bfc" id="L768" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L769">                    Assert.assertEquals(refExp, exp.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L773">    }</span>

    @Test
    public void testExpm1Definition() {
<span class="fc" id="L777">        double epsilon = 3.0e-16;</span>
<span class="fc bfc" id="L778" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L779" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L780">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L781">                DerivativeStructure expm11 = dsX.expm1();</span>
<span class="fc" id="L782">                DerivativeStructure expm12 = dsX.exp().subtract(dsX.getField().getOne());</span>
<span class="fc" id="L783">                DerivativeStructure zero = expm11.subtract(expm12);</span>
<span class="fc bfc" id="L784" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L785">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon);</span>
                }
            }
        }
<span class="fc" id="L789">    }</span>

    @Override
    @Test
    public void testLog() {
<span class="fc" id="L794">        double[] epsilon = new double[] { 1.0e-16, 1.0e-16, 3.0e-14, 7.0e-13, 3.0e-11 };</span>
<span class="fc bfc" id="L795" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L796" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L797">                DerivativeStructure log = new DerivativeStructure(1, maxOrder, 0, x).log();</span>
<span class="fc" id="L798">                Assert.assertEquals(FastMath.log(x), log.getValue(), epsilon[0]);</span>
<span class="fc bfc" id="L799" title="All 2 branches covered.">                for (int n = 1; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L800">                    double refDer = -Factorial.value(n - 1) / FastMath.pow(-x, n);</span>
<span class="fc" id="L801">                    Assert.assertEquals(refDer, log.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L805">    }</span>

    @Test
    public void testLog1pDefinition() {
<span class="fc" id="L809">        double epsilon = 3.0e-16;</span>
<span class="fc bfc" id="L810" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L811" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L812">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L813">                DerivativeStructure log1p1 = dsX.log1p();</span>
<span class="fc" id="L814">                DerivativeStructure log1p2 = dsX.add(dsX.getField().getOne()).log();</span>
<span class="fc" id="L815">                DerivativeStructure zero = log1p1.subtract(log1p2);</span>
<span class="fc bfc" id="L816" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L817">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon);</span>
                }
            }
        }
<span class="fc" id="L821">    }</span>

    @Test
    public void testLog10Definition() {
<span class="fc" id="L825">        double[] epsilon = new double[] { 3.0e-16, 3.0e-16, 8.0e-15, 3.0e-13, 8.0e-12 };</span>
<span class="fc bfc" id="L826" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L827" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L828">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L829">                DerivativeStructure log101 = dsX.log10();</span>
<span class="fc" id="L830">                DerivativeStructure log102 = dsX.log().divide(FastMath.log(10.0));</span>
<span class="fc" id="L831">                DerivativeStructure zero = log101.subtract(log102);</span>
<span class="fc bfc" id="L832" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L833">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L837">    }</span>

    @Test
    public void testLogExp() {
<span class="fc" id="L841">        double[] epsilon = new double[] { 2.0e-16, 2.0e-16, 3.0e-16, 2.0e-15, 6.0e-15 };</span>
<span class="fc bfc" id="L842" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L843" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L844">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L845">                DerivativeStructure rebuiltX = dsX.exp().log();</span>
<span class="fc" id="L846">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L847" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L848">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L852">    }</span>

    @Test
    public void testLog1pExpm1() {
<span class="fc" id="L856">        double[] epsilon = new double[] { 6.0e-17, 3.0e-16, 5.0e-16, 9.0e-16, 6.0e-15 };</span>
<span class="fc bfc" id="L857" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L858" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L859">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L860">                DerivativeStructure rebuiltX = dsX.expm1().log1p();</span>
<span class="fc" id="L861">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L862" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L863">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L867">    }</span>

    @Test
    public void testLog10Power() {
<span class="fc" id="L871">        double[] epsilon = new double[] { 3.0e-16, 3.0e-16, 9.0e-16, 6.0e-15, 6.0e-14 };</span>
<span class="fc bfc" id="L872" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L873" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L874">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L875">                DerivativeStructure rebuiltX = new DerivativeStructure(1, maxOrder, 10.0).pow(dsX).log10();</span>
<span class="fc" id="L876">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L877" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L878">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L882">    }</span>

    @Test
    public void testSinCos() {
<span class="fc" id="L886">        double epsilon = 5.0e-16;</span>
<span class="fc bfc" id="L887" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L888" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L889">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L890">                DerivativeStructure sin = dsX.sin();</span>
<span class="fc" id="L891">                DerivativeStructure cos = dsX.cos();</span>
<span class="fc" id="L892">                double s = FastMath.sin(x);</span>
<span class="fc" id="L893">                double c = FastMath.cos(x);</span>
<span class="fc bfc" id="L894" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L895" title="All 4 branches covered.">                    switch (n % 4) {</span>
                    case 0 :
<span class="fc" id="L897">                        Assert.assertEquals( s, sin.getPartialDerivative(n), epsilon);</span>
<span class="fc" id="L898">                        Assert.assertEquals( c, cos.getPartialDerivative(n), epsilon);</span>
<span class="fc" id="L899">                        break;</span>
                    case 1 :
<span class="fc" id="L901">                        Assert.assertEquals( c, sin.getPartialDerivative(n), epsilon);</span>
<span class="fc" id="L902">                        Assert.assertEquals(-s, cos.getPartialDerivative(n), epsilon);</span>
<span class="fc" id="L903">                        break;</span>
                    case 2 :
<span class="fc" id="L905">                        Assert.assertEquals(-s, sin.getPartialDerivative(n), epsilon);</span>
<span class="fc" id="L906">                        Assert.assertEquals(-c, cos.getPartialDerivative(n), epsilon);</span>
<span class="fc" id="L907">                        break;</span>
                    default :
<span class="fc" id="L909">                        Assert.assertEquals(-c, sin.getPartialDerivative(n), epsilon);</span>
<span class="fc" id="L910">                        Assert.assertEquals( s, cos.getPartialDerivative(n), epsilon);</span>
                        break;
                    }
                }
            }
        }
<span class="fc" id="L916">    }</span>

    @Test
    public void testSinAsin() {
<span class="fc" id="L920">        double[] epsilon = new double[] { 3.0e-16, 5.0e-16, 3.0e-15, 2.0e-14, 4.0e-13 };</span>
<span class="fc bfc" id="L921" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L922" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L923">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L924">                DerivativeStructure rebuiltX = dsX.sin().asin();</span>
<span class="fc" id="L925">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L926" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L927">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L931">    }</span>

    @Test
    public void testCosAcos() {
<span class="fc" id="L935">        double[] epsilon = new double[] { 6.0e-16, 6.0e-15, 2.0e-13, 4.0e-12, 2.0e-10 };</span>
<span class="fc bfc" id="L936" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L937" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L938">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L939">                DerivativeStructure rebuiltX = dsX.cos().acos();</span>
<span class="fc" id="L940">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L941" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L942">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L946">    }</span>

    @Test
    public void testTanAtan() {
<span class="fc" id="L950">        double[] epsilon = new double[] { 6.0e-17, 2.0e-16, 2.0e-15, 4.0e-14, 2.0e-12 };</span>
<span class="fc bfc" id="L951" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L952" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L953">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L954">                DerivativeStructure rebuiltX = dsX.tan().atan();</span>
<span class="fc" id="L955">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L956" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L957">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L961">    }</span>

    @Test
    public void testTangentDefinition() {
<span class="fc" id="L965">        double[] epsilon = new double[] { 5.0e-16, 2.0e-15, 3.0e-14, 5.0e-13, 2.0e-11 };</span>
<span class="fc bfc" id="L966" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L967" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L968">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L969">                DerivativeStructure tan1 = dsX.sin().divide(dsX.cos());</span>
<span class="fc" id="L970">                DerivativeStructure tan2 = dsX.tan();</span>
<span class="fc" id="L971">                DerivativeStructure zero = tan1.subtract(tan2);</span>
<span class="fc bfc" id="L972" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L973">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L977">    }</span>

    @Override
    @Test
    public void testAtan2() {
<span class="fc" id="L982">        double[] epsilon = new double[] { 5.0e-16, 3.0e-15, 2.2e-14, 1.0e-12, 8.0e-11 };</span>
<span class="fc bfc" id="L983" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L984" title="All 2 branches covered.">            for (double x = -1.7; x &lt; 2; x += 0.2) {</span>
<span class="fc" id="L985">                DerivativeStructure dsX = new DerivativeStructure(2, maxOrder, 0, x);</span>
<span class="fc bfc" id="L986" title="All 2 branches covered.">                for (double y = -1.7; y &lt; 2; y += 0.2) {</span>
<span class="fc" id="L987">                    DerivativeStructure dsY = new DerivativeStructure(2, maxOrder, 1, y);</span>
<span class="fc" id="L988">                    DerivativeStructure atan2 = DerivativeStructure.atan2(dsY, dsX);</span>
<span class="fc" id="L989">                    DerivativeStructure ref = dsY.divide(dsX).atan();</span>
<span class="fc bfc" id="L990" title="All 2 branches covered.">                    if (x &lt; 0) {</span>
<span class="fc bfc" id="L991" title="All 2 branches covered.">                        ref = (y &lt; 0) ? ref.subtract(FastMath.PI) : ref.add(FastMath.PI);</span>
                    }
<span class="fc" id="L993">                    DerivativeStructure zero = atan2.subtract(ref);</span>
<span class="fc bfc" id="L994" title="All 2 branches covered.">                    for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L995" title="All 2 branches covered.">                        for (int m = 0; m &lt;= maxOrder; ++m) {</span>
<span class="fc bfc" id="L996" title="All 2 branches covered.">                            if (n + m &lt;= maxOrder) {</span>
<span class="fc" id="L997">                                Assert.assertEquals(0, zero.getPartialDerivative(n, m), epsilon[n + m]);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L1004">    }</span>

    @Test
    public void testAtan2SpecialCases() {

<span class="fc" id="L1009">        DerivativeStructure pp =</span>
<span class="fc" id="L1010">                DerivativeStructure.atan2(new DerivativeStructure(2, 2, 1, +0.0),</span>
                                          new DerivativeStructure(2, 2, 1, +0.0));
<span class="fc" id="L1012">        Assert.assertEquals(0, pp.getValue(), 1.0e-15);</span>
<span class="fc" id="L1013">        Assert.assertEquals(+1, FastMath.copySign(1, pp.getValue()), 1.0e-15);</span>

<span class="fc" id="L1015">        DerivativeStructure pn =</span>
<span class="fc" id="L1016">                DerivativeStructure.atan2(new DerivativeStructure(2, 2, 1, +0.0),</span>
                                          new DerivativeStructure(2, 2, 1, -0.0));
<span class="fc" id="L1018">        Assert.assertEquals(FastMath.PI, pn.getValue(), 1.0e-15);</span>

<span class="fc" id="L1020">        DerivativeStructure np =</span>
<span class="fc" id="L1021">                DerivativeStructure.atan2(new DerivativeStructure(2, 2, 1, -0.0),</span>
                                          new DerivativeStructure(2, 2, 1, +0.0));
<span class="fc" id="L1023">        Assert.assertEquals(0, np.getValue(), 1.0e-15);</span>
<span class="fc" id="L1024">        Assert.assertEquals(-1, FastMath.copySign(1, np.getValue()), 1.0e-15);</span>

<span class="fc" id="L1026">        DerivativeStructure nn =</span>
<span class="fc" id="L1027">                DerivativeStructure.atan2(new DerivativeStructure(2, 2, 1, -0.0),</span>
                                          new DerivativeStructure(2, 2, 1, -0.0));
<span class="fc" id="L1029">        Assert.assertEquals(-FastMath.PI, nn.getValue(), 1.0e-15);</span>

<span class="fc" id="L1031">    }</span>

    @Test
    public void testSinhDefinition() {
<span class="fc" id="L1035">        double[] epsilon = new double[] { 3.0e-16, 3.0e-16, 5.0e-16, 2.0e-15, 6.0e-15 };</span>
<span class="fc bfc" id="L1036" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L1037" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1038">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1039">                DerivativeStructure sinh1 = dsX.exp().subtract(dsX.exp().reciprocal()).multiply(0.5);</span>
<span class="fc" id="L1040">                DerivativeStructure sinh2 = dsX.sinh();</span>
<span class="fc" id="L1041">                DerivativeStructure zero = sinh1.subtract(sinh2);</span>
<span class="fc bfc" id="L1042" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1043">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L1047">    }</span>

    @Test
    public void testCoshDefinition() {
<span class="fc" id="L1051">        double[] epsilon = new double[] { 3.0e-16, 3.0e-16, 5.0e-16, 2.0e-15, 6.0e-15 };</span>
<span class="fc bfc" id="L1052" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L1053" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1054">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1055">                DerivativeStructure cosh1 = dsX.exp().add(dsX.exp().reciprocal()).multiply(0.5);</span>
<span class="fc" id="L1056">                DerivativeStructure cosh2 = dsX.cosh();</span>
<span class="fc" id="L1057">                DerivativeStructure zero = cosh1.subtract(cosh2);</span>
<span class="fc bfc" id="L1058" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1059">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L1063">    }</span>

    @Test
    public void testTanhDefinition() {
<span class="fc" id="L1067">        double[] epsilon = new double[] { 3.0e-16, 5.0e-16, 7.0e-16, 3.0e-15, 2.0e-14 };</span>
<span class="fc bfc" id="L1068" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L1069" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1070">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1071">                DerivativeStructure tanh1 = dsX.exp().subtract(dsX.exp().reciprocal()).divide(dsX.exp().add(dsX.exp().reciprocal()));</span>
<span class="fc" id="L1072">                DerivativeStructure tanh2 = dsX.tanh();</span>
<span class="fc" id="L1073">                DerivativeStructure zero = tanh1.subtract(tanh2);</span>
<span class="fc bfc" id="L1074" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1075">                    Assert.assertEquals(0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L1079">    }</span>

    @Test
    public void testSinhAsinh() {
<span class="fc" id="L1083">        double[] epsilon = new double[] { 3.0e-16, 3.0e-16, 4.0e-16, 7.0e-16, 3.0e-15, 8.0e-15 };</span>
<span class="fc bfc" id="L1084" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L1085" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1086">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1087">                DerivativeStructure rebuiltX = dsX.sinh().asinh();</span>
<span class="fc" id="L1088">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L1089" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1090">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L1094">    }</span>

    @Test
    public void testCoshAcosh() {
<span class="fc" id="L1098">        double[] epsilon = new double[] { 2.0e-15, 1.0e-14, 2.0e-13, 6.0e-12, 3.0e-10, 2.0e-8 };</span>
<span class="fc bfc" id="L1099" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L1100" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1101">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1102">                DerivativeStructure rebuiltX = dsX.cosh().acosh();</span>
<span class="fc" id="L1103">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L1104" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1105">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L1109">    }</span>

    @Test
    public void testTanhAtanh() {
<span class="fc" id="L1113">        double[] epsilon = new double[] { 3.0e-16, 2.0e-16, 7.0e-16, 4.0e-15, 3.0e-14, 4.0e-13 };</span>
<span class="fc bfc" id="L1114" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L1115" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1116">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1117">                DerivativeStructure rebuiltX = dsX.tanh().atanh();</span>
<span class="fc" id="L1118">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L1119" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1120">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L1124">    }</span>

    @Test
    public void testCompositionOneVariableY() {
<span class="fc" id="L1128">        double epsilon = 1.0e-13;</span>
<span class="fc bfc" id="L1129" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc bfc" id="L1130" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L1131">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, x);</span>
<span class="fc bfc" id="L1132" title="All 2 branches covered.">                for (double y = 0.1; y &lt; 1.2; y += 0.1) {</span>
<span class="fc" id="L1133">                    DerivativeStructure dsY = new DerivativeStructure(1, maxOrder, 0, y);</span>
<span class="fc" id="L1134">                    DerivativeStructure f = dsX.divide(dsY).sqrt();</span>
<span class="fc" id="L1135">                    double f0 = FastMath.sqrt(x / y);</span>
<span class="fc" id="L1136">                    Assert.assertEquals(f0, f.getValue(), FastMath.abs(epsilon * f0));</span>
<span class="fc bfc" id="L1137" title="All 2 branches covered.">                    if (f.getOrder() &gt; 0) {</span>
<span class="fc" id="L1138">                        double f1 = -x / (2 * y * y * f0);</span>
<span class="fc" id="L1139">                        Assert.assertEquals(f1, f.getPartialDerivative(1), FastMath.abs(epsilon * f1));</span>
<span class="fc bfc" id="L1140" title="All 2 branches covered.">                        if (f.getOrder() &gt; 1) {</span>
<span class="fc" id="L1141">                            double f2 = (f0 - x / (4 * y * f0)) / (y * y);</span>
<span class="fc" id="L1142">                            Assert.assertEquals(f2, f.getPartialDerivative(2), FastMath.abs(epsilon * f2));</span>
<span class="fc bfc" id="L1143" title="All 2 branches covered.">                            if (f.getOrder() &gt; 2) {</span>
<span class="fc" id="L1144">                                double f3 = (x / (8 * y * f0) - 2 * f0) / (y * y * y);</span>
<span class="fc" id="L1145">                                Assert.assertEquals(f3, f.getPartialDerivative(3), FastMath.abs(epsilon * f3));</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L1152">    }</span>

    @Test
    public void testTaylorPolynomial() {
<span class="fc bfc" id="L1156" title="All 2 branches covered.">        for (double x = 0; x &lt; 1.2; x += 0.1) {</span>
<span class="fc" id="L1157">            DerivativeStructure dsX = new DerivativeStructure(3, 4, 0, x);</span>
<span class="fc bfc" id="L1158" title="All 2 branches covered.">            for (double y = 0; y &lt; 1.2; y += 0.2) {</span>
<span class="fc" id="L1159">                DerivativeStructure dsY = new DerivativeStructure(3, 4, 1, y);</span>
<span class="fc bfc" id="L1160" title="All 2 branches covered.">                for (double z = 0; z &lt; 1.2; z += 0.2) {</span>
<span class="fc" id="L1161">                    DerivativeStructure dsZ = new DerivativeStructure(3, 4, 2, z);</span>
<span class="fc" id="L1162">                    DerivativeStructure f = dsX.multiply(dsY).add(dsZ).multiply(dsX).multiply(dsY);</span>
<span class="fc bfc" id="L1163" title="All 2 branches covered.">                    for (double dx = -0.2; dx &lt; 0.2; dx += 0.2) {</span>
<span class="fc bfc" id="L1164" title="All 2 branches covered.">                        for (double dy = -0.2; dy &lt; 0.2; dy += 0.1) {</span>
<span class="fc bfc" id="L1165" title="All 2 branches covered.">                            for (double dz = -0.2; dz &lt; 0.2; dz += 0.1) {</span>
<span class="fc" id="L1166">                                double ref = (x + dx) * (y + dy) * ((x + dx) * (y + dy) + (z + dz));</span>
<span class="fc" id="L1167">                                Assert.assertEquals(ref, f.taylor(dx, dy, dz), 2.0e-15);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L1174">    }</span>

    @Test
    public void testTaylorAtan2() {
<span class="fc" id="L1178">        double[] expected = new double[] { 0.214, 0.0241, 0.00422, 6.48e-4, 8.04e-5 };</span>
<span class="fc" id="L1179">        double x0 =  0.1;</span>
<span class="fc" id="L1180">        double y0 = -0.3;</span>
<span class="fc bfc" id="L1181" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L1182">            DerivativeStructure dsX   = new DerivativeStructure(2, maxOrder, 0, x0);</span>
<span class="fc" id="L1183">            DerivativeStructure dsY   = new DerivativeStructure(2, maxOrder, 1, y0);</span>
<span class="fc" id="L1184">            DerivativeStructure atan2 = DerivativeStructure.atan2(dsY, dsX);</span>
<span class="fc" id="L1185">            double maxError = 0;</span>
<span class="fc bfc" id="L1186" title="All 2 branches covered.">            for (double dx = -0.05; dx &lt; 0.05; dx += 0.001) {</span>
<span class="fc bfc" id="L1187" title="All 2 branches covered.">                for (double dy = -0.05; dy &lt; 0.05; dy += 0.001) {</span>
<span class="fc" id="L1188">                    double ref = FastMath.atan2(y0 + dy, x0 + dx);</span>
<span class="fc" id="L1189">                    maxError = FastMath.max(maxError, FastMath.abs(ref - atan2.taylor(dx, dy)));</span>
                }
            }
<span class="fc" id="L1192">            Assert.assertEquals(0.0, expected[maxOrder] - maxError, 0.01 * expected[maxOrder]);</span>
        }
<span class="fc" id="L1194">    }</span>

    @Override
    @Test
    public void testAbs() {

<span class="fc" id="L1200">        DerivativeStructure minusOne = new DerivativeStructure(1, 1, 0, -1.0);</span>
<span class="fc" id="L1201">        Assert.assertEquals(+1.0, minusOne.abs().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1202">        Assert.assertEquals(-1.0, minusOne.abs().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1204">        DerivativeStructure plusOne = new DerivativeStructure(1, 1, 0, +1.0);</span>
<span class="fc" id="L1205">        Assert.assertEquals(+1.0, plusOne.abs().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1206">        Assert.assertEquals(+1.0, plusOne.abs().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1208">        DerivativeStructure minusZero = new DerivativeStructure(1, 1, 0, -0.0);</span>
<span class="fc" id="L1209">        Assert.assertEquals(+0.0, minusZero.abs().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1210">        Assert.assertEquals(-1.0, minusZero.abs().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1212">        DerivativeStructure plusZero = new DerivativeStructure(1, 1, 0, +0.0);</span>
<span class="fc" id="L1213">        Assert.assertEquals(+0.0, plusZero.abs().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1214">        Assert.assertEquals(+1.0, plusZero.abs().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1216">    }</span>

    @Override
    @Test
    public void testSignum() {

<span class="fc" id="L1222">        DerivativeStructure minusOne = new DerivativeStructure(1, 1, 0, -1.0);</span>
<span class="fc" id="L1223">        Assert.assertEquals(-1.0, minusOne.signum().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1224">        Assert.assertEquals( 0.0, minusOne.signum().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1226">        DerivativeStructure plusOne = new DerivativeStructure(1, 1, 0, +1.0);</span>
<span class="fc" id="L1227">        Assert.assertEquals(+1.0, plusOne.signum().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1228">        Assert.assertEquals( 0.0, plusOne.signum().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1230">        DerivativeStructure minusZero = new DerivativeStructure(1, 1, 0, -0.0);</span>
<span class="fc" id="L1231">        Assert.assertEquals(-0.0, minusZero.signum().getPartialDerivative(0), 1.0e-15);</span>
<span class="pc bpc" id="L1232" title="1 of 2 branches missed.">        Assert.assertTrue(Double.doubleToLongBits(minusZero.signum().getValue()) &lt; 0);</span>
<span class="fc" id="L1233">        Assert.assertEquals( 0.0, minusZero.signum().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1235">        DerivativeStructure plusZero = new DerivativeStructure(1, 1, 0, +0.0);</span>
<span class="fc" id="L1236">        Assert.assertEquals(+0.0, plusZero.signum().getPartialDerivative(0), 1.0e-15);</span>
<span class="pc bpc" id="L1237" title="1 of 2 branches missed.">        Assert.assertTrue(Double.doubleToLongBits(plusZero.signum().getValue()) == 0);</span>
<span class="fc" id="L1238">        Assert.assertEquals( 0.0, plusZero.signum().getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1240">    }</span>

    @Test
    public void testCeilFloorRintLong() {

<span class="fc" id="L1245">        DerivativeStructure x = new DerivativeStructure(1, 1, 0, -1.5);</span>
<span class="fc" id="L1246">        Assert.assertEquals(-1.5, x.getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1247">        Assert.assertEquals(+1.0, x.getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1248">        Assert.assertEquals(-1.0, x.ceil().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1249">        Assert.assertEquals(+0.0, x.ceil().getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1250">        Assert.assertEquals(-2.0, x.floor().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1251">        Assert.assertEquals(+0.0, x.floor().getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1252">        Assert.assertEquals(-2.0, x.rint().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1253">        Assert.assertEquals(+0.0, x.rint().getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1254">        Assert.assertEquals(-2.0, x.subtract(x.getField().getOne()).rint().getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1255">        Assert.assertEquals(-1l, x.round());</span>

<span class="fc" id="L1257">    }</span>

    @Test
    public void testCopySign() {

<span class="fc" id="L1262">        DerivativeStructure minusOne = new DerivativeStructure(1, 1, 0, -1.0);</span>
<span class="fc" id="L1263">        Assert.assertEquals(+1.0, minusOne.copySign(+1.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1264">        Assert.assertEquals(-1.0, minusOne.copySign(+1.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1265">        Assert.assertEquals(-1.0, minusOne.copySign(-1.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1266">        Assert.assertEquals(+1.0, minusOne.copySign(-1.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1267">        Assert.assertEquals(+1.0, minusOne.copySign(+0.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1268">        Assert.assertEquals(-1.0, minusOne.copySign(+0.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1269">        Assert.assertEquals(-1.0, minusOne.copySign(-0.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1270">        Assert.assertEquals(+1.0, minusOne.copySign(-0.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1271">        Assert.assertEquals(+1.0, minusOne.copySign(Double.NaN).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1272">        Assert.assertEquals(-1.0, minusOne.copySign(Double.NaN).getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1274">        DerivativeStructure plusOne = new DerivativeStructure(1, 1, 0, +1.0);</span>
<span class="fc" id="L1275">        Assert.assertEquals(+1.0, plusOne.copySign(+1.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1276">        Assert.assertEquals(+1.0, plusOne.copySign(+1.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1277">        Assert.assertEquals(-1.0, plusOne.copySign(-1.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1278">        Assert.assertEquals(-1.0, plusOne.copySign(-1.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1279">        Assert.assertEquals(+1.0, plusOne.copySign(+0.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1280">        Assert.assertEquals(+1.0, plusOne.copySign(+0.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1281">        Assert.assertEquals(-1.0, plusOne.copySign(-0.0).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1282">        Assert.assertEquals(-1.0, plusOne.copySign(-0.0).getPartialDerivative(1), 1.0e-15);</span>
<span class="fc" id="L1283">        Assert.assertEquals(+1.0, plusOne.copySign(Double.NaN).getPartialDerivative(0), 1.0e-15);</span>
<span class="fc" id="L1284">        Assert.assertEquals(+1.0, plusOne.copySign(Double.NaN).getPartialDerivative(1), 1.0e-15);</span>

<span class="fc" id="L1286">    }</span>

    @Test
    public void testToDegreesDefinition() {
<span class="fc" id="L1290">        double epsilon = 3.0e-16;</span>
<span class="fc bfc" id="L1291" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L1292" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1293">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1294">                Assert.assertEquals(FastMath.toDegrees(x), dsX.toDegrees().getValue(), epsilon);</span>
<span class="fc bfc" id="L1295" title="All 2 branches covered.">                for (int n = 1; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L1296" title="All 2 branches covered.">                    if (n == 1) {</span>
<span class="fc" id="L1297">                        Assert.assertEquals(180 / FastMath.PI, dsX.toDegrees().getPartialDerivative(1), epsilon);</span>
                    } else {
<span class="fc" id="L1299">                        Assert.assertEquals(0.0, dsX.toDegrees().getPartialDerivative(n), epsilon);</span>
                    }
                }
            }
        }
<span class="fc" id="L1304">    }</span>

    @Test
    public void testToRadiansDefinition() {
<span class="fc" id="L1308">        double epsilon = 3.0e-16;</span>
<span class="fc bfc" id="L1309" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L1310" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1311">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1312">                Assert.assertEquals(FastMath.toRadians(x), dsX.toRadians().getValue(), epsilon);</span>
<span class="fc bfc" id="L1313" title="All 2 branches covered.">                for (int n = 1; n &lt;= maxOrder; ++n) {</span>
<span class="fc bfc" id="L1314" title="All 2 branches covered.">                    if (n == 1) {</span>
<span class="fc" id="L1315">                        Assert.assertEquals(FastMath.PI / 180, dsX.toRadians().getPartialDerivative(1), epsilon);</span>
                    } else {
<span class="fc" id="L1317">                        Assert.assertEquals(0.0, dsX.toRadians().getPartialDerivative(n), epsilon);</span>
                    }
                }
            }
        }
<span class="fc" id="L1322">    }</span>

    @Test
    public void testDegRad() {
<span class="fc" id="L1326">        double epsilon = 3.0e-16;</span>
<span class="fc bfc" id="L1327" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc bfc" id="L1328" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1329">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1330">                DerivativeStructure rebuiltX = dsX.toDegrees().toRadians();</span>
<span class="fc" id="L1331">                DerivativeStructure zero = rebuiltX.subtract(dsX);</span>
<span class="fc bfc" id="L1332" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1333">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon);</span>
                }
            }
        }
<span class="fc" id="L1337">    }</span>

    @Test(expected=DimensionMismatchException.class)
    public void testComposeMismatchedDimensions() {
<span class="nc" id="L1341">        new DerivativeStructure(1, 3, 0, 1.2).compose(new double[3]);</span>
<span class="nc" id="L1342">    }</span>

    @Test
    public void testCompose() {
<span class="fc" id="L1346">        double[] epsilon = new double[] { 1.0e-20, 5.0e-14, 2.0e-13, 3.0e-13, 2.0e-13, 1.0e-20 };</span>
<span class="fc" id="L1347">        PolynomialFunction poly =</span>
                new PolynomialFunction(new double[] { 1.0, 2.0, 3.0, 4.0, 5.0, 6.0 });
<span class="fc bfc" id="L1349" title="All 2 branches covered.">        for (int maxOrder = 0; maxOrder &lt; 6; ++maxOrder) {</span>
<span class="fc" id="L1350">            PolynomialFunction[] p = new PolynomialFunction[maxOrder + 1];</span>
<span class="fc" id="L1351">            p[0] = poly;</span>
<span class="fc bfc" id="L1352" title="All 2 branches covered.">            for (int i = 1; i &lt;= maxOrder; ++i) {</span>
<span class="fc" id="L1353">                p[i] = p[i - 1].polynomialDerivative();</span>
            }
<span class="fc bfc" id="L1355" title="All 2 branches covered.">            for (double x = 0.1; x &lt; 1.2; x += 0.001) {</span>
<span class="fc" id="L1356">                DerivativeStructure dsX = new DerivativeStructure(1, maxOrder, 0, x);</span>
<span class="fc" id="L1357">                DerivativeStructure dsY1 = dsX.getField().getZero();</span>
<span class="fc bfc" id="L1358" title="All 2 branches covered.">                for (int i = poly.degree(); i &gt;= 0; --i) {</span>
<span class="fc" id="L1359">                    dsY1 = dsY1.multiply(dsX).add(poly.getCoefficients()[i]);</span>
                }
<span class="fc" id="L1361">                double[] f = new double[maxOrder + 1];</span>
<span class="fc bfc" id="L1362" title="All 2 branches covered.">                for (int i = 0; i &lt; f.length; ++i) {</span>
<span class="fc" id="L1363">                    f[i] = p[i].value(x);</span>
                }
<span class="fc" id="L1365">                DerivativeStructure dsY2 = dsX.compose(f);</span>
<span class="fc" id="L1366">                DerivativeStructure zero = dsY1.subtract(dsY2);</span>
<span class="fc bfc" id="L1367" title="All 2 branches covered.">                for (int n = 0; n &lt;= maxOrder; ++n) {</span>
<span class="fc" id="L1368">                    Assert.assertEquals(0.0, zero.getPartialDerivative(n), epsilon[n]);</span>
                }
            }
        }
<span class="fc" id="L1372">    }</span>

    @Test
    public void testField() {
<span class="fc bfc" id="L1376" title="All 2 branches covered.">        for (int maxOrder = 1; maxOrder &lt; 5; ++maxOrder) {</span>
<span class="fc" id="L1377">            DerivativeStructure x = new DerivativeStructure(3, maxOrder, 0, 1.0);</span>
<span class="fc" id="L1378">            checkF0F1(x.getField().getZero(), 0.0, 0.0, 0.0, 0.0);</span>
<span class="fc" id="L1379">            checkF0F1(x.getField().getOne(), 1.0, 0.0, 0.0, 0.0);</span>
<span class="fc" id="L1380">            Assert.assertEquals(maxOrder, x.getField().getZero().getOrder());</span>
<span class="fc" id="L1381">            Assert.assertEquals(3, x.getField().getZero().getFreeParameters());</span>
<span class="fc" id="L1382">            Assert.assertEquals(DerivativeStructure.class, x.getField().getRuntimeClass());</span>
        }
<span class="fc" id="L1384">    }</span>

    @Test
    public void testOneParameterConstructor() {
<span class="fc" id="L1388">        double x = 1.2;</span>
<span class="fc" id="L1389">        double cos = FastMath.cos(x);</span>
<span class="fc" id="L1390">        double sin = FastMath.sin(x);</span>
<span class="fc" id="L1391">        DerivativeStructure yRef = new DerivativeStructure(1, 4, 0, x).cos();</span>
        try {
<span class="nc" id="L1393">            new DerivativeStructure(1, 4, 0.0, 0.0);</span>
<span class="nc" id="L1394">            Assert.fail(&quot;an exception should have been thrown&quot;);</span>
<span class="fc" id="L1395">        } catch (DimensionMismatchException dme) {</span>
            // expected
<span class="nc" id="L1397">        } catch (Exception e) {</span>
<span class="nc" id="L1398">            Assert.fail(&quot;wrong exceptionc caught &quot; + e.getClass().getName());</span>
<span class="pc" id="L1399">        }</span>
<span class="fc" id="L1400">        double[] derivatives = new double[] { cos, -sin, -cos, sin, cos };</span>
<span class="fc" id="L1401">        DerivativeStructure y = new DerivativeStructure(1,  4, derivatives);</span>
<span class="fc" id="L1402">        checkEquals(yRef, y, 1.0e-15);</span>
<span class="fc" id="L1403">        TestUtils.assertEquals(derivatives, y.getAllDerivatives(), 1.0e-15);</span>
<span class="fc" id="L1404">    }</span>

    @Test
    public void testOneOrderConstructor() {
<span class="fc" id="L1408">        double x =  1.2;</span>
<span class="fc" id="L1409">        double y =  2.4;</span>
<span class="fc" id="L1410">        double z = 12.5;</span>
<span class="fc" id="L1411">        DerivativeStructure xRef = new DerivativeStructure(3, 1, 0, x);</span>
<span class="fc" id="L1412">        DerivativeStructure yRef = new DerivativeStructure(3, 1, 1, y);</span>
<span class="fc" id="L1413">        DerivativeStructure zRef = new DerivativeStructure(3, 1, 2, z);</span>
        try {
<span class="nc" id="L1415">            new DerivativeStructure(3, 1, x + y - z, 1.0, 1.0);</span>
<span class="nc" id="L1416">            Assert.fail(&quot;an exception should have been thrown&quot;);</span>
<span class="fc" id="L1417">        } catch (DimensionMismatchException dme) {</span>
            // expected
<span class="nc" id="L1419">        } catch (Exception e) {</span>
<span class="nc" id="L1420">            Assert.fail(&quot;wrong exceptionc caught &quot; + e.getClass().getName());</span>
<span class="pc" id="L1421">        }</span>
<span class="fc" id="L1422">        double[] derivatives = new double[] { x + y - z, 1.0, 1.0, -1.0 };</span>
<span class="fc" id="L1423">        DerivativeStructure t = new DerivativeStructure(3, 1, derivatives);</span>
<span class="fc" id="L1424">        checkEquals(xRef.add(yRef.subtract(zRef)), t, 1.0e-15);</span>
<span class="fc" id="L1425">        TestUtils.assertEquals(derivatives, xRef.add(yRef.subtract(zRef)).getAllDerivatives(), 1.0e-15);</span>
<span class="fc" id="L1426">    }</span>

    @Test
    public void testLinearCombination1DSDS() {
<span class="fc" id="L1430">        final DerivativeStructure[] a = new DerivativeStructure[] {</span>
            new DerivativeStructure(6, 1, 0, -1321008684645961.0 / 268435456.0),
            new DerivativeStructure(6, 1, 1, -5774608829631843.0 / 268435456.0),
            new DerivativeStructure(6, 1, 2, -7645843051051357.0 / 8589934592.0)
        };
<span class="fc" id="L1435">        final DerivativeStructure[] b = new DerivativeStructure[] {</span>
            new DerivativeStructure(6, 1, 3, -5712344449280879.0 / 2097152.0),
            new DerivativeStructure(6, 1, 4, -4550117129121957.0 / 2097152.0),
            new DerivativeStructure(6, 1, 5, 8846951984510141.0 / 131072.0)
        };

<span class="fc" id="L1441">        final DerivativeStructure abSumInline = a[0].linearCombination(a[0], b[0], a[1], b[1], a[2], b[2]);</span>
<span class="fc" id="L1442">        final DerivativeStructure abSumArray = a[0].linearCombination(a, b);</span>

<span class="fc" id="L1444">        Assert.assertEquals(abSumInline.getValue(), abSumArray.getValue(), 0);</span>
<span class="fc" id="L1445">        Assert.assertEquals(-1.8551294182586248737720779899, abSumInline.getValue(), 1.0e-15);</span>
<span class="fc" id="L1446">        Assert.assertEquals(b[0].getValue(), abSumInline.getPartialDerivative(1, 0, 0, 0, 0, 0), 1.0e-15);</span>
<span class="fc" id="L1447">        Assert.assertEquals(b[1].getValue(), abSumInline.getPartialDerivative(0, 1, 0, 0, 0, 0), 1.0e-15);</span>
<span class="fc" id="L1448">        Assert.assertEquals(b[2].getValue(), abSumInline.getPartialDerivative(0, 0, 1, 0, 0, 0), 1.0e-15);</span>
<span class="fc" id="L1449">        Assert.assertEquals(a[0].getValue(), abSumInline.getPartialDerivative(0, 0, 0, 1, 0, 0), 1.0e-15);</span>
<span class="fc" id="L1450">        Assert.assertEquals(a[1].getValue(), abSumInline.getPartialDerivative(0, 0, 0, 0, 1, 0), 1.0e-15);</span>
<span class="fc" id="L1451">        Assert.assertEquals(a[2].getValue(), abSumInline.getPartialDerivative(0, 0, 0, 0, 0, 1), 1.0e-15);</span>

<span class="fc" id="L1453">    }</span>

    @Test
    public void testLinearCombination1DoubleDS() {
<span class="fc" id="L1457">        final double[] a = new double[] {</span>
            -1321008684645961.0 / 268435456.0,
            -5774608829631843.0 / 268435456.0,
            -7645843051051357.0 / 8589934592.0
        };
<span class="fc" id="L1462">        final DerivativeStructure[] b = new DerivativeStructure[] {</span>
            new DerivativeStructure(3, 1, 0, -5712344449280879.0 / 2097152.0),
            new DerivativeStructure(3, 1, 1, -4550117129121957.0 / 2097152.0),
            new DerivativeStructure(3, 1, 2, 8846951984510141.0 / 131072.0)
        };

<span class="fc" id="L1468">        final DerivativeStructure abSumInline = b[0].linearCombination(a[0], b[0],</span>
                                                                       a[1], b[1],
                                                                       a[2], b[2]);
<span class="fc" id="L1471">        final DerivativeStructure abSumArray = b[0].linearCombination(a, b);</span>

<span class="fc" id="L1473">        Assert.assertEquals(abSumInline.getValue(), abSumArray.getValue(), 0);</span>
<span class="fc" id="L1474">        Assert.assertEquals(-1.8551294182586248737720779899, abSumInline.getValue(), 1.0e-15);</span>
<span class="fc" id="L1475">        Assert.assertEquals(a[0], abSumInline.getPartialDerivative(1, 0, 0), 1.0e-15);</span>
<span class="fc" id="L1476">        Assert.assertEquals(a[1], abSumInline.getPartialDerivative(0, 1, 0), 1.0e-15);</span>
<span class="fc" id="L1477">        Assert.assertEquals(a[2], abSumInline.getPartialDerivative(0, 0, 1), 1.0e-15);</span>

<span class="fc" id="L1479">    }</span>

    @Test
    public void testLinearCombination2DSDS() {
        // we compare accurate versus naive dot product implementations
        // on regular vectors (i.e. not extreme cases like in the previous test)
<span class="fc" id="L1485">        UniformRandomProvider random = RandomSource.create(RandomSource.WELL_1024_A, 0xc6af886975069f11l);</span>

<span class="fc bfc" id="L1487" title="All 2 branches covered.">        for (int i = 0; i &lt; 10000; ++i) {</span>
<span class="fc" id="L1488">            final DerivativeStructure[] u = new DerivativeStructure[4];</span>
<span class="fc" id="L1489">            final DerivativeStructure[] v = new DerivativeStructure[4];</span>
<span class="fc bfc" id="L1490" title="All 2 branches covered.">            for (int j = 0; j &lt; u.length; ++j) {</span>
<span class="fc" id="L1491">                u[j] = new DerivativeStructure(u.length, 1, j, 1e17 * random.nextDouble());</span>
<span class="fc" id="L1492">                v[j] = new DerivativeStructure(u.length, 1, 1e17 * random.nextDouble());</span>
            }

<span class="fc" id="L1495">            DerivativeStructure lin = u[0].linearCombination(u[0], v[0], u[1], v[1]);</span>
<span class="fc" id="L1496">            double ref = u[0].getValue() * v[0].getValue() +</span>
<span class="fc" id="L1497">                         u[1].getValue() * v[1].getValue();</span>
<span class="fc" id="L1498">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1499">            Assert.assertEquals(v[0].getValue(), lin.getPartialDerivative(1, 0, 0, 0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1500">            Assert.assertEquals(v[1].getValue(), lin.getPartialDerivative(0, 1, 0, 0), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>

<span class="fc" id="L1502">            lin = u[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2]);</span>
<span class="fc" id="L1503">            ref = u[0].getValue() * v[0].getValue() +</span>
<span class="fc" id="L1504">                  u[1].getValue() * v[1].getValue() +</span>
<span class="fc" id="L1505">                  u[2].getValue() * v[2].getValue();</span>
<span class="fc" id="L1506">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1507">            Assert.assertEquals(v[0].getValue(), lin.getPartialDerivative(1, 0, 0, 0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1508">            Assert.assertEquals(v[1].getValue(), lin.getPartialDerivative(0, 1, 0, 0), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1509">            Assert.assertEquals(v[2].getValue(), lin.getPartialDerivative(0, 0, 1, 0), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>

<span class="fc" id="L1511">            lin = u[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2], u[3], v[3]);</span>
<span class="fc" id="L1512">            ref = u[0].getValue() * v[0].getValue() +</span>
<span class="fc" id="L1513">                  u[1].getValue() * v[1].getValue() +</span>
<span class="fc" id="L1514">                  u[2].getValue() * v[2].getValue() +</span>
<span class="fc" id="L1515">                  u[3].getValue() * v[3].getValue();</span>
<span class="fc" id="L1516">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1517">            Assert.assertEquals(v[0].getValue(), lin.getPartialDerivative(1, 0, 0, 0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1518">            Assert.assertEquals(v[1].getValue(), lin.getPartialDerivative(0, 1, 0, 0), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1519">            Assert.assertEquals(v[2].getValue(), lin.getPartialDerivative(0, 0, 1, 0), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>
<span class="fc" id="L1520">            Assert.assertEquals(v[3].getValue(), lin.getPartialDerivative(0, 0, 0, 1), 1.0e-15 * FastMath.abs(v[3].getValue()));</span>

        }
<span class="fc" id="L1523">    }</span>

    @Test
    public void testLinearCombination2DoubleDS() {
        // we compare accurate versus naive dot product implementations
        // on regular vectors (i.e. not extreme cases like in the previous test)
<span class="fc" id="L1529">        UniformRandomProvider random = RandomSource.create(RandomSource.WELL_1024_A, 0xc6af886975069f11l);</span>

<span class="fc bfc" id="L1531" title="All 2 branches covered.">        for (int i = 0; i &lt; 10000; ++i) {</span>
<span class="fc" id="L1532">            final double[] u = new double[4];</span>
<span class="fc" id="L1533">            final DerivativeStructure[] v = new DerivativeStructure[4];</span>
<span class="fc bfc" id="L1534" title="All 2 branches covered.">            for (int j = 0; j &lt; u.length; ++j) {</span>
<span class="fc" id="L1535">                u[j] = 1e17 * random.nextDouble();</span>
<span class="fc" id="L1536">                v[j] = new DerivativeStructure(u.length, 1, j, 1e17 * random.nextDouble());</span>
            }

<span class="fc" id="L1539">            DerivativeStructure lin = v[0].linearCombination(u[0], v[0], u[1], v[1]);</span>
<span class="fc" id="L1540">            double ref = u[0] * v[0].getValue() +</span>
<span class="fc" id="L1541">                         u[1] * v[1].getValue();</span>
<span class="fc" id="L1542">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1543">            Assert.assertEquals(u[0], lin.getPartialDerivative(1, 0, 0, 0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1544">            Assert.assertEquals(u[1], lin.getPartialDerivative(0, 1, 0, 0), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>

<span class="fc" id="L1546">            lin = v[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2]);</span>
<span class="fc" id="L1547">            ref = u[0] * v[0].getValue() +</span>
<span class="fc" id="L1548">                  u[1] * v[1].getValue() +</span>
<span class="fc" id="L1549">                  u[2] * v[2].getValue();</span>
<span class="fc" id="L1550">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1551">            Assert.assertEquals(u[0], lin.getPartialDerivative(1, 0, 0, 0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1552">            Assert.assertEquals(u[1], lin.getPartialDerivative(0, 1, 0, 0), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1553">            Assert.assertEquals(u[2], lin.getPartialDerivative(0, 0, 1, 0), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>

<span class="fc" id="L1555">            lin = v[0].linearCombination(u[0], v[0], u[1], v[1], u[2], v[2], u[3], v[3]);</span>
<span class="fc" id="L1556">            ref = u[0] * v[0].getValue() +</span>
<span class="fc" id="L1557">                  u[1] * v[1].getValue() +</span>
<span class="fc" id="L1558">                  u[2] * v[2].getValue() +</span>
<span class="fc" id="L1559">                  u[3] * v[3].getValue();</span>
<span class="fc" id="L1560">            Assert.assertEquals(ref, lin.getValue(), 1.0e-15 * FastMath.abs(ref));</span>
<span class="fc" id="L1561">            Assert.assertEquals(u[0], lin.getPartialDerivative(1, 0, 0, 0), 1.0e-15 * FastMath.abs(v[0].getValue()));</span>
<span class="fc" id="L1562">            Assert.assertEquals(u[1], lin.getPartialDerivative(0, 1, 0, 0), 1.0e-15 * FastMath.abs(v[1].getValue()));</span>
<span class="fc" id="L1563">            Assert.assertEquals(u[2], lin.getPartialDerivative(0, 0, 1, 0), 1.0e-15 * FastMath.abs(v[2].getValue()));</span>
<span class="fc" id="L1564">            Assert.assertEquals(u[3], lin.getPartialDerivative(0, 0, 0, 1), 1.0e-15 * FastMath.abs(v[3].getValue()));</span>

        }
<span class="fc" id="L1567">    }</span>

    @Test
    public void testSerialization() {
<span class="fc" id="L1571">        DerivativeStructure a = new DerivativeStructure(3, 2, 0, 1.3);</span>
<span class="fc" id="L1572">        DerivativeStructure b = (DerivativeStructure) TestUtils.serializeAndRecover(a);</span>
<span class="fc" id="L1573">        Assert.assertEquals(a.getFreeParameters(), b.getFreeParameters());</span>
<span class="fc" id="L1574">        Assert.assertEquals(a.getOrder(), b.getOrder());</span>
<span class="fc" id="L1575">        checkEquals(a, b, 1.0e-15);</span>
<span class="fc" id="L1576">    }</span>

    private void checkF0F1(DerivativeStructure ds, double value, double...derivatives) {

        // check dimension
<span class="fc" id="L1581">        Assert.assertEquals(derivatives.length, ds.getFreeParameters());</span>

        // check value, directly and also as 0th order derivative
<span class="fc" id="L1584">        Assert.assertEquals(value, ds.getValue(), 1.0e-15);</span>
<span class="fc" id="L1585">        Assert.assertEquals(value, ds.getPartialDerivative(new int[ds.getFreeParameters()]), 1.0e-15);</span>

        // check first order derivatives
<span class="fc bfc" id="L1588" title="All 2 branches covered.">        for (int i = 0; i &lt; derivatives.length; ++i) {</span>
<span class="fc" id="L1589">            int[] orders = new int[derivatives.length];</span>
<span class="fc" id="L1590">            orders[i] = 1;</span>
<span class="fc" id="L1591">            Assert.assertEquals(derivatives[i], ds.getPartialDerivative(orders), 1.0e-15);</span>
        }

<span class="fc" id="L1594">    }</span>

    private void checkEquals(DerivativeStructure ds1, DerivativeStructure ds2, double epsilon) {

        // check dimension
<span class="fc" id="L1599">        Assert.assertEquals(ds1.getFreeParameters(), ds2.getFreeParameters());</span>
<span class="fc" id="L1600">        Assert.assertEquals(ds1.getOrder(), ds2.getOrder());</span>

<span class="fc" id="L1602">        int[] derivatives = new int[ds1.getFreeParameters()];</span>
<span class="fc" id="L1603">        int sum = 0;</span>
        while (true) {

<span class="fc bfc" id="L1606" title="All 2 branches covered.">            if (sum &lt;= ds1.getOrder()) {</span>
<span class="fc" id="L1607">                Assert.assertEquals(ds1.getPartialDerivative(derivatives),</span>
<span class="fc" id="L1608">                                    ds2.getPartialDerivative(derivatives),</span>
                                    epsilon);
            }

<span class="fc" id="L1612">            boolean increment = true;</span>
<span class="fc" id="L1613">            sum = 0;</span>
<span class="fc bfc" id="L1614" title="All 2 branches covered.">            for (int i = derivatives.length - 1; i &gt;= 0; --i) {</span>
<span class="fc bfc" id="L1615" title="All 2 branches covered.">                if (increment) {</span>
<span class="fc bfc" id="L1616" title="All 2 branches covered.">                    if (derivatives[i] == ds1.getOrder()) {</span>
<span class="fc" id="L1617">                        derivatives[i] = 0;</span>
                    } else {
<span class="fc" id="L1619">                        derivatives[i]++;</span>
<span class="fc" id="L1620">                        increment = false;</span>
                    }
                }
<span class="fc" id="L1623">                sum += derivatives[i];</span>
            }
<span class="fc bfc" id="L1625" title="All 2 branches covered.">            if (increment) {</span>
<span class="fc" id="L1626">                return;</span>
            }

<span class="fc" id="L1629">        }</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>