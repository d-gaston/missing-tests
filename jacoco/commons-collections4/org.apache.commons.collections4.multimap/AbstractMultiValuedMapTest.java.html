<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractMultiValuedMapTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">commons_collections4$All_in_commons_collections4.exec</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.collections4.multimap</a> &gt; <span class="el_source">AbstractMultiValuedMapTest.java</span></div><h1>AbstractMultiValuedMapTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.collections4.multimap;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import org.apache.commons.collections4.AbstractObjectTest;
import org.apache.commons.collections4.Bag;
import org.apache.commons.collections4.BulkTest;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.MapIterator;
import org.apache.commons.collections4.MultiSet;
import org.apache.commons.collections4.MultiValuedMap;
import org.apache.commons.collections4.SetValuedMap;
import org.apache.commons.collections4.bag.AbstractBagTest;
import org.apache.commons.collections4.bag.HashBag;
import org.apache.commons.collections4.collection.AbstractCollectionTest;
import org.apache.commons.collections4.map.AbstractMapTest;
import org.apache.commons.collections4.multiset.AbstractMultiSetTest;
import org.apache.commons.collections4.set.AbstractSetTest;

/**
 * Abstract test class for {@link MultiValuedMap} contract and methods.
 * &lt;p&gt;
 * To use, extend this class and implement the {@link #makeObject} method and if
 * necessary override the {@link #makeFullMap()} method.
 *
 * @since 4.1
 */
public abstract class AbstractMultiValuedMapTest&lt;K, V&gt; extends AbstractObjectTest {

    /** Map created by reset(). */
    protected MultiValuedMap&lt;K, V&gt; map;

    /** MultiValuedHashMap created by reset(). */
    protected MultiValuedMap&lt;K, V&gt; confirmed;

    public AbstractMultiValuedMapTest(final String testName) {
<span class="fc" id="L61">        super(testName);</span>
<span class="fc" id="L62">    }</span>

    @Override
    abstract public MultiValuedMap&lt;K, V&gt; makeObject();

    @Override
    public String getCompatibilityVersion() {
<span class="fc" id="L69">        return &quot;4.1&quot;; // MultiValuedMap has been added in version 4.1</span>
    }

    /**
     * Returns true if the maps produced by {@link #makeObject()} and
     * {@link #makeFullMap()} support the &lt;code&gt;put&lt;/code&gt; and
     * &lt;code&gt;putAll&lt;/code&gt; operations adding new mappings.
     * &lt;p&gt;
     * Default implementation returns true. Override if your collection class
     * does not support put adding.
     */
    public boolean isAddSupported() {
<span class="fc" id="L81">        return true;</span>
    }

    /**
     * Returns true if the maps produced by {@link #makeObject()} and
     * {@link #makeFullMap()} support the &lt;code&gt;remove&lt;/code&gt; and
     * &lt;code&gt;clear&lt;/code&gt; operations.
     * &lt;p&gt;
     * Default implementation returns true. Override if your collection class
     * does not support removal operations.
     */
    public boolean isRemoveSupported() {
<span class="fc" id="L93">        return true;</span>
    }

    /**
     * Returns true if the maps produced by {@link #makeObject()} and
     * {@link #makeFullMap()} supports null keys.
     * &lt;p&gt;
     * Default implementation returns true. Override if your collection class
     * does not support null keys.
     */
    public boolean isAllowNullKey() {
<span class="nc" id="L104">        return true;</span>
    }

    @Override
    public boolean isTestSerialization() {
<span class="fc" id="L109">        return true;</span>
    }

    /**
     * Returns the set of keys in the mappings used to test the map. This method
     * must return an array with the same length as {@link #getSampleValues()}
     * and all array elements must be different. The default implementation
     * constructs a set of String keys, and includes a single null key if
     * {@link #isAllowNullKey()} returns &lt;code&gt;true&lt;/code&gt;.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public K[] getSampleKeys() {
<span class="fc" id="L121">        final Object[] result = new Object[] {</span>
                &quot;one&quot;, &quot;one&quot;, &quot;two&quot;, &quot;two&quot;,
                &quot;three&quot;, &quot;three&quot;
        };
<span class="fc" id="L125">        return (K[]) result;</span>
    }

    /**
     * Returns the set of values in the mappings used to test the map. This
     * method must return an array with the same length as
     * {@link #getSampleKeys()}. The default implementation constructs a set of
     * String values
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public V[] getSampleValues() {
<span class="fc" id="L136">        final Object[] result = new Object[] {</span>
                &quot;uno&quot;, &quot;un&quot;, &quot;dos&quot;, &quot;deux&quot;,
                &quot;tres&quot;, &quot;trois&quot;
        };
<span class="fc" id="L140">        return (V[]) result;</span>
    }

    protected MultiValuedMap&lt;K, V&gt; makeFullMap() {
<span class="fc" id="L144">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L145">        addSampleMappings(map);</span>
<span class="fc" id="L146">        return map;</span>
    }

    protected void addSampleMappings(final MultiValuedMap&lt;? super K, ? super V&gt; map) {
<span class="fc" id="L150">        final K[] keys = getSampleKeys();</span>
<span class="fc" id="L151">        final V[] values = getSampleValues();</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">        for (int i = 0; i &lt; keys.length; i++) {</span>
<span class="fc" id="L153">            map.put(keys[i], values[i]);</span>
        }
<span class="fc" id="L155">    }</span>

    /**
     * Override to return a MultiValuedMap other than ArrayListValuedHashMap
     * as the confirmed map.
     *
     * @return a MultiValuedMap that is known to be valid
     */
    public MultiValuedMap&lt;K, V&gt; makeConfirmedMap() {
<span class="fc" id="L164">        return new ArrayListValuedHashMap&lt;&gt;();</span>
    }

    public MultiValuedMap&lt;K, V&gt; getConfirmed() {
<span class="fc" id="L168">        return this.confirmed;</span>
    }

    public void setConfirmed(final MultiValuedMap&lt;K, V&gt; map) {
<span class="nc" id="L172">        this.confirmed = map;</span>
<span class="nc" id="L173">    }</span>

    public MultiValuedMap&lt;K, V&gt; getMap() {
<span class="fc" id="L176">        return this.map;</span>
    }

    /**
     * Resets the {@link #map} and {@link #confirmed} fields to empty.
     */
    public void resetEmpty() {
<span class="fc" id="L183">        this.map = makeObject();</span>
<span class="fc" id="L184">        this.confirmed = makeConfirmedMap();</span>
<span class="fc" id="L185">    }</span>

    /**
     * Resets the {@link #map} and {@link #confirmed} fields to full.
     */
    public void resetFull() {
<span class="fc" id="L191">        this.map = makeFullMap();</span>
<span class="fc" id="L192">        this.confirmed = makeConfirmedMap();</span>
<span class="fc" id="L193">        final K[] k = getSampleKeys();</span>
<span class="fc" id="L194">        final V[] v = getSampleValues();</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">        for (int i = 0; i &lt; k.length; i++) {</span>
<span class="fc" id="L196">            confirmed.put(k[i], v[i]);</span>
        }
<span class="fc" id="L198">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testNoMappingReturnsEmptyCol() {
<span class="fc" id="L202">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L203">        assertTrue(map.get((K) &quot;whatever&quot;).isEmpty());</span>
<span class="fc" id="L204">    }</span>

    public void testMultipleValues() {
<span class="fc" id="L207">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
        final
<span class="fc" id="L210">        Collection&lt;V&gt; col = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L211">        assertTrue(col.contains(&quot;uno&quot;));</span>
<span class="fc" id="L212">        assertTrue(col.contains(&quot;un&quot;));</span>
<span class="fc" id="L213">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testGet() {
<span class="fc" id="L217">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L218">        assertTrue(map.get((K) &quot;one&quot;).contains(&quot;uno&quot;));</span>
<span class="fc" id="L219">        assertTrue(map.get((K) &quot;one&quot;).contains(&quot;un&quot;));</span>
<span class="fc" id="L220">        assertTrue(map.get((K) &quot;two&quot;).contains(&quot;dos&quot;));</span>
<span class="fc" id="L221">        assertTrue(map.get((K) &quot;two&quot;).contains(&quot;deux&quot;));</span>
<span class="fc" id="L222">        assertTrue(map.get((K) &quot;three&quot;).contains(&quot;tres&quot;));</span>
<span class="fc" id="L223">        assertTrue(map.get((K) &quot;three&quot;).contains(&quot;trois&quot;));</span>
<span class="fc" id="L224">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testAddMappingThroughGet(){
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L229">            return;</span>
        }
<span class="fc" id="L231">        resetEmpty();</span>
<span class="fc" id="L232">        final MultiValuedMap&lt;K, V&gt; map =  getMap();</span>
<span class="fc" id="L233">        final Collection&lt;V&gt; col1 = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L234">        final Collection&lt;V&gt; col2 = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L235">        assertTrue(col1.isEmpty());</span>
<span class="fc" id="L236">        assertTrue(col2.isEmpty());</span>
<span class="fc" id="L237">        assertEquals(0, map.size());</span>
<span class="fc" id="L238">        col1.add((V) &quot;uno&quot;);</span>
<span class="fc" id="L239">        col2.add((V) &quot;un&quot;);</span>
<span class="fc" id="L240">        assertTrue(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L241">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L242">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L243">        assertTrue(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L244">        assertTrue(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L245">        assertTrue(col1.contains(&quot;un&quot;));</span>
<span class="fc" id="L246">        assertTrue(col2.contains(&quot;uno&quot;));</span>
<span class="fc" id="L247">    }</span>

    public void testRemoveMappingThroughGet() {
<span class="fc bfc" id="L250" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L251">            return;</span>
        }
<span class="fc" id="L253">        resetFull();</span>
<span class="fc" id="L254">        final MultiValuedMap&lt;K, V&gt; map = getMap();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L256">        Collection&lt;V&gt; col = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L257">        assertEquals(2, col.size());</span>
<span class="fc" id="L258">        assertEquals(6, map.size());</span>
<span class="fc" id="L259">        col.remove(&quot;uno&quot;);</span>
<span class="fc" id="L260">        col.remove(&quot;un&quot;);</span>
<span class="fc" id="L261">        assertFalse(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L262">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L263">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L264">        assertFalse(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L265">        assertFalse(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L266">        assertEquals(4, map.size());</span>
<span class="fc" id="L267">        col = map.remove(&quot;one&quot;);</span>
<span class="fc" id="L268">        assertNotNull(col);</span>
<span class="fc" id="L269">        assertEquals(0, col.size());</span>
<span class="fc" id="L270">    }</span>

    public void testRemoveMappingThroughGetIterator() {
<span class="fc bfc" id="L273" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L274">            return;</span>
        }
<span class="fc" id="L276">        resetFull();</span>
<span class="fc" id="L277">        final MultiValuedMap&lt;K, V&gt; map = getMap();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
        final
<span class="fc" id="L280">        Iterator&lt;V&gt; it = map.get((K) &quot;one&quot;).iterator();</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">        while (it.hasNext()) {</span>
<span class="fc" id="L282">            it.next();</span>
<span class="fc" id="L283">            it.remove();</span>
        }
<span class="fc" id="L285">        assertFalse(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L286">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L287">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L288">        assertFalse(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L289">        assertFalse(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L290">        assertEquals(4, map.size());</span>
<span class="fc" id="L291">        final Collection&lt;V&gt; coll = map.remove(&quot;one&quot;);</span>
<span class="fc" id="L292">        assertNotNull(coll);</span>
<span class="fc" id="L293">        assertEquals(0, coll.size());</span>
<span class="fc" id="L294">    }</span>

    public void testContainsValue() {
<span class="fc" id="L297">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L298">        assertTrue(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L299">        assertTrue(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L300">        assertTrue(map.containsValue(&quot;dos&quot;));</span>
<span class="fc" id="L301">        assertTrue(map.containsValue(&quot;deux&quot;));</span>
<span class="fc" id="L302">        assertTrue(map.containsValue(&quot;tres&quot;));</span>
<span class="fc" id="L303">        assertTrue(map.containsValue(&quot;trois&quot;));</span>
<span class="fc" id="L304">        assertFalse(map.containsValue(&quot;quatro&quot;));</span>
<span class="fc" id="L305">    }</span>

    public void testKeyContainsValue() {
<span class="fc" id="L308">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L309">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L310">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L311">        assertTrue(map.containsMapping(&quot;two&quot;, &quot;dos&quot;));</span>
<span class="fc" id="L312">        assertTrue(map.containsMapping(&quot;two&quot;, &quot;deux&quot;));</span>
<span class="fc" id="L313">        assertTrue(map.containsMapping(&quot;three&quot;, &quot;tres&quot;));</span>
<span class="fc" id="L314">        assertTrue(map.containsMapping(&quot;three&quot;, &quot;trois&quot;));</span>
<span class="fc" id="L315">        assertFalse(map.containsMapping(&quot;four&quot;, &quot;quatro&quot;));</span>
<span class="fc" id="L316">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testValues() {
<span class="fc" id="L320">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L321">        final HashSet&lt;V&gt; expected = new HashSet&lt;&gt;();</span>
<span class="fc" id="L322">        expected.add((V) &quot;uno&quot;);</span>
<span class="fc" id="L323">        expected.add((V) &quot;dos&quot;);</span>
<span class="fc" id="L324">        expected.add((V) &quot;tres&quot;);</span>
<span class="fc" id="L325">        expected.add((V) &quot;un&quot;);</span>
<span class="fc" id="L326">        expected.add((V) &quot;deux&quot;);</span>
<span class="fc" id="L327">        expected.add((V) &quot;trois&quot;);</span>
<span class="fc" id="L328">        final Collection&lt;V&gt; c = map.values();</span>
<span class="fc" id="L329">        assertEquals(6, c.size());</span>
<span class="fc" id="L330">        assertEquals(expected, new HashSet&lt;&gt;(c));</span>
<span class="fc" id="L331">    }</span>

//    public void testKeyedIterator() {
//        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
//        final ArrayList&lt;Object&gt; actual = new ArrayList&lt;Object&gt;(IteratorUtils.toList(map.iterator(&quot;one&quot;)));
//        final ArrayList&lt;Object&gt; expected = new ArrayList&lt;Object&gt;(Arrays.asList(&quot;uno&quot;, &quot;un&quot;));
//        assertEquals(expected, actual);
//    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testRemoveAllViaValuesIterator() {
<span class="fc bfc" id="L342" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L343">            return;</span>
        }
<span class="fc" id="L345">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">        for (final Iterator&lt;?&gt; i = map.values().iterator(); i.hasNext();) {</span>
<span class="fc" id="L347">            i.next();</span>
<span class="fc" id="L348">            i.remove();</span>
        }
<span class="fc" id="L350">        assertTrue(map.get((K) &quot;one&quot;).isEmpty());</span>
<span class="fc" id="L351">        assertTrue(map.isEmpty());</span>
<span class="fc" id="L352">    }</span>

    public void testRemoveViaValuesRemove() {
<span class="fc bfc" id="L355" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L356">            return;</span>
        }
<span class="fc" id="L358">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L359">        final Collection&lt;V&gt; values = map.values();</span>
<span class="fc" id="L360">        values.remove(&quot;uno&quot;);</span>
<span class="fc" id="L361">        values.remove(&quot;un&quot;);</span>
<span class="fc" id="L362">        assertFalse(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L363">        assertEquals(4, map.size());</span>
<span class="fc" id="L364">    }</span>

    /*public void testRemoveViaGetCollectionRemove() {
        if (!isRemoveSupported()) {
            return;
        }
        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
        Collection&lt;V&gt; values = map.get(&quot;one&quot;);
        values.remove(&quot;uno&quot;);
        values.remove(&quot;un&quot;);
        assertFalse(map.containsKey(&quot;one&quot;));
        assertEquals(4, map.size());
    }*/

//    public void testRemoveAllViaKeyedIterator() {
//        if (!isRemoveSupported()) {
//            return;
//        }
//        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
//        for (final Iterator&lt;?&gt; i = map.iterator(&quot;one&quot;); i.hasNext();) {
//            i.next();
//            i.remove();
//        }
//        assertNull(map.get(&quot;one&quot;));
//        assertEquals(4, map.size());
//    }

    public void testEntriesCollectionIterator() {
<span class="fc" id="L392">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L393">        final Collection&lt;V&gt; values = new ArrayList&lt;&gt;(map.values());</span>
<span class="fc" id="L394">        final Iterator&lt;Map.Entry&lt;K, V&gt;&gt; iterator = map.entries().iterator();</span>
<span class="fc bfc" id="L395" title="All 2 branches covered.">        while (iterator.hasNext()) {</span>
<span class="fc" id="L396">            final Map.Entry&lt;K, V&gt; entry = iterator.next();</span>
<span class="fc" id="L397">            assertTrue(map.containsMapping(entry.getKey(), entry.getValue()));</span>
<span class="fc" id="L398">            assertTrue(values.contains(entry.getValue()));</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">            if (isRemoveSupported()) {</span>
<span class="fc" id="L400">                assertTrue(values.remove(entry.getValue()));</span>
            }
<span class="fc" id="L402">        }</span>
<span class="fc bfc" id="L403" title="All 2 branches covered.">        if (isRemoveSupported()) {</span>
<span class="fc" id="L404">            assertTrue(values.isEmpty());</span>
        }
<span class="fc" id="L406">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testRemoveAllViaEntriesIterator() {
<span class="fc bfc" id="L410" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L411">            return;</span>
        }
<span class="fc" id="L413">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc bfc" id="L414" title="All 2 branches covered.">        for (final Iterator&lt;?&gt; i = map.entries().iterator(); i.hasNext();) {</span>
<span class="fc" id="L415">            i.next();</span>
<span class="fc" id="L416">            i.remove();</span>
        }
<span class="fc" id="L418">        assertTrue(map.get((K) &quot;one&quot;).isEmpty());</span>
<span class="fc" id="L419">        assertEquals(0, map.size());</span>
<span class="fc" id="L420">    }</span>

    public void testSize() {
<span class="fc" id="L423">        assertEquals(6, makeFullMap().size());</span>
<span class="fc" id="L424">    }</span>

    // -----------------------------------------------------------------------
    @SuppressWarnings(&quot;unchecked&quot;)
    public void testMapEquals() {
<span class="fc bfc" id="L429" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L430">            return;</span>
        }
<span class="fc" id="L432">        final MultiValuedMap&lt;K, V&gt; one = makeObject();</span>
<span class="fc" id="L433">        final Integer value = Integer.valueOf(1);</span>
<span class="fc" id="L434">        one.put((K) &quot;One&quot;, (V) value);</span>
<span class="fc" id="L435">        one.removeMapping(&quot;One&quot;, value);</span>

<span class="fc" id="L437">        final MultiValuedMap&lt;K, V&gt; two = makeObject();</span>
<span class="fc" id="L438">        assertEquals(two, one);</span>
<span class="fc" id="L439">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testSizeWithPutRemove() {
<span class="pc bpc" id="L443" title="1 of 4 branches missed.">        if (!isRemoveSupported() || !isAddSupported()) {</span>
<span class="fc" id="L444">            return;</span>
        }
<span class="fc" id="L446">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L447">        assertEquals(0, map.size());</span>
<span class="fc" id="L448">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L449">        assertEquals(1, map.size());</span>
<span class="fc" id="L450">        map.put((K) &quot;B&quot;, (V) &quot;BA&quot;);</span>
<span class="fc" id="L451">        assertEquals(2, map.size());</span>
<span class="fc" id="L452">        map.put((K) &quot;B&quot;, (V) &quot;BB&quot;);</span>
<span class="fc" id="L453">        assertEquals(3, map.size());</span>
<span class="fc" id="L454">        map.put((K) &quot;B&quot;, (V) &quot;BC&quot;);</span>
<span class="fc" id="L455">        assertEquals(4, map.size());</span>
<span class="fc" id="L456">        map.remove(&quot;A&quot;);</span>
<span class="fc" id="L457">        assertEquals(3, map.size());</span>
<span class="fc" id="L458">        map.removeMapping(&quot;B&quot;, &quot;BC&quot;);</span>
<span class="fc" id="L459">        assertEquals(2, map.size());</span>
<span class="fc" id="L460">    }</span>

    public void testKeySetSize() {
<span class="fc" id="L463">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L464">        assertEquals(3, map.keySet().size());</span>
<span class="fc" id="L465">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testSize_Key() {
<span class="fc" id="L469">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L470">        assertEquals(2, map.get((K) &quot;one&quot;).size());</span>
<span class="fc" id="L471">        assertEquals(2, map.get((K) &quot;two&quot;).size());</span>
<span class="fc" id="L472">        assertEquals(2, map.get((K) &quot;three&quot;).size());</span>
<span class="fc bfc" id="L473" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L474">            return;</span>
        }
<span class="fc" id="L476">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L477">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
        //assertEquals(0, map.get(&quot;B&quot;).size());
<span class="fc" id="L479">        map.put((K) &quot;B&quot;, (V) &quot;BA&quot;);</span>
<span class="fc" id="L480">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L481">        assertEquals(1, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L482">        map.put((K) &quot;B&quot;, (V) &quot;BB&quot;);</span>
<span class="fc" id="L483">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L484">        assertEquals(2, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L485">        map.put((K) &quot;B&quot;, (V) &quot;BC&quot;);</span>
<span class="fc" id="L486">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L487">        assertEquals(3, map.get((K) &quot;B&quot;).size());</span>
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">        if (!isRemoveSupported()) {</span>
<span class="nc" id="L489">            return;</span>
        }
<span class="fc" id="L491">        map.remove(&quot;A&quot;);</span>
        //assertEquals(0, map.get(&quot;A&quot;).size());
<span class="fc" id="L493">        assertEquals(3, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L494">        map.removeMapping(&quot;B&quot;, &quot;BC&quot;);</span>
        //assertEquals(0, map.get(&quot;A&quot;).size());
<span class="fc" id="L496">        assertEquals(2, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L497">    }</span>

//    @SuppressWarnings(&quot;unchecked&quot;)
//    public void testIterator_Key() {
//        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
//        Iterator&lt;V&gt; it = map.iterator(&quot;one&quot;);
//        assertEquals(true, it.hasNext());
//        Set&lt;V&gt; values = new HashSet&lt;V&gt;();
//        while (it.hasNext()) {
//            values.add(it.next());
//        }
//        assertEquals(true, values.contains(&quot;un&quot;));
//        assertEquals(true, values.contains(&quot;uno&quot;));
//        assertEquals(false, map.iterator(&quot;A&quot;).hasNext());
//        assertEquals(false, map.iterator(&quot;A&quot;).hasNext());
//        if (!isAddSupported()) {
//            return;
//        }
//        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);
//        it = map.iterator(&quot;A&quot;);
//        assertEquals(true, it.hasNext());
//        it.next();
//        assertEquals(false, it.hasNext());
//    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testContainsValue_Key() {
<span class="fc" id="L524">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L525">        assertEquals(true, map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L526">        assertEquals(false, map.containsMapping(&quot;two&quot;, &quot;2&quot;));</span>
<span class="fc bfc" id="L527" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L528">            return;</span>
        }
<span class="fc" id="L530">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L531">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;AA&quot;));</span>
<span class="fc" id="L532">        assertEquals(false, map.containsMapping(&quot;A&quot;, &quot;AB&quot;));</span>
<span class="fc" id="L533">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testPutAll_Map1() {
<span class="fc bfc" id="L537" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L538">            return;</span>
        }
<span class="fc" id="L540">        final MultiValuedMap&lt;K, V&gt; original = makeObject();</span>
<span class="fc" id="L541">        original.put((K) &quot;key&quot;, (V) &quot;object1&quot;);</span>
<span class="fc" id="L542">        original.put((K) &quot;key&quot;, (V) &quot;object2&quot;);</span>

<span class="fc" id="L544">        final MultiValuedMap&lt;K, V&gt; test = makeObject();</span>
<span class="fc" id="L545">        test.put((K) &quot;keyA&quot;, (V) &quot;objectA&quot;);</span>
<span class="fc" id="L546">        test.put((K) &quot;key&quot;, (V) &quot;object0&quot;);</span>
<span class="fc" id="L547">        test.putAll(original);</span>

<span class="fc" id="L549">        assertEquals(2, test.keySet().size());</span>
<span class="fc" id="L550">        assertEquals(4, test.size());</span>
<span class="fc" id="L551">        assertEquals(1, test.get((K) &quot;keyA&quot;).size());</span>
<span class="fc" id="L552">        assertEquals(3, test.get((K) &quot;key&quot;).size());</span>
<span class="fc" id="L553">        assertEquals(true, test.containsValue(&quot;objectA&quot;));</span>
<span class="fc" id="L554">        assertEquals(true, test.containsValue(&quot;object0&quot;));</span>
<span class="fc" id="L555">        assertEquals(true, test.containsValue(&quot;object1&quot;));</span>
<span class="fc" id="L556">        assertEquals(true, test.containsValue(&quot;object2&quot;));</span>
<span class="fc" id="L557">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testPutAll_Map2() {
<span class="fc bfc" id="L561" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L562">            return;</span>
        }
<span class="fc" id="L564">        final Map&lt;K, V&gt; original = new HashMap&lt;&gt;();</span>
<span class="fc" id="L565">        original.put((K) &quot;keyX&quot;, (V) &quot;object1&quot;);</span>
<span class="fc" id="L566">        original.put((K) &quot;keyY&quot;, (V) &quot;object2&quot;);</span>

<span class="fc" id="L568">        final MultiValuedMap&lt;K, V&gt; test = makeObject();</span>
<span class="fc" id="L569">        test.put((K) &quot;keyA&quot;, (V) &quot;objectA&quot;);</span>
<span class="fc" id="L570">        test.put((K) &quot;keyX&quot;, (V) &quot;object0&quot;);</span>
<span class="fc" id="L571">        test.putAll(original);</span>

<span class="fc" id="L573">        assertEquals(3, test.keySet().size());</span>
<span class="fc" id="L574">        assertEquals(4, test.size());</span>
<span class="fc" id="L575">        assertEquals(1, test.get((K) &quot;keyA&quot;).size());</span>
<span class="fc" id="L576">        assertEquals(2, test.get((K) &quot;keyX&quot;).size());</span>
<span class="fc" id="L577">        assertEquals(1, test.get((K) &quot;keyY&quot;).size());</span>
<span class="fc" id="L578">        assertEquals(true, test.containsValue(&quot;objectA&quot;));</span>
<span class="fc" id="L579">        assertEquals(true, test.containsValue(&quot;object0&quot;));</span>
<span class="fc" id="L580">        assertEquals(true, test.containsValue(&quot;object1&quot;));</span>
<span class="fc" id="L581">        assertEquals(true, test.containsValue(&quot;object2&quot;));</span>
<span class="fc" id="L582">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testPutAll_KeyIterable() {
<span class="fc bfc" id="L586" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L587">            return;</span>
        }
<span class="fc" id="L589">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L590">        Collection&lt;V&gt; coll = (Collection&lt;V&gt;) Arrays.asList(&quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;);</span>

<span class="fc" id="L592">        assertEquals(true, map.putAll((K) &quot;A&quot;, coll));</span>
<span class="fc" id="L593">        assertEquals(3, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L594">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L595">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L596">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>

        try {
<span class="nc" id="L599">            map.putAll((K) &quot;A&quot;, null);</span>
<span class="nc" id="L600">            fail(&quot;expecting NullPointerException&quot;);</span>
<span class="fc" id="L601">        } catch (final NullPointerException npe) {</span>
            // expected
<span class="nc" id="L603">        }</span>

<span class="fc" id="L605">        assertEquals(3, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L606">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L607">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L608">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>

<span class="fc" id="L610">        assertEquals(false, map.putAll((K) &quot;A&quot;, new ArrayList&lt;V&gt;()));</span>
<span class="fc" id="L611">        assertEquals(3, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L612">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L613">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L614">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>

<span class="fc" id="L616">        coll = (Collection&lt;V&gt;) Arrays.asList(&quot;M&quot;);</span>
<span class="fc" id="L617">        assertEquals(true, map.putAll((K) &quot;A&quot;, coll));</span>
<span class="fc" id="L618">        assertEquals(4, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L619">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L620">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L621">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>
<span class="fc" id="L622">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;M&quot;));</span>
<span class="fc" id="L623">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testRemove_KeyItem() {
<span class="pc bpc" id="L627" title="1 of 4 branches missed.">        if (!isRemoveSupported() || !isAddSupported()) {</span>
<span class="fc" id="L628">            return;</span>
        }
<span class="fc" id="L630">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L631">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L632">        map.put((K) &quot;A&quot;, (V) &quot;AB&quot;);</span>
<span class="fc" id="L633">        map.put((K) &quot;A&quot;, (V) &quot;AC&quot;);</span>
<span class="fc" id="L634">        assertEquals(false, map.removeMapping(&quot;C&quot;, &quot;CA&quot;));</span>
<span class="fc" id="L635">        assertEquals(false, map.removeMapping(&quot;A&quot;, &quot;AD&quot;));</span>
<span class="fc" id="L636">        assertEquals(true, map.removeMapping(&quot;A&quot;, &quot;AC&quot;));</span>
<span class="fc" id="L637">        assertEquals(true, map.removeMapping(&quot;A&quot;, &quot;AB&quot;));</span>
<span class="fc" id="L638">        assertEquals(true, map.removeMapping(&quot;A&quot;, &quot;AA&quot;));</span>
        //assertEquals(new MultiValuedHashMap&lt;K, V&gt;(), map);
<span class="fc" id="L640">    }</span>

    public void testKeysMultiSet() {
<span class="fc" id="L643">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L644">        final MultiSet&lt;K&gt; keyMultiSet = map.keys();</span>
<span class="fc" id="L645">        assertEquals(2, keyMultiSet.getCount(&quot;one&quot;));</span>
<span class="fc" id="L646">        assertEquals(2, keyMultiSet.getCount(&quot;two&quot;));</span>
<span class="fc" id="L647">        assertEquals(2, keyMultiSet.getCount(&quot;three&quot;));</span>
<span class="fc" id="L648">        assertEquals(6, keyMultiSet.size());</span>
<span class="fc" id="L649">    }</span>

    public void testKeysBagIterator() {
<span class="fc" id="L652">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L653">        final Collection&lt;K&gt; col = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L654">        final Iterator&lt;K&gt; it = map.keys().iterator();</span>
<span class="fc bfc" id="L655" title="All 2 branches covered.">        while (it.hasNext()) {</span>
<span class="fc" id="L656">            col.add(it.next());</span>
        }
<span class="fc" id="L658">        final Bag&lt;K&gt; bag = new HashBag&lt;&gt;(col);</span>
<span class="fc" id="L659">        assertEquals(2, bag.getCount(&quot;one&quot;));</span>
<span class="fc" id="L660">        assertEquals(2, bag.getCount(&quot;two&quot;));</span>
<span class="fc" id="L661">        assertEquals(2, bag.getCount(&quot;three&quot;));</span>
<span class="fc" id="L662">        assertEquals(6, bag.size());</span>
<span class="fc" id="L663">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testKeysBagContainsAll() {
<span class="fc" id="L667">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L668">        final MultiSet&lt;K&gt; keyMultiSet = map.keys();</span>
<span class="fc" id="L669">        final Collection&lt;K&gt; col = (Collection&lt;K&gt;) Arrays.asList(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;one&quot;, &quot;two&quot;, &quot;three&quot;);</span>
<span class="fc" id="L670">        assertTrue(keyMultiSet.containsAll(col));</span>
<span class="fc" id="L671">    }</span>

    public void testAsMapGet() {
<span class="fc" id="L674">        resetEmpty();</span>
<span class="fc" id="L675">        Map&lt;K, Collection&lt;V&gt;&gt; mapCol = getMap().asMap();</span>
<span class="fc" id="L676">        assertNull(mapCol.get(&quot;one&quot;));</span>
<span class="fc" id="L677">        assertEquals(0, mapCol.size());</span>

<span class="fc" id="L679">        resetFull();</span>
<span class="fc" id="L680">        mapCol = getMap().asMap();</span>
<span class="fc" id="L681">        final Collection&lt;V&gt; col = mapCol.get(&quot;one&quot;);</span>
<span class="fc" id="L682">        assertNotNull(col);</span>
<span class="fc" id="L683">        assertTrue(col.contains(&quot;un&quot;));</span>
<span class="fc" id="L684">        assertTrue(col.contains(&quot;uno&quot;));</span>
<span class="fc" id="L685">    }</span>

    public void testAsMapRemove() {
<span class="fc bfc" id="L688" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L689">            return;</span>
        }
<span class="fc" id="L691">        resetFull();</span>
<span class="fc" id="L692">        final Map&lt;K, Collection&lt;V&gt;&gt; mapCol = getMap().asMap();</span>
<span class="fc" id="L693">        mapCol.remove(&quot;one&quot;);</span>
<span class="fc" id="L694">        assertFalse(getMap().containsKey(&quot;one&quot;));</span>
<span class="fc" id="L695">        assertEquals(4, getMap().size());</span>
<span class="fc" id="L696">    }</span>

    public void testMapIterator() {
<span class="fc" id="L699">        resetEmpty();</span>
<span class="fc" id="L700">        MapIterator&lt;K, V&gt; mapIt  = getMap().mapIterator();</span>
<span class="fc" id="L701">        assertFalse(mapIt.hasNext());</span>

<span class="fc" id="L703">        resetFull();</span>
<span class="fc" id="L704">        mapIt = getMap().mapIterator();</span>
<span class="fc bfc" id="L705" title="All 2 branches covered.">        while (mapIt.hasNext()) {</span>
<span class="fc" id="L706">            final K key = mapIt.next();</span>
<span class="fc" id="L707">            final V value = mapIt.getValue();</span>
<span class="fc" id="L708">            assertTrue(getMap().containsMapping(key, value));</span>
<span class="fc" id="L709">        }</span>
<span class="fc" id="L710">    }</span>

    public void testMapIteratorRemove() {
<span class="fc bfc" id="L713" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L714">            return;</span>
        }
<span class="fc" id="L716">        resetFull();</span>
<span class="fc" id="L717">        final MapIterator&lt;K, V&gt; mapIt = getMap().mapIterator();</span>
<span class="fc bfc" id="L718" title="All 2 branches covered.">        while (mapIt.hasNext()) {</span>
<span class="fc" id="L719">            mapIt.next();</span>
<span class="fc" id="L720">            mapIt.remove();</span>
        }
<span class="fc" id="L722">        assertTrue(getMap().isEmpty());</span>
<span class="fc" id="L723">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testMapIteratorUnsupportedSet() {
<span class="fc" id="L727">        resetFull();</span>
<span class="fc" id="L728">        final MapIterator&lt;K, V&gt; mapIt = getMap().mapIterator();</span>
<span class="fc" id="L729">        mapIt.next();</span>
        try {
<span class="nc" id="L731">            mapIt.setValue((V) &quot;some value&quot;);</span>
<span class="nc" id="L732">            fail();</span>
<span class="fc" id="L733">        } catch (final UnsupportedOperationException e) {</span>
<span class="nc" id="L734">        }</span>
<span class="fc" id="L735">    }</span>

    // -----------------------------------------------------------------------
    // Manual serialization testing as this class cannot easily
    // extend the AbstractTestMap
    // -----------------------------------------------------------------------

    public void testEmptyMapCompatibility() throws Exception {
<span class="fc" id="L743">        final MultiValuedMap&lt;?, ?&gt; map = makeObject();</span>
<span class="fc" id="L744">        final MultiValuedMap&lt;?, ?&gt; map2 =</span>
<span class="fc" id="L745">                (MultiValuedMap&lt;?, ?&gt;) readExternalFormFromDisk(getCanonicalEmptyCollectionName(map));</span>
<span class="fc" id="L746">        assertEquals(&quot;Map is empty&quot;, 0, map2.size());</span>
<span class="fc" id="L747">    }</span>

    @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
    public void testFullMapCompatibility() throws Exception {
<span class="fc" id="L751">        final MultiValuedMap map = makeFullMap();</span>
<span class="fc" id="L752">        final MultiValuedMap map2 =</span>
<span class="fc" id="L753">                (MultiValuedMap) readExternalFormFromDisk(getCanonicalFullCollectionName(map));</span>
<span class="fc" id="L754">        assertEquals(&quot;Map is the right size&quot;, map.size(), map2.size());</span>
<span class="fc bfc" id="L755" title="All 2 branches covered.">        for (final Object key : map.keySet()) {</span>
<span class="fc" id="L756">            assertTrue(&quot;Map had inequal elements&quot;,</span>
<span class="fc" id="L757">                       CollectionUtils.isEqualCollection(map.get(key), map2.get(key)));</span>
<span class="fc bfc" id="L758" title="All 2 branches covered.">            if (isRemoveSupported()) {</span>
<span class="fc" id="L759">                map2.remove(key);</span>
            }
<span class="fc" id="L761">        }</span>
<span class="fc bfc" id="L762" title="All 2 branches covered.">        if (isRemoveSupported()) {</span>
<span class="fc" id="L763">            assertEquals(&quot;Map had extra values&quot;, 0, map2.size());</span>
        }
<span class="fc" id="L765">    }</span>

    // Bulk Tests
    /**
     * Bulk test {@link MultiValuedMap#entries()}. This method runs through all
     * of the tests in {@link AbstractCollectionTest}. After modification
     * operations, {@link #verify()} is invoked to ensure that the map and the
     * other collection views are still valid.
     *
     * @return a {@link AbstractCollectionTest} instance for testing the map's
     *         values collection
     */
    public BulkTest bulkTestMultiValuedMapEntries() {
<span class="fc" id="L778">        return new TestMultiValuedMapEntries();</span>
    }

    public class TestMultiValuedMapEntries extends AbstractCollectionTest&lt;Entry&lt;K, V&gt;&gt; {
<span class="fc" id="L782">        public TestMultiValuedMapEntries() {</span>
<span class="fc" id="L783">            super(&quot;&quot;);</span>
<span class="fc" id="L784">        }</span>

        @SuppressWarnings(&quot;unchecked&quot;)
        @Override
        public Entry&lt;K, V&gt;[] getFullElements() {
<span class="fc" id="L789">            return makeFullMap().entries().toArray(new Entry[0]);</span>
        }

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeObject() {
<span class="fc" id="L794">            return AbstractMultiValuedMapTest.this.makeObject().entries();</span>
        }

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeFullCollection() {
<span class="fc" id="L799">            return AbstractMultiValuedMapTest.this.makeFullMap().entries();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L804">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
            // Add not supported in entries view
<span class="fc" id="L810">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L815">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L820">            return false;</span>
        }

        @Override
        public void resetFull() {
<span class="fc" id="L825">            AbstractMultiValuedMapTest.this.resetFull();</span>
<span class="fc" id="L826">            setCollection(AbstractMultiValuedMapTest.this.getMap().entries());</span>
<span class="fc" id="L827">            TestMultiValuedMapEntries.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().entries());</span>
<span class="fc" id="L828">        }</span>

        @Override
        public void resetEmpty() {
<span class="fc" id="L832">            AbstractMultiValuedMapTest.this.resetEmpty();</span>
<span class="fc" id="L833">            setCollection(AbstractMultiValuedMapTest.this.getMap().entries());</span>
<span class="fc" id="L834">            TestMultiValuedMapEntries.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().entries());</span>
<span class="fc" id="L835">        }</span>

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeConfirmedCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L840">            return null;</span>
        }

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeConfirmedFullCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L846">            return null;</span>
        }

    }

    /**
     * Bulk test {@link MultiValuedMap#keySet()}. This method runs through all
     * of the tests in {@link AbstractSetTest}. After modification operations,
     * {@link #verify()} is invoked to ensure that the map and the other
     * collection views are still valid.
     *
     * @return a {@link AbstractSetTest} instance for testing the map's key set
     */
    public BulkTest bulkTestMultiValuedMapKeySet() {
<span class="fc" id="L860">        return new TestMultiValuedMapKeySet();</span>
    }

    public class TestMultiValuedMapKeySet extends AbstractSetTest&lt;K&gt; {
<span class="fc" id="L864">        public TestMultiValuedMapKeySet() {</span>
<span class="fc" id="L865">            super(&quot;&quot;);</span>
<span class="fc" id="L866">        }</span>

        @SuppressWarnings(&quot;unchecked&quot;)
        @Override
        public K[] getFullElements() {
<span class="fc" id="L871">            return (K[]) AbstractMultiValuedMapTest.this.makeFullMap().keySet().toArray();</span>
        }

        @Override
        public Set&lt;K&gt; makeObject() {
<span class="fc" id="L876">            return AbstractMultiValuedMapTest.this.makeObject().keySet();</span>
        }

        @Override
        public Set&lt;K&gt; makeFullCollection() {
<span class="fc" id="L881">            return AbstractMultiValuedMapTest.this.makeFullMap().keySet();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L886">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
<span class="fc" id="L891">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L896">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L901">            return false;</span>
        }

    }

    /**
     * Bulk test {@link MultiValuedMap#values()}. This method runs through all
     * of the tests in {@link AbstractCollectionTest}. After modification
     * operations, {@link #verify()} is invoked to ensure that the map and the
     * other collection views are still valid.
     *
     * @return a {@link AbstractCollectionTest} instance for testing the map's
     *         values collection
     */
    public BulkTest bulkTestMultiValuedMapValues() {
<span class="fc" id="L916">        return new TestMultiValuedMapValues();</span>
    }

    public class TestMultiValuedMapValues extends AbstractCollectionTest&lt;V&gt; {
<span class="fc" id="L920">        public TestMultiValuedMapValues() {</span>
<span class="fc" id="L921">            super(&quot;&quot;);</span>
<span class="fc" id="L922">        }</span>

        @Override
        public V[] getFullElements() {
<span class="fc" id="L926">            return getSampleValues();</span>
        }

        @Override
        public Collection&lt;V&gt; makeObject() {
<span class="fc" id="L931">            return AbstractMultiValuedMapTest.this.makeObject().values();</span>
        }

        @Override
        public Collection&lt;V&gt; makeFullCollection() {
<span class="fc" id="L936">            return AbstractMultiValuedMapTest.this.makeFullMap().values();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L941">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
<span class="fc" id="L946">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L951">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L956">            return false;</span>
        }

        @Override
        public void resetFull() {
<span class="fc" id="L961">            AbstractMultiValuedMapTest.this.resetFull();</span>
<span class="fc" id="L962">            setCollection(AbstractMultiValuedMapTest.this.getMap().values());</span>
<span class="fc" id="L963">            TestMultiValuedMapValues.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().values());</span>
<span class="fc" id="L964">        }</span>

        @Override
        public void resetEmpty() {
<span class="fc" id="L968">            AbstractMultiValuedMapTest.this.resetEmpty();</span>
<span class="fc" id="L969">            setCollection(AbstractMultiValuedMapTest.this.getMap().values());</span>
<span class="fc" id="L970">            TestMultiValuedMapValues.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().values());</span>
<span class="fc" id="L971">        }</span>

        @Override
        public Collection&lt;V&gt; makeConfirmedCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L976">            return null;</span>
        }

        @Override
        public Collection&lt;V&gt; makeConfirmedFullCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L982">            return null;</span>
        }

    }

    /**
     * Bulk test {@link MultiValuedMap#keys()}. This method runs through all of
     * the tests in {@link AbstractBagTest}. After modification operations,
     * {@link #verify()} is invoked to ensure that the map and the other
     * collection views are still valid.
     *
     * @return a {@link AbstractBagTest} instance for testing the map's values
     *         collection
     */
    public BulkTest bulkTestMultiValuedMapKeys() {
<span class="fc" id="L997">        return new TestMultiValuedMapKeys();</span>
    }

    public class TestMultiValuedMapKeys extends AbstractMultiSetTest&lt;K&gt; {

<span class="fc" id="L1002">        public TestMultiValuedMapKeys() {</span>
<span class="fc" id="L1003">            super(&quot;&quot;);</span>
<span class="fc" id="L1004">        }</span>

        @Override
        public K[] getFullElements() {
<span class="fc" id="L1008">            return getSampleKeys();</span>
        }

        @Override
        public MultiSet&lt;K&gt; makeObject() {
<span class="fc" id="L1013">            return AbstractMultiValuedMapTest.this.makeObject().keys();</span>
        }

        @Override
        public MultiSet&lt;K&gt; makeFullCollection() {
<span class="fc" id="L1018">            return AbstractMultiValuedMapTest.this.makeFullMap().keys();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L1023">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
<span class="fc" id="L1028">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L1033">            return false;</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L1038">            return false;</span>
        }

        @Override
        public void resetFull() {
<span class="fc" id="L1043">            AbstractMultiValuedMapTest.this.resetFull();</span>
<span class="fc" id="L1044">            setCollection(AbstractMultiValuedMapTest.this.getMap().keys());</span>
<span class="fc" id="L1045">            TestMultiValuedMapKeys.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().keys());</span>
<span class="fc" id="L1046">        }</span>

        @Override
        public void resetEmpty() {
<span class="fc" id="L1050">            AbstractMultiValuedMapTest.this.resetEmpty();</span>
<span class="fc" id="L1051">            setCollection(AbstractMultiValuedMapTest.this.getMap().keys());</span>
<span class="fc" id="L1052">            TestMultiValuedMapKeys.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().keys());</span>
<span class="fc" id="L1053">        }</span>

    }

    public BulkTest bulkTestAsMap() {
<span class="fc" id="L1058">        return new TestMultiValuedMapAsMap();</span>
    }

    public class TestMultiValuedMapAsMap extends AbstractMapTest&lt;K, Collection&lt;V&gt;&gt; {

<span class="fc" id="L1063">        public TestMultiValuedMapAsMap() {</span>
<span class="fc" id="L1064">            super(&quot;&quot;);</span>
<span class="fc" id="L1065">        }</span>

        @Override
        public Map&lt;K, Collection&lt;V&gt;&gt; makeObject() {
<span class="fc" id="L1069">            return AbstractMultiValuedMapTest.this.makeObject().asMap();</span>
        }

        @Override
        public Map&lt;K, Collection&lt;V&gt;&gt; makeFullMap() {
<span class="fc" id="L1074">            return AbstractMultiValuedMapTest.this.makeFullMap().asMap();</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public K[] getSampleKeys() {
<span class="fc" id="L1080">            final K[] samplekeys = AbstractMultiValuedMapTest.this.getSampleKeys();</span>
<span class="fc" id="L1081">            final Object[] finalKeys = new Object[3];</span>
<span class="fc bfc" id="L1082" title="All 2 branches covered.">            for (int i = 0; i &lt; 3; i++) {</span>
<span class="fc" id="L1083">                finalKeys[i] = samplekeys[i * 2];</span>
            }
<span class="fc" id="L1085">            return (K[]) finalKeys;</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public Collection&lt;V&gt;[] getSampleValues() {
            // Calling getMap() instead of makeObject() would make more sense, but due to concurrency
            // issues, this may lead to intermittent issues. See COLLECTIONS-661. A better solution
            // would be to re-design the tests, or add a boolean method to the parent.
<span class="fc" id="L1094">            final boolean isSetValuedMap = AbstractMultiValuedMapTest.this.makeObject() instanceof SetValuedMap;</span>
<span class="fc" id="L1095">            final V[] sampleValues = AbstractMultiValuedMapTest.this.getSampleValues();</span>
<span class="fc" id="L1096">            final Collection&lt;V&gt;[] colArr = new Collection[3];</span>
<span class="fc bfc" id="L1097" title="All 2 branches covered.">            for(int i = 0; i &lt; 3; i++) {</span>
<span class="fc" id="L1098">                final Collection&lt;V&gt; coll = Arrays.asList(sampleValues[i*2], sampleValues[i*2 + 1]);</span>
<span class="fc bfc" id="L1099" title="All 2 branches covered.">                colArr[i] = isSetValuedMap ? new HashSet&lt;&gt;(coll) : coll;</span>
            }
<span class="fc" id="L1101">            return colArr;</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public Collection&lt;V&gt;[] getNewSampleValues() {
            // See comment in getSampleValues() to understand why we are calling makeObject() and not
            // getMap(). See COLLECTIONS-661 for more.
<span class="fc" id="L1109">            final boolean isSetValuedMap = AbstractMultiValuedMapTest.this.makeObject() instanceof SetValuedMap;</span>
<span class="fc" id="L1110">            final Object[] sampleValues = { &quot;ein&quot;, &quot;ek&quot;, &quot;zwei&quot;, &quot;duey&quot;, &quot;drei&quot;, &quot;teen&quot; };</span>
<span class="fc" id="L1111">            final Collection&lt;V&gt;[] colArr = new Collection[3];</span>
<span class="fc bfc" id="L1112" title="All 2 branches covered.">            for (int i = 0; i &lt; 3; i++) {</span>
<span class="fc" id="L1113">                final Collection&lt;V&gt; coll = Arrays.asList((V) sampleValues[i * 2], (V) sampleValues[i * 2 + 1]);</span>
<span class="fc bfc" id="L1114" title="All 2 branches covered.">                colArr[i] = isSetValuedMap ? new HashSet&lt;&gt;(coll) : coll;</span>
            }
<span class="fc" id="L1116">            return colArr;</span>
        }

        @Override
        public boolean isAllowNullKey() {
<span class="nc" id="L1121">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isPutAddSupported() {
<span class="fc" id="L1126">            return false;</span>
        }

        @Override
        public boolean isPutChangeSupported() {
<span class="fc" id="L1131">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L1136">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }

        @Override
        public boolean areEqualElementsDistinguishable() {
            // work-around for a problem with the EntrySet: the entries contain
            // the wrapped collection, which will be automatically cleared
            // when the associated key is removed from the map as the collection
            // is not cached atm.
<span class="fc" id="L1145">            return true;</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L1150">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>